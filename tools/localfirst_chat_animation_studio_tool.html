<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Animation Studio - All-in-One</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .studio-container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* Header */
        .studio-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .studio-header h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .studio-header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 4px;
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            padding: 24px 32px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }

        .step {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .step.completed {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .step.active .step-number {
            background: rgba(255, 255, 255, 0.3);
        }

        .step.completed .step-number {
            background: #4caf50;
            color: white;
        }

        .step-info {
            flex: 1;
        }

        .step-title {
            font-weight: 600;
            font-size: 14px;
        }

        .step-desc {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 2px;
        }

        /* Main Content */
        .studio-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            min-height: calc(100vh - 240px);
        }

        /* Sidebar */
        .studio-sidebar {
            background: #fafafa;
            padding: 24px;
            border-right: 2px solid #e0e0e0;
            overflow-y: auto;
        }

        .section {
            margin-bottom: 24px;
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            color: #555;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group textarea {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area.loaded {
            border-color: #4caf50;
            background: #e8f5e9;
        }

        /* Preview Area */
        .studio-preview {
            background: #fff;
            padding: 24px;
            overflow-y: auto;
            position: relative;
        }

        .preview-container {
            width: 100%;
            height: 100%;
            background: #f5f5f5;
            border-radius: 8px;
            position: relative;
            min-height: 600px;
        }

        .message-item {
            display: flex;
            margin: 16px 0;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-item.agent {
            justify-content: flex-start;
        }

        .message-item.customer {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
        }

        .message-bubble.agent {
            background: #f0f0f0;
            color: #000;
        }

        .message-bubble.customer {
            background: #667eea;
            color: white;
        }

        .message-list {
            padding: 16px;
        }

        .message-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .message-list-item:hover {
            border-color: #667eea;
        }

        .message-list-item .type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .message-list-item .type-badge.agent {
            background: #e3f2fd;
            color: #1976d2;
        }

        .message-list-item .type-badge.customer {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .message-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #f5f5f5;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            background: #667eea;
            color: white;
        }

        /* Animation Controls */
        .animation-controls {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .animation-controls.active {
            display: block;
        }

        .control-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .frame-counter {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
        }

        .speed-slider {
            width: 100%;
            margin-top: 8px;
        }

        /* Style Designer */
        .style-preview {
            padding: 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 12px;
        }

        .style-property {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }

        .style-property label {
            font-size: 12px;
            font-weight: 500;
            color: #666;
        }

        .style-property input[type="color"] {
            width: 60px;
            height: 32px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
        }

        .style-property input[type="range"] {
            width: 100%;
        }

        /* Background overlay */
        .background-preview {
            width: 100%;
            height: 100%;
            position: relative;
            background: #f5f5f5;
        }

        .chat-overlay {
            position: absolute;
            background: white;
            border: 3px dashed #667eea;
            border-radius: 8px;
            padding: 16px;
            cursor: move;
            min-width: 300px;
            min-height: 200px;
        }

        .overlay-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #667eea;
            border: 2px solid white;
            border-radius: 50%;
            bottom: -10px;
            right: -10px;
            cursor: nwse-resize;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .success-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 12px;
            border-radius: 4px;
            font-size: 13px;
            margin-top: 12px;
        }

        .nav-buttons {
            display: flex;
            gap: 12px;
            padding: 24px;
            background: #fafafa;
            border-top: 2px solid #e0e0e0;
        }

        .nav-buttons button {
            flex: 1;
        }

        /* Style Capture Modal */
        .capture-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999999;
        }

        .capture-modal.active {
            display: flex;
        }

        .capture-modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .capture-modal h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .captured-style-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .captured-style-item strong {
            color: #667eea;
        }

        .capture-preview {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .apply-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        /* Video Container for Presenter Mode */
        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            display: none;
            align-items: center;
            justify-content: center;
            background: #000;
            padding: 20px;
            z-index: 10000;
        }

        .video-container.presenter-mode {
            display: flex;
        }

        /* Screen Recording Frame */
        .screen-frame {
            width: 100%;
            max-width: 1400px;
            height: calc(100vh - 140px);
            max-height: 900px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Admin Button */
        .admin-button {
            position: absolute;
            left: 20px;
            top: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            z-index: 10001;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .admin-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Step Indicator for Presenter Mode */
        .step-indicator-presenter {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            z-index: 10001;
            font-weight: 600;
            transition: opacity 0.3s ease;
        }

        .step-indicator-presenter.hidden {
            display: none;
        }

        /* Hide elements in presenter mode */
        body.presenter-mode {
            overflow: hidden;
        }

        body.presenter-mode .studio-container {
            height: 100vh;
            max-width: none;
            border-radius: 0;
            margin: 0;
        }

        body.presenter-mode .studio-header .subtitle {
            display: none;
        }

        /* Adjust studio container when in presenter mode frame */
        .video-container .studio-container {
            max-width: none;
            width: 100%;
            height: 100%;
            border-radius: 0;
            box-shadow: none;
        }

        .video-container .screen-frame .studio-container {
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="studio-container">
        <!-- Header -->
        <div class="studio-header">
            <div>
                <h1>🎬 Chat Animation Studio</h1>
                <div class="subtitle">Design → Compose → Animate → Export - All in One Place</div>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="clearAll()" style="width: auto; padding: 12px 24px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3);">
                    🗑️ Clear All
                </button>
                <button class="btn btn-secondary" onclick="togglePresenterMode()" style="width: auto; padding: 12px 24px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3);">
                    📹 Presenter Mode
                </button>
                <button class="btn btn-success" onclick="exportAnimation()" style="width: auto; padding: 12px 24px;">
                    📥 Export Frames
                </button>
                <button class="btn btn-success" onclick="exportStandaloneAnimation()" style="width: auto; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                    🎬 Export Standalone
                </button>
            </div>
        </div>

        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step completed" data-step="1" onclick="goToStep(1)">
                <div class="step-number">1</div>
                <div class="step-info">
                    <div class="step-title">Background</div>
                    <div class="step-desc">Upload base HTML (optional)</div>
                </div>
            </div>
            <div class="step completed" data-step="2" onclick="goToStep(2)">
                <div class="step-number">2</div>
                <div class="step-info">
                    <div class="step-title">Message Styles</div>
                    <div class="step-desc">Design agent &amp; customer bubbles</div>
                </div>
            </div>
            <div class="step completed" data-step="3" onclick="goToStep(3)">
                <div class="step-info">
                    <div class="step-number">3</div>
                    <div class="step-title">Conversation</div>
                    <div class="step-desc">Add messages</div>
                </div>
            </div>
            <div class="step completed" data-step="4" onclick="goToStep(4)">
                <div class="step-number">4</div>
                <div class="step-info">
                    <div class="step-title">Positioning</div>
                    <div class="step-desc">Position overlay</div>
                </div>
            </div>
            <div class="step completed" data-step="5" onclick="goToStep(5)">
                <div class="step-number">5</div>
                <div class="step-info">
                    <div class="step-title">Preview</div>
                    <div class="step-desc">Watch animation</div>
                </div>
            </div>
            <div class="step active" data-step="6" onclick="goToStep(6)">
                <div class="step-number">6</div>
                <div class="step-info">
                    <div class="step-title">Export &amp; Save</div>
                    <div class="step-desc">Export frames or save project</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="studio-content">
            <!-- Sidebar -->
            <div class="studio-sidebar">
                <!-- Step 1: Background -->
                <div class="section" data-section="1">
                    <div class="section-title">📁 Upload Background</div>
                    <div class="info-box">
                        Upload the HTML page where you want the chat to appear (e.g., M365 Copilot interface). Leave blank for a simple background.
                    </div>
                    <div class="upload-area loaded" id="backgroundUpload" onclick="document.getElementById('backgroundInput').click()">
                        <div style="font-size: 48px; margin-bottom: 12px;">📄</div>
                        <div style="font-weight: 600; margin-bottom: 8px;">Click to Upload Background HTML</div>
                        <div style="font-size: 12px; color: #888;">Or drag and drop here</div>
                    </div>
                    <input type="file" id="backgroundInput" accept=".html" style="display: none;" onchange="loadBackground(event)">
                    <div id="backgroundStatus" style="margin-top: 12px; font-size: 13px; color: #888;"><span style="color: #4caf50;">✓ Loaded: snapshot-1760370929454.html (interactive elements removed for clean display)</span></div>
                </div>

                <!-- Step 2: Message Styles -->
                <div class="section" data-section="2">
                    <div class="section-title">🎨 Design Message Styles</div>

                    <div class="info-box">
                        Design message styles or import from a saved configuration.
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                        <button class="btn btn-secondary" onclick="document.getElementById('styleImportInput').click()" style="font-size: 12px;">
                            📥 Import Styles
                        </button>
                        <button class="btn btn-secondary" onclick="exportStyles()" style="font-size: 12px;">
                            📤 Export Styles
                        </button>
                    </div>
                    <input type="file" id="styleImportInput" accept=".json" style="display: none;" onchange="importStyles(event)">

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="enableStyleCapture()" id="styleCaptureBtn" style="font-size: 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            🎨 Capture Styles
                        </button>
                        <button class="btn btn-primary" onclick="enableTemplateCapture()" id="templateCaptureBtn" style="font-size: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            📦 Capture Template
                        </button>
                    </div>
                    <div id="styleCaptureHint" style="display: none; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; font-size: 12px; margin-bottom: 16px;">
                        <strong>Style Capture Mode Active</strong><br>
                        Click any text element in the background preview to capture its styles.
                    </div>
                    <div id="templateCaptureHint" style="display: none; padding: 12px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px; font-size: 12px; margin-bottom: 16px;">
                        <strong>Template Capture Mode Active</strong><br>
                        Click on a complete message bubble to capture its entire HTML structure.
                    </div>

                    <h4 style="font-size: 14px; margin-bottom: 12px; color: #764ba2;">Agent Message</h4>

                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                        <strong style="font-size: 12px; color: #666; display: block; margin-bottom: 8px;">Message Components</strong>
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="agentShowAvatar" checked onchange="updateStylePreview()" style="margin-right: 8px;">
                            <span style="font-size: 13px;">Show Avatar/Icon</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="agentShowTitle" checked onchange="updateStylePreview()" style="margin-right: 8px;">
                            <span style="font-size: 13px;">Show Agent Name/Title</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="agentShowActions" checked onchange="updateStylePreview()" style="margin-right: 8px;">
                            <span style="font-size: 13px;">Show Action Buttons</span>
                        </label>
                    </div>

                    <div class="style-property">
                        <label>Background</label>
                        <input type="color" id="agentBg" value="#ffffff" onchange="updateStylePreview()">
                    </div>
                    <div class="style-property">
                        <label>Text Color</label>
                        <input type="color" id="agentColor" value="#242424" onchange="updateStylePreview()">
                    </div>
                    <div class="style-property">
                        <label>Border Radius</label>
                        <input type="range" id="agentRadius" min="0" max="30" value="8" onchange="updateStylePreview()">
                        <span id="agentRadiusVal">8px</span>
                    </div>
                    <div class="style-property">
                        <label>Padding</label>
                        <input type="range" id="agentPadding" min="8" max="30" value="16" onchange="updateStylePreview()">
                        <span id="agentPaddingVal">16px</span>
                    </div>

                    <h4 style="font-size: 14px; margin: 20px 0 12px; color: #764ba2;">Customer Message</h4>

                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                        <strong style="font-size: 12px; color: #666; display: block; margin-bottom: 8px;">Message Components</strong>
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="customerShowAvatar" onchange="updateStylePreview()" style="margin-right: 8px;">
                            <span style="font-size: 13px;">Show Avatar/Icon</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="customerShowTitle" onchange="updateStylePreview()" style="margin-right: 8px;">
                            <span style="font-size: 13px;">Show Customer Name/Title</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="customerShowActions" onchange="updateStylePreview()" style="margin-right: 8px;">
                            <span style="font-size: 13px;">Show Action Buttons</span>
                        </label>
                    </div>

                    <div class="style-property">
                        <label>Background</label>
                        <input type="color" id="customerBg" value="#f3f2f1" onchange="updateStylePreview()">
                    </div>
                    <div class="style-property">
                        <label>Text Color</label>
                        <input type="color" id="customerColor" value="#242424" onchange="updateStylePreview()">
                    </div>
                    <div class="style-property">
                        <label>Border Radius</label>
                        <input type="range" id="customerRadius" min="0" max="30" value="8" onchange="updateStylePreview()">
                        <span id="customerRadiusVal">8px</span>
                    </div>
                    <div class="style-property">
                        <label>Padding</label>
                        <input type="range" id="customerPadding" min="8" max="30" value="16" onchange="updateStylePreview()">
                        <span id="customerPaddingVal">16px</span>
                    </div>

                    <div class="style-preview" id="stylePreview">
                        <div style="margin-bottom: 12px;">
                            <div class="message-bubble agent" id="agentPreview" style="background-color: rgb(240, 240, 240); color: rgb(0, 0, 0); border-radius: 12px; padding: 12px 16px;">Agent message preview</div>
                        </div>
                        <div style="display: flex; justify-content: flex-end;">
                            <div class="message-bubble customer" id="customerPreview" style="background-color: rgb(102, 126, 234); color: rgb(255, 255, 255); border-radius: 12px; padding: 12px 16px;">Customer message preview</div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Conversation -->
                <div class="section" data-section="3">
                    <div class="section-title">💬 Build Conversation</div>

                    <div class="info-box">
                        <strong>Quick Start:</strong> Import a conversation JSON or add messages manually below.
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px;">
                        <button class="btn btn-secondary" onclick="document.getElementById('conversationInput').click()">
                            📥 Import JSON (Multiple)
                        </button>
                        <button class="btn btn-secondary" onclick="exportConversationJSON()">
                            📤 Export JSON
                        </button>
                    </div>
                    <input type="file" id="conversationInput" accept=".json" multiple style="display: none;" onchange="importConversationJSON(event)">

                    <div id="conversationSelectorContainer" style="display: none; margin-bottom: 16px;">
                        <div class="input-group">
                            <label>📚 Loaded Conversations (<span id="loadedCount">0</span>)</label>
                            <select id="conversationSelector" onchange="switchConversation(this.value)" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                                <option value="-1">Select a conversation...</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary" onclick="clearAllConversations()" style="font-size: 12px; margin-top: 8px;">
                            🗑️ Clear All Loaded Conversations
                        </button>
                    </div>

                    <div class="input-group">
                        <label>Message Type</label>
                        <select id="messageType">
                            <option value="agent">Agent</option>
                            <option value="customer">Customer</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Message Text</label>
                        <textarea id="messageText" placeholder="Enter message content..."></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="addMessage()">➕ Add Message</button>

                    <div style="margin-top: 20px;">
                        <h4 style="font-size: 14px; margin-bottom: 12px; color: #764ba2;">Messages (<span id="messageCount">8</span>)</h4>
                        <div class="message-list" id="messageList">
                <div class="message-list-item">
                    <div>
                        <span class="type-badge customer">customer</span>
                        <div style="margin-top: 6px; font-size: 13px; color: #666;">Consolidate all assets for the Henderson family an...</div>
                    </div>
                    <div class="message-actions">
                        <button class="icon-btn" onclick="removeMessage(0)" title="Delete">🗑️</button>
                    </div>
                </div>

                <div class="message-list-item">
                    <div>
                        <span class="type-badge agent">agent</span>
                        <div style="margin-top: 6px; font-size: 13px; color: #666;">Consolidating customer assets across all accounts ...</div>
                    </div>
                    <div class="message-actions">
                        <button class="icon-btn" onclick="removeMessage(1)" title="Delete">🗑️</button>
                    </div>
                </div>

                <div class="message-list-item">
                    <div>
                        <span class="type-badge customer">customer</span>
                        <div style="margin-top: 6px; font-size: 13px; color: #666;">What specific financial products should I recommen...</div>
                    </div>
                    <div class="message-actions">
                        <button class="icon-btn" onclick="removeMessage(2)" title="Delete">🗑️</button>
                    </div>
                </div>

                <div class="message-list-item">
                    <div>
                        <span class="type-badge agent">agent</span>
                        <div style="margin-top: 6px; font-size: 13px; color: #666;">Analyzing portfolio gaps and generating targeted p...</div>
                    </div>
                    <div class="message-actions">
                        <button class="icon-btn" onclick="removeMessage(3)" title="Delete">🗑️</button>
                    </div>
                </div>

                <div class="message-list-item">
                    <div>
                        <span class="type-badge customer">customer</span>
                        <div style="margin-top: 6px; font-size: 13px; color: #666;">Generate natural language summaries I can use to e...</div>
                    </div>
                    <div class="message-actions">
                        <button class="icon-btn" onclick="removeMessage(4)" title="Delete">🗑️</button>
                    </div>
                </div>

                <div class="message-list-item">
                    <div>
                        <span class="type-badge agent">agent</span>
                        <div style="margin-top: 6px; font-size: 13px; color: #666;">Creating clear, natural language summaries to faci...</div>
                    </div>
                    <div class="message-actions">
                        <button class="icon-btn" onclick="removeMessage(5)" title="Delete">🗑️</button>
                    </div>
                </div>

                <div class="message-list-item">
                    <div>
                        <span class="type-badge customer">customer</span>
                        <div style="margin-top: 6px; font-size: 13px; color: #666;">How will implementing these recommendations help m...</div>
                    </div>
                    <div class="message-actions">
                        <button class="icon-btn" onclick="removeMessage(6)" title="Delete">🗑️</button>
                    </div>
                </div>

                <div class="message-list-item">
                    <div>
                        <span class="type-badge agent">agent</span>
                        <div style="margin-top: 6px; font-size: 13px; color: #666;">Analyzing impact on organizational C-Suite objecti...</div>
                    </div>
                    <div class="message-actions">
                        <button class="icon-btn" onclick="removeMessage(7)" title="Delete">🗑️</button>
                    </div>
                </div>
            </div>
                    </div>
                </div>

                <!-- Step 4: Positioning -->
                <div class="section" data-section="4">
                    <div class="section-title">📐 Position Overlay</div>

                    <div class="info-box">
                        Drag the chat overlay to position it on your background. Resize using the handle in the bottom-right corner.
                    </div>

                    <div class="input-group">
                        <label>Overlay Background</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="color" id="overlayBg" value="#ffffff" onchange="updateOverlayStyle()" style="flex: 0 0 60px;">
                            <button class="btn btn-secondary" onclick="toggleColorPicker()" id="colorPickerBtn" style="flex: 1 1 0%; padding: 8px 12px; font-size: 13px;">🎨 Pick Color from Background</button>
                        </div>
                        <div id="colorPickerHint" style="display: none; margin-top: 8px; padding: 8px; background: rgb(255, 243, 205); border-left: 3px solid rgb(255, 193, 7); font-size: 12px; border-radius: 4px;">
                            Click anywhere on the background to sample its color
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Overlay Opacity</label>
                        <input type="range" id="overlayOpacity" min="0" max="100" value="100" onchange="updateOverlayStyle()">
                        <span id="overlayOpacityVal">100%</span>
                    </div>

                    <div class="input-group">
                        <label>Border Radius</label>
                        <input type="range" id="overlayRadius" min="0" max="30" value="8" onchange="updateOverlayStyle()">
                        <span id="overlayRadiusVal">8px</span>
                    </div>

                    <button class="btn btn-secondary" onclick="resetOverlayPosition()">🔄 Reset Position</button>
                </div>

                <!-- Step 5: Preview -->
                <div class="section" data-section="5">
                    <div class="section-title">▶️ Animation Preview</div>

                    <div class="info-box">
                        Watch your chat conversation animate. Adjust speed and playback options below.
                    </div>

                    <div class="input-group">
                        <label>Animation Speed</label>
                        <input type="range" id="animSpeed" min="500" max="3000" value="1000" step="100" onchange="updateSpeed()">
                        <span id="animSpeedVal">3.0s per message</span>
                    </div>

                    <div class="control-row">
                        <button class="btn btn-primary" onclick="playAnimation()" id="playBtn">⏸️ Pause</button>
                        <button class="btn btn-secondary" onclick="stopAnimation()">⏹ Stop</button>
                    </div>

                    <div class="control-row">
                        <button class="btn btn-secondary" onclick="prevMessage()">⬅️ Prev</button>
                        <button class="btn btn-secondary" onclick="nextMessage()">➡️ Next</button>
                    </div>

                    <div class="control-row">
                        <button class="btn btn-primary" onclick="toggleAudio()" id="audioToggleBtn" style="width: 100%;">🔊 Audio: ON</button>
                    </div>

                    <div class="frame-counter" id="frameCounter">Frame 2 / 8</div>
                </div>

                <!-- Step 6: Export & Save -->
                <div class="section active" data-section="6">
                    <div class="section-title">💾 Export &amp; Save</div>

                    <div class="info-box">
                        <strong>Export Frames:</strong> Download HTML files for each animation frame.<br>
                        <strong>Export Standalone:</strong> Create a single self-contained HTML file with full animation controls.<br>
                        <strong>Save Project:</strong> Save entire project to continue later.
                    </div>

                    <h4 style="font-size: 14px; margin-bottom: 12px; color: #764ba2;">
                        🔊 Voice Narration
                        <span id="ttsStatusBadge" style="font-size: 11px; padding: 2px 8px; background: #f8d7da; color: #721c24; border-radius: 4px; margin-left: 8px; font-weight: 600;">Not Configured</span>
                    </h4>

                    <div class="info-box" style="background: #e3f2fd; border-left-color: #2196f3;">
                        Configure Azure Text-to-Speech to add voice narration to your chat animations. Voice will play automatically during playback.
                    </div>

                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <div class="input-group">
                            <label for="ttsKey">Azure TTS Key</label>
                            <input type="password" id="ttsKey" placeholder="Enter your Azure TTS key">
                        </div>

                        <div class="input-group">
                            <label for="ttsRegion">Region</label>
                            <select id="ttsRegion">
                                <option value="eastus">East US</option>
                                <option value="eastus2" selected>East US 2</option>
                                <option value="westus">West US</option>
                                <option value="westus2">West US 2</option>
                                <option value="centralus">Central US</option>
                                <option value="northcentralus">North Central US</option>
                                <option value="southcentralus">South Central US</option>
                                <option value="westeurope">West Europe</option>
                                <option value="northeurope">North Europe</option>
                                <option value="uksouth">UK South</option>
                                <option value="eastasia">East Asia</option>
                                <option value="southeastasia">Southeast Asia</option>
                                <option value="japaneast">Japan East</option>
                                <option value="japanwest">Japan West</option>
                                <option value="australiaeast">Australia East</option>
                                <option value="centralindia">Central India</option>
                                <option value="canadacentral">Canada Central</option>
                                <option value="brazilsouth">Brazil South</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="ttsVoice">Voice</label>
                            <select id="ttsVoice">
                                <optgroup label="English (US) - Female">
                                    <option value="en-US-JennyNeural">Jenny (Neural)</option>
                                    <option value="en-US-AriaNeural" selected>Aria (Neural)</option>
                                    <option value="en-US-SaraNeural">Sara (Neural)</option>
                                    <option value="en-US-AshleyNeural">Ashley (Neural)</option>
                                    <option value="en-US-AmberNeural">Amber (Neural)</option>
                                </optgroup>
                                <optgroup label="English (US) - Male">
                                    <option value="en-US-GuyNeural">Guy (Neural)</option>
                                    <option value="en-US-TonyNeural">Tony (Neural)</option>
                                    <option value="en-US-ChristopherNeural">Christopher (Neural)</option>
                                    <option value="en-US-EricNeural">Eric (Neural)</option>
                                </optgroup>
                                <optgroup label="English (UK) - Female">
                                    <option value="en-GB-SoniaNeural">Sonia (Neural)</option>
                                    <option value="en-GB-LibbyNeural">Libby (Neural)</option>
                                    <option value="en-GB-MaisieNeural">Maisie (Neural)</option>
                                </optgroup>
                                <optgroup label="English (UK) - Male">
                                    <option value="en-GB-RyanNeural">Ryan (Neural)</option>
                                    <option value="en-GB-ThomasNeural">Thomas (Neural)</option>
                                </optgroup>
                            </select>
                        </div>

                        <button class="btn btn-primary" onclick="saveTTSSettings()" style="margin-top: 8px;">
                            💾 Save TTS Settings
                        </button>
                    </div>

                    <h4 style="font-size: 14px; margin-bottom: 12px; color: #764ba2;">Project Management</h4>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="document.getElementById('projectInput').click()">
                            📂 Load Project
                        </button>
                        <button class="btn btn-primary" onclick="saveProject()">
                            💾 Save Project
                        </button>
                    </div>
                    <input type="file" id="projectInput" accept=".json" style="display: none;" onchange="loadProject(event)">

                    <div class="success-box" id="projectStatus" style="display: block; margin-bottom: 16px;">✓ Project saved successfully! File: chat-animation-project-1760731127009.json</div>

                    <h4 style="font-size: 14px; margin: 20px 0 12px; color: #764ba2;">Present &amp; Export</h4>

                    <button class="btn btn-primary" onclick="openPresentationMode()" style="margin-bottom: 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        🎬 Present Mode (Screen Record)
                    </button>

                    <button class="btn btn-success" onclick="exportAnimation()" style="margin-bottom: 12px;">
                        📥 Export All Frames
                    </button>

                    <button class="btn btn-primary" onclick="exportStandaloneAnimation()" style="margin-bottom: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        🎬 Export Standalone Animation
                    </button>

                    <div style="font-size: 12px; color: #666; line-height: 1.6; margin-top: 16px;">
                        <strong>What's included in project file:</strong><br>
                        • Background HTML<br>
                        • All message styles<br>
                        • Conversation messages<br>
                        • Overlay position &amp; styling<br>
                        • Animation settings
                    </div>
                </div>
            </div>

            <!-- Preview Area -->
            <div class="studio-preview">
                <div class="preview-container" id="previewContainer">
                <div style="padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 20px;">🎉</div>
                    <h2 style="color: #667eea; margin-bottom: 16px;">Your Chat Animation is Ready!</h2>
                    <div style="max-width: 600px; color: #666; line-height: 1.8; margin-bottom: 32px;">
                        <p style="margin-bottom: 16px;">You've successfully created a chat animation with 8 messages.</p>
                        <p style="margin-bottom: 16px;">Use the sidebar to <strong>save your project</strong> for later, or <strong>export frames</strong> to use in presentations.</p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; width: 100%; max-width: 750px;">
                        <div style="background: #fff0f6; padding: 24px; border-radius: 12px; border: 2px solid #f5576c;">
                            <div style="font-size: 32px; margin-bottom: 8px;">🎬</div>
                            <div style="font-weight: 600; color: #f5576c; margin-bottom: 8px;">Present Mode</div>
                            <div style="font-size: 13px; color: #666;">Screen record your demo</div>
                        </div>
                        <div style="background: #f0f4ff; padding: 24px; border-radius: 12px; border: 2px solid #667eea;">
                            <div style="font-size: 32px; margin-bottom: 8px;">💾</div>
                            <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">Save Project</div>
                            <div style="font-size: 13px; color: #666;">Reload anytime to continue editing</div>
                        </div>
                        <div style="background: #f0fff4; padding: 24px; border-radius: 12px; border: 2px solid #4caf50;">
                            <div style="font-size: 32px; margin-bottom: 8px;">📥</div>
                            <div style="font-weight: 600; color: #4caf50; margin-bottom: 8px;">Export Frames</div>
                            <div style="font-size: 13px; color: #666;">8 HTML files ready</div>
                        </div>
                    </div>

                    <div style="margin-top: 32px; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px; max-width: 600px;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #856404;">💡 Pro Tip</div>
                        <div style="font-size: 13px; color: #856404; text-align: left;">
                            Save your project before exporting frames! This way you can come back later to make changes without starting from scratch.
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="nav-buttons">
            <button class="btn btn-secondary" onclick="prevStep()" id="prevBtn">⬅️ Previous</button>
            <button class="btn btn-primary" onclick="nextStep()" id="nextBtn">✓ Done</button>
        </div>
    </div>

    <!-- Style Capture Modal -->
    <div class="capture-modal" id="captureModal">
        <div class="capture-modal-content">
            <h2>🎨 Captured Styles</h2>
            <div id="capturedStylesDisplay"></div>
            <div class="capture-preview" id="capturePreview">
                <div style="font-size: 13px; color: #888; margin-bottom: 8px;">Preview:</div>
                <div id="capturePreviewText">Sample message text</div>
            </div>
            <div class="apply-buttons">
                <button class="btn btn-primary" onclick="applyCapturedStyles('agent')">
                    Apply to Agent Messages
                </button>
                <button class="btn btn-primary" onclick="applyCapturedStyles('customer')">
                    Apply to Customer Messages
                </button>
            </div>
            <button class="btn btn-secondary" onclick="closeCaptureModal()" style="margin-top: 12px;">
                Cancel
            </button>
        </div>
    </div>

    <script>
        // State management
        let currentStep = 1;
        let backgroundHTML = null;
        let messages = [];
        let overlayPosition = { x: 50, y: 50, width: 600, height: 400 };
        let animationInterval = null;
        let currentFrame = 0;
        let styleCaptureActive = false;
        let capturedStyles = null;
        let templateCaptureActive = false;
        let capturedTemplate = null;

        // Multi-conversation support
        let loadedConversations = [];
        let currentConversationIndex = -1;

        // TTS Configuration
        const TTS_STORAGE_KEY = 'chatStudioTTSConfig';
        let ttsConfig = {};
        let speechSynthesizer = null;
        let audioEnabled = true;
        let currentSpeaking = false;
        let lastSpokenFrame = -1; // Track which frame was last narrated

        // Initialize
        window.addEventListener('load', () => {
            updateStylePreview();
            renderPreview();
            loadTTSConfig();
            // Delay TTS initialization slightly to ensure SDK is loaded
            setTimeout(() => {
                initializeTTS();
            }, 1000);
        });

        // TTS Configuration Management
        function loadTTSConfig() {
            const stored = localStorage.getItem(TTS_STORAGE_KEY);
            if (stored) {
                try {
                    ttsConfig = JSON.parse(stored);
                    updateTTSStatus();
                    // Populate the fields
                    if (document.getElementById('ttsKey')) {
                        document.getElementById('ttsKey').value = ttsConfig.key || '';
                        document.getElementById('ttsRegion').value = ttsConfig.region || 'eastus2';
                        document.getElementById('ttsVoice').value = ttsConfig.voiceName || 'en-US-AriaNeural';
                    }
                } catch (error) {
                    console.error('Error loading TTS config:', error);
                }
            }
        }

        function saveTTSSettings() {
            const key = document.getElementById('ttsKey').value.trim();
            const region = document.getElementById('ttsRegion').value;
            const voiceName = document.getElementById('ttsVoice').value;

            if (!key) {
                alert('Please enter a TTS key');
                return;
            }

            ttsConfig = {
                key: key,
                region: region,
                voiceName: voiceName
            };

            // Save to localStorage
            localStorage.setItem(TTS_STORAGE_KEY, JSON.stringify(ttsConfig));

            // Re-initialize TTS with new settings
            initializeTTS();
            updateTTSStatus();

            alert('✓ TTS settings saved successfully');
        }

        function updateTTSStatus() {
            const statusBadge = document.getElementById('ttsStatusBadge');
            if (statusBadge) {
                if (ttsConfig && ttsConfig.key) {
                    statusBadge.textContent = 'Configured';
                    statusBadge.style.background = '#d4edda';
                    statusBadge.style.color = '#155724';
                } else {
                    statusBadge.textContent = 'Not Configured';
                    statusBadge.style.background = '#f8d7da';
                    statusBadge.style.color = '#721c24';
                }
            }
        }

        // Initialize TTS with Azure Speech SDK
        function initializeTTS() {
            if (ttsConfig && ttsConfig.key && window.SpeechSDK) {
                try {
                    const speechConfig = window.SpeechSDK.SpeechConfig.fromSubscription(
                        ttsConfig.key,
                        ttsConfig.region || 'eastus2'
                    );
                    speechConfig.speechSynthesisVoiceName = ttsConfig.voiceName || 'en-US-AriaNeural';

                    const audioConfig = window.SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
                    speechSynthesizer = new window.SpeechSDK.SpeechSynthesizer(speechConfig, audioConfig);

                    console.log('TTS initialized with config:', {
                        region: ttsConfig.region,
                        voiceName: ttsConfig.voiceName
                    });
                } catch (error) {
                    console.error('Error initializing TTS:', error);
                }
            }
        }

        // Speak text using Azure TTS
        async function speakText(text) {
            if (!audioEnabled || !speechSynthesizer || currentSpeaking || !text) return;

            currentSpeaking = true;

            return new Promise((resolve, reject) => {
                speechSynthesizer.speakTextAsync(
                    text,
                    result => {
                        if (result.reason === window.SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
                            currentSpeaking = false;
                            resolve();
                        } else {
                            currentSpeaking = false;
                            reject(result);
                        }
                    },
                    error => {
                        currentSpeaking = false;
                        console.error('TTS error:', error);
                        reject(error);
                    }
                );
            });
        }

        // Stop speaking
        function stopSpeaking() {
            if (speechSynthesizer && currentSpeaking) {
                speechSynthesizer.close();
                initializeTTS(); // Reinitialize after closing
                currentSpeaking = false;
            }
        }

        // Toggle audio on/off
        function toggleAudio() {
            audioEnabled = !audioEnabled;
            const btn = document.getElementById('audioToggleBtn');
            if (btn) {
                if (audioEnabled) {
                    btn.textContent = '🔊 Audio: ON';
                    btn.classList.add('btn-primary');
                    btn.classList.remove('btn-secondary');
                } else {
                    btn.textContent = '🔇 Audio: OFF';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-secondary');
                    stopSpeaking();
                }
            }
        }

        // Clear all data and reset to fresh state
        function clearAll() {
            if (!confirm('Are you sure you want to clear everything and start fresh? This cannot be undone.')) {
                return;
            }

            // Reset all state variables
            currentStep = 1;
            backgroundHTML = null;
            messages = [];
            overlayPosition = { x: 50, y: 50, width: 600, height: 400 };
            animationInterval = null;
            currentFrame = 0;

            // Clear file inputs
            document.getElementById('backgroundInput').value = '';
            document.getElementById('conversationInput').value = '';

            // Reset background upload UI
            document.getElementById('backgroundUpload').classList.remove('loaded');
            document.getElementById('backgroundStatus').innerHTML = '';

            // Reset style controls to defaults (Copilot-style)
            document.getElementById('agentBg').value = '#ffffff';
            document.getElementById('agentColor').value = '#242424';
            document.getElementById('agentRadius').value = '8';
            document.getElementById('agentPadding').value = '16';

            // Reset agent component checkboxes
            document.getElementById('agentShowAvatar').checked = true;
            document.getElementById('agentShowTitle').checked = true;
            document.getElementById('agentShowActions').checked = true;

            document.getElementById('customerBg').value = '#f3f2f1';
            document.getElementById('customerColor').value = '#242424';
            document.getElementById('customerRadius').value = '8';
            document.getElementById('customerPadding').value = '12';

            // Reset customer component checkboxes
            document.getElementById('customerShowAvatar').checked = false;
            document.getElementById('customerShowTitle').checked = false;
            document.getElementById('customerShowActions').checked = false;

            document.getElementById('overlayBg').value = '#ffffff';
            document.getElementById('overlayOpacity').value = '100';
            document.getElementById('overlayRadius').value = '8';

            document.getElementById('animSpeed').value = '1000';

            // Clear message input
            document.getElementById('messageText').value = '';
            document.getElementById('messageType').value = 'agent';

            // Update all UI
            updateMessageList();
            updateStylePreview();
            goToStep(1);

            alert('✓ Everything cleared! Starting fresh.');
        }

        // Step navigation
        function goToStep(step) {
            currentStep = step;

            // Update step indicators
            document.querySelectorAll('.step').forEach((el, idx) => {
                el.classList.remove('active');
                if (idx + 1 < step) {
                    el.classList.add('completed');
                } else {
                    el.classList.remove('completed');
                }
            });
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');

            // Update sections
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelector(`.section[data-section="${step}"]`).classList.add('active');

            // Update navigation buttons
            document.getElementById('prevBtn').disabled = step === 1;
            document.getElementById('nextBtn').textContent = step === 6 ? '✓ Done' : 'Next ➡️';

            // Render preview for current step
            renderPreview();
        }

        function nextStep() {
            if (currentStep < 6) {
                goToStep(currentStep + 1);
            } else {
                // At final step, show success message
                alert('✓ Project complete! Use the buttons above to save your project or export frames.');
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                goToStep(currentStep - 1);
            }
        }

        // Background upload
        function loadBackground(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                // AGGRESSIVE CLEANUP - Strip everything that could generate console errors!
                let htmlContent = e.target.result;

                // 1. Remove ALL script tags (inline, external, type="module", etc.)
                htmlContent = htmlContent.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');

                // 2. Remove noscript tags (not needed in sandbox)
                htmlContent = htmlContent.replace(/<noscript\b[^<]*(?:(?!<\/noscript>)<[^<]*)*<\/noscript>/gi, '');

                // 3. Remove meta refresh tags (cause sandbox redirect errors)
                htmlContent = htmlContent.replace(/<meta[^>]*http-equiv=["']?refresh["']?[^>]*>/gi, '');

                // 4. Remove ALL inline event handlers (onclick, onload, onerror, etc.)
                htmlContent = htmlContent.replace(/\s+on\w+\s*=\s*["'][^"']*["']/gi, '');

                // 5. Remove javascript: hrefs
                htmlContent = htmlContent.replace(/href\s*=\s*["']javascript:[^"']*["']/gi, 'href="#"');

                // 6. Remove problematic link preloads/prefetches that might cause errors
                htmlContent = htmlContent.replace(/<link[^>]*rel=["']?(preload|prefetch|modulepreload)["']?[^>]*>/gi, '');

                backgroundHTML = htmlContent;

                document.getElementById('backgroundUpload').classList.add('loaded');
                document.getElementById('backgroundStatus').innerHTML =
                    `<span style="color: #4caf50;">✓ Loaded: ${file.name} (interactive elements removed for clean display)</span>`;
                renderPreview();
            };
            reader.readAsText(file);
        }

        // Format message text to avoid wall of text
        function formatMessageText(text) {
            // Split by sentences (periods followed by space/newline)
            const sentences = text.split(/\.\s+/);

            // If there are more than 3 sentences, group into paragraphs
            if (sentences.length > 3) {
                const paragraphs = [];
                for (let i = 0; i < sentences.length; i += 2) {
                    const paragraph = sentences.slice(i, i + 2).join('. ');
                    paragraphs.push(paragraph + (paragraph.endsWith('.') ? '' : '.'));
                }
                return paragraphs.map(p => `<p style="margin: 0 0 8px 0; line-height: 1.6;">${p}</p>`).join('');
            }

            // For shorter messages, just return with proper line height
            return `<span style="line-height: 1.6;">${text}</span>`;
        }

        // Helper function to render a message with components
        function renderMessageWithComponents(messageText, messageType, styles) {
            const isAgent = messageType === 'agent';
            const showAvatar = document.getElementById(`${messageType}ShowAvatar`)?.checked || false;
            const showTitle = document.getElementById(`${messageType}ShowTitle`)?.checked || false;
            const showActions = document.getElementById(`${messageType}ShowActions`)?.checked || false;

            let html = `<div style="display: flex; align-items: flex-start; gap: 12px; max-width: 90%; ${!isAgent ? 'margin-left: auto; justify-content: flex-end;' : ''}">`;

            // Avatar (left for agent, right for customer)
            if (isAgent && showAvatar) {
                html += `<div style="width: 32px; height: 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 600;">AI</div>`;
            }

            html += `<div style="flex: 1; min-width: 0; ${!isAgent ? 'display: flex; flex-direction: column; align-items: flex-end;' : ''}">`;

            // Title
            if (showTitle) {
                html += `<div style="font-size: 13px; font-weight: 600; color: #616161; margin-bottom: 4px;">${isAgent ? 'AI Assistant' : 'You'}</div>`;
            }

            // Message bubble
            html += `<div style="background-color: ${styles.bg}; color: ${styles.color}; border-radius: ${styles.radius}px; padding: ${styles.padding}px; font-size: 14px;">${formatMessageText(messageText)}</div>`;

            // Action buttons
            if (showActions) {
                if (isAgent) {
                    html += `<div style="display: flex; gap: 8px; margin-top: 8px; align-items: center;">
                        <button style="background: none; border: none; cursor: pointer; padding: 4px; opacity: 0.6;">👍</button>
                        <button style="background: none; border: none; cursor: pointer; padding: 4px; opacity: 0.6;">👎</button>
                        <button style="background: none; border: none; cursor: pointer; padding: 4px; opacity: 0.6;">🔊</button>
                        <button style="background: none; border: none; cursor: pointer; padding: 4px; opacity: 0.6;">📋</button>
                    </div>`;
                } else {
                    html += `<div style="display: flex; gap: 8px; margin-top: 8px; align-items: center;">
                        <button style="background: none; border: none; cursor: pointer; padding: 4px; opacity: 0.6;">✏️</button>
                        <button style="background: none; border: none; cursor: pointer; padding: 4px; opacity: 0.6;">🗑️</button>
                    </div>`;
                }
            }

            html += '</div>';

            // Avatar (right for customer)
            if (!isAgent && showAvatar) {
                html += `<div style="width: 32px; height: 32px; background: #e0e0e0; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: #616161; font-size: 14px; font-weight: 600;">U</div>`;
            }

            html += '</div>';

            return html;
        }

        // Style preview
        function updateStylePreview() {
            const agentBg = document.getElementById('agentBg').value;
            const agentColor = document.getElementById('agentColor').value;
            const agentRadius = document.getElementById('agentRadius').value;
            const agentPadding = document.getElementById('agentPadding').value;

            const customerBg = document.getElementById('customerBg').value;
            const customerColor = document.getElementById('customerColor').value;
            const customerRadius = document.getElementById('customerRadius').value;
            const customerPadding = document.getElementById('customerPadding').value;

            // Use helper function to render messages with components
            const agentHTML = renderMessageWithComponents(
                'Hi! Great to hear from you. How can I assist you today?',
                'agent',
                { bg: agentBg, color: agentColor, radius: agentRadius, padding: agentPadding }
            );

            const customerHTML = renderMessageWithComponents(
                'hello',
                'customer',
                { bg: customerBg, color: customerColor, radius: customerRadius, padding: customerPadding }
            );

            // Update sidebar preview bubbles
            const agentPreview = document.getElementById('agentPreview');
            if (agentPreview) {
                agentPreview.outerHTML = `<div id="agentPreview" class="message-bubble agent">${agentHTML}</div>`;
            }

            const customerPreview = document.getElementById('customerPreview');
            if (customerPreview) {
                customerPreview.outerHTML = `<div id="customerPreview" class="message-bubble customer">${customerHTML}</div>`;
            }

            // Update main preview (only exists in step 2)
            const previewAgent = document.getElementById('previewAgent');
            if (previewAgent) {
                previewAgent.outerHTML = `<div id="previewAgent">${agentHTML}</div>`;
            }

            const previewCustomer = document.getElementById('previewCustomer');
            if (previewCustomer) {
                previewCustomer.outerHTML = `<div id="previewCustomer">${customerHTML}</div>`;
            }

            // Update value displays
            document.getElementById('agentRadiusVal').textContent = agentRadius + 'px';
            document.getElementById('agentPaddingVal').textContent = agentPadding + 'px';
            document.getElementById('customerRadiusVal').textContent = customerRadius + 'px';
            document.getElementById('customerPaddingVal').textContent = customerPadding + 'px';
        }

        // Message management
        function addMessage() {
            const type = document.getElementById('messageType').value;
            const text = document.getElementById('messageText').value.trim();

            if (!text) {
                alert('Please enter message text');
                return;
            }

            messages.push({ type, text });
            document.getElementById('messageText').value = '';
            updateMessageList();
            renderPreview();
        }

        function removeMessage(index) {
            messages.splice(index, 1);
            updateMessageList();
            renderPreview();
        }

        function updateMessageList() {
            const list = document.getElementById('messageList');
            document.getElementById('messageCount').textContent = messages.length;

            if (messages.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #888; padding: 20px; font-size: 13px;">No messages yet. Add your first message above.</div>';
                return;
            }

            list.innerHTML = messages.map((msg, idx) => `
                <div class="message-list-item">
                    <div>
                        <span class="type-badge ${msg.type}">${msg.type}</span>
                        <div style="margin-top: 6px; font-size: 13px; color: #666;">${msg.text.substring(0, 50)}${msg.text.length > 50 ? '...' : ''}</div>
                    </div>
                    <div class="message-actions">
                        <button class="icon-btn" onclick="removeMessage(${idx})" title="Delete">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Import conversation JSON files (supports multiple files and formats)
         */
        function importConversationJSON(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            let filesProcessed = 0;
            let successCount = 0;

            // Process each file
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        let conversationMessages = [];
                        let conversationName = file.name;

                        console.log(`Processing ${file.name}, structure:`, Object.keys(json));

                        // Helper function to format agentData into readable text
                        function formatAgentData(agentData) {
                            if (!agentData || typeof agentData !== 'object') return '';

                            let formatted = '\n\n';

                            // Add title with emoji
                            if (agentData.title) {
                                formatted += `📋 ${agentData.title}\n`;
                            }

                            // Add status
                            if (agentData.status) {
                                formatted += `Status: ${agentData.status}\n`;
                            }

                            // Process other fields
                            for (const [key, value] of Object.entries(agentData)) {
                                if (['title', 'status', 'stack_name', 'category', 'description'].includes(key)) {
                                    continue; // Skip metadata fields
                                }

                                formatted += '\n';

                                if (typeof value === 'object' && !Array.isArray(value)) {
                                    // Handle nested objects (like details, profile, etc.)
                                    formatted += `${key}:\n`;
                                    for (const [subKey, subValue] of Object.entries(value)) {
                                        formatted += `  • ${subKey}: ${subValue}\n`;
                                    }
                                } else if (Array.isArray(value)) {
                                    // Handle arrays (like products, opportunities, etc.)
                                    formatted += `${key}:\n`;
                                    value.forEach(item => {
                                        if (typeof item === 'object') {
                                            formatted += '\n';
                                            for (const [k, v] of Object.entries(item)) {
                                                formatted += `  • ${k}: ${v}\n`;
                                            }
                                        } else {
                                            formatted += `  • ${item}\n`;
                                        }
                                    });
                                } else {
                                    // Simple key-value
                                    formatted += `• ${key}: ${value}\n`;
                                }
                            }

                            return formatted;
                        }

                        // Check if it's a demoScript format (with content field instead of text)
                        if (json.demoScript && Array.isArray(json.demoScript)) {
                            // DemoScript format - map content to text, and include agentData if present
                            json.demoScript.forEach(msg => {
                                if (msg.type && msg.content) {
                                    let fullText = msg.content;

                                    // If message has agentData, format and append it
                                    if (msg.agentData) {
                                        fullText += formatAgentData(msg.agentData);
                                    }

                                    conversationMessages.push({
                                        type: msg.type,
                                        text: fullText
                                    });
                                }
                            });

                            // Try to use metadata.agent_name or stack_name as conversation name
                            if (json.metadata) {
                                conversationName = json.metadata.agent_name || json.metadata.stack_name || file.name;
                            }
                        }
                        // Check if it's a demo narrative JSON (has chatInteractions)
                        else if (json.chatInteractions && Array.isArray(json.chatInteractions)) {
                            // Demo narrative format
                            json.chatInteractions.forEach(interaction => {
                                if (interaction.messages && Array.isArray(interaction.messages)) {
                                    interaction.messages.forEach(msg => {
                                        if (msg.type && msg.text) {
                                            conversationMessages.push({
                                                type: msg.type,
                                                text: msg.text
                                            });
                                        }
                                    });
                                }
                            });

                            conversationName = json.name || file.name;
                        }
                        // Check if it's a simple messages array format
                        else if (json.messages && Array.isArray(json.messages)) {
                            // Simple format
                            json.messages.forEach(msg => {
                                if (msg.type && (msg.text || msg.content)) {
                                    conversationMessages.push({
                                        type: msg.type,
                                        text: msg.text || msg.content  // Support both text and content
                                    });
                                }
                            });
                        }
                        // Check if the root itself is an array of messages
                        else if (Array.isArray(json) && json.length > 0 && json[0].type && (json[0].text || json[0].content)) {
                            // Direct array format
                            json.forEach(msg => {
                                if (msg.type && (msg.text || msg.content)) {
                                    conversationMessages.push({
                                        type: msg.type,
                                        text: msg.text || msg.content  // Support both text and content
                                    });
                                }
                            });
                        }
                        // Try to extract messages from any object with nested messages
                        else if (typeof json === 'object') {
                            // Search for messages arrays in the structure
                            let foundMessages = false;

                            // Check for nested structures
                            Object.values(json).forEach(value => {
                                if (Array.isArray(value) && value.length > 0 && value[0].type && (value[0].text || value[0].content)) {
                                    value.forEach(msg => {
                                        if (msg.type && (msg.text || msg.content)) {
                                            conversationMessages.push({
                                                type: msg.type,
                                                text: msg.text || msg.content  // Support both text and content
                                            });
                                        }
                                    });
                                    foundMessages = true;
                                }
                            });

                            if (!foundMessages) {
                                console.error(`Invalid JSON format in ${file.name}. Found keys: ${Object.keys(json).join(', ')}`);
                                console.log('JSON structure:', json);
                                return;
                            }
                        }
                        else {
                            console.error(`Invalid JSON format in ${file.name}. Expected object or array.`);
                            console.log('JSON content:', json);
                            return;
                        }

                        // Add to loaded conversations
                        if (conversationMessages.length > 0) {
                            loadedConversations.push({
                                name: conversationName,
                                messages: conversationMessages,
                                metadata: json.metadata || {},
                                category: json.metadata?.category || 'general'
                            });
                            successCount++;
                        }

                    } catch (error) {
                        console.error(`Error importing ${file.name}:`, error);
                        console.error('Error details:', error.message);
                        if (error instanceof SyntaxError) {
                            console.error('File contains invalid JSON. Please check the file format.');
                            console.error('First 500 characters:', e.target.result.substring(0, 500));
                        }
                    }

                    filesProcessed++;

                    // When all files are processed
                    if (filesProcessed === files.length) {
                        updateConversationSelector();

                        // Auto-select the first conversation if this is the first batch
                        if (loadedConversations.length > 0 && currentConversationIndex === -1) {
                            switchConversation(0);
                        }

                        const failedCount = files.length - successCount;
                        let message = `✓ Successfully imported ${successCount} conversation(s)`;
                        if (failedCount > 0) {
                            message += `\n⚠️ ${failedCount} file(s) failed to import (check console for details)`;
                        }
                        message += `\nTotal loaded: ${loadedConversations.length}`;

                        alert(message);
                        event.target.value = '';
                    }
                };
                reader.readAsText(file);
            });
        }

        // Update conversation selector dropdown
        function updateConversationSelector() {
            const selector = document.getElementById('conversationSelector');
            const container = document.getElementById('conversationSelectorContainer');
            const loadedCount = document.getElementById('loadedCount');

            if (loadedConversations.length === 0) {
                container.style.display = 'none';
                return;
            }

            // Show the selector
            container.style.display = 'block';
            loadedCount.textContent = loadedConversations.length;

            // Clear and rebuild options
            selector.innerHTML = '<option value="-1">Select a conversation...</option>';

            loadedConversations.forEach((conv, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${conv.name} (${conv.messages.length} messages)`;
                if (index === currentConversationIndex) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
        }

        // Switch to a different conversation
        function switchConversation(index) {
            index = parseInt(index);

            if (index < 0 || index >= loadedConversations.length) {
                return;
            }

            currentConversationIndex = index;
            const conversation = loadedConversations[index];

            // Load the conversation messages
            messages = [...conversation.messages];

            // Update UI
            updateMessageList();
            renderPreview();
            updateConversationSelector();

            console.log(`Switched to conversation: ${conversation.name} (${messages.length} messages)`);
        }

        // Clear all loaded conversations
        function clearAllConversations() {
            if (loadedConversations.length === 0) {
                alert('No conversations loaded.');
                return;
            }

            if (!confirm(`Clear all ${loadedConversations.length} loaded conversations? This will not delete your current messages.`)) {
                return;
            }

            loadedConversations = [];
            currentConversationIndex = -1;
            updateConversationSelector();

            alert('✓ All loaded conversations cleared.');
        }

        // Export conversation JSON
        function exportConversationJSON() {
            if (messages.length === 0) {
                alert('No messages to export. Add messages first.');
                return;
            }

            const conversationJSON = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                messageCount: messages.length,
                messages: messages.map(msg => ({
                    type: msg.type,
                    text: msg.text
                }))
            };

            const jsonString = JSON.stringify(conversationJSON, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conversation-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert(`✓ Exported ${messages.length} messages to JSON`);
        }

        // Overlay styling
        function updateOverlayStyle() {
            const bg = document.getElementById('overlayBg').value;
            const opacity = document.getElementById('overlayOpacity').value;
            const radius = document.getElementById('overlayRadius').value;

            document.getElementById('overlayOpacityVal').textContent = opacity + '%';
            document.getElementById('overlayRadiusVal').textContent = radius + 'px';

            renderPreview();
        }

        function resetOverlayPosition() {
            overlayPosition = { x: 50, y: 50, width: 600, height: 400 };
            renderPreview();
        }

        // Color picker functionality
        let colorPickerActive = false;

        function toggleColorPicker() {
            colorPickerActive = !colorPickerActive;
            const btn = document.getElementById('colorPickerBtn');
            const hint = document.getElementById('colorPickerHint');

            if (colorPickerActive) {
                btn.style.background = '#ffc107';
                btn.style.color = '#000';
                btn.textContent = '✓ Color Picker Active - Click Background';
                hint.style.display = 'block';
                document.getElementById('previewContainer').style.cursor = 'crosshair';
            } else {
                btn.style.background = '';
                btn.style.color = '';
                btn.textContent = '🎨 Pick Color from Background';
                hint.style.display = 'none';
                document.getElementById('previewContainer').style.cursor = '';
            }
        }

        function pickColorFromBackground(event) {
            if (!colorPickerActive) return;
            if (event.target.closest('.chat-overlay')) return; // Don't pick from overlay itself

            // Get the iframe if background is loaded
            const iframe = document.querySelector('#previewContainer iframe');
            if (iframe) {
                try {
                    // Sample color from iframe background
                    const iframeDoc = iframe.contentDocument;

                    // Get coordinates relative to iframe
                    const iframeRect = iframe.getBoundingClientRect();
                    const x = event.clientX - iframeRect.left;
                    const y = event.clientY - iframeRect.top;

                    let element = iframeDoc.elementFromPoint(x, y);

                    if (element) {
                        // Traverse up the DOM tree to find first non-transparent background
                        let foundColor = null;
                        let currentElement = element;

                        while (currentElement && !foundColor) {
                            const computedStyle = iframeDoc.defaultView.getComputedStyle(currentElement);
                            const bgColor = computedStyle.backgroundColor;

                            // Check if color is not transparent
                            if (bgColor && bgColor !== 'transparent' && bgColor !== 'rgba(0, 0, 0, 0)') {
                                const rgb = bgColor.match(/\d+/g);
                                if (rgb && rgb.length >= 3) {
                                    // Check if alpha channel exists and is > 0
                                    const alpha = rgb[3] ? parseFloat(rgb[3]) : 1;
                                    if (alpha > 0) {
                                        // Convert rgb to hex
                                        const hex = '#' + rgb.slice(0, 3).map(x => {
                                            const h = parseInt(x).toString(16);
                                            return h.length === 1 ? '0' + h : h;
                                        }).join('');

                                        foundColor = hex;
                                    }
                                }
                            }

                            // Move up to parent element
                            currentElement = currentElement.parentElement;
                        }

                        if (foundColor) {
                            document.getElementById('overlayBg').value = foundColor;
                            updateOverlayStyle();
                            toggleColorPicker(); // Turn off picker after selection
                        } else {
                            alert('Could not find a solid background color. Try clicking a different area or manually select a color.');
                            toggleColorPicker();
                        }
                    }
                } catch (e) {
                    console.error('Color picker error:', e);
                    alert('Cannot sample color from this element. Try clicking a different area.');
                    toggleColorPicker();
                }
            } else {
                // Sample from default gradient background
                alert('Upload a background HTML first to use color picker, or manually enter a color.');
                toggleColorPicker();
            }
        }

        // Preview rendering
        function renderPreview() {
            const container = document.getElementById('previewContainer');

            if (currentStep === 1) {
                // Step 1: Show background
                if (backgroundHTML) {
                    // Use sandbox to completely disable scripts - clean console!
                    container.innerHTML = '<iframe sandbox="allow-same-origin" style="width: 100%; height: 100%; border: none; border-radius: 8px;"></iframe>';
                    const iframe = container.querySelector('iframe');
                    iframe.contentDocument.open();
                    iframe.contentDocument.write(backgroundHTML);
                    iframe.contentDocument.close();
                } else {
                    container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #888;">No background uploaded. Using default background.</div>';
                }
            } else if (currentStep === 2) {
                // Step 2: Show style preview OR background if capture mode is active
                if ((styleCaptureActive || templateCaptureActive) && backgroundHTML) {
                    // Show background for capture modes
                    container.innerHTML = '<iframe sandbox="allow-same-origin" style="width: 100%; height: 100%; border: none; border-radius: 8px;"></iframe>';
                    const iframe = container.querySelector('iframe');
                    iframe.contentDocument.open();
                    iframe.contentDocument.write(backgroundHTML);
                    iframe.contentDocument.close();

                    // Attach appropriate click handler immediately after writing content
                    setTimeout(() => {
                        try {
                            if (iframe.contentDocument && iframe.contentDocument.body) {
                                if (styleCaptureActive) {
                                    iframe.contentDocument.body.style.cursor = 'crosshair';
                                    iframe.contentDocument.addEventListener('click', captureStyleFromIframe);
                                    console.log('Style capture click handler attached to iframe');
                                } else if (templateCaptureActive) {
                                    iframe.contentDocument.body.style.cursor = 'copy';
                                    iframe.contentDocument.addEventListener('click', captureTemplateFromIframe);
                                    console.log('Template capture click handler attached to iframe');
                                }
                            }
                        } catch (e) {
                            console.warn('Could not attach click handler to iframe:', e);
                        }
                    }, 100);
                } else {
                    // Show normal style preview
                    container.innerHTML = `
                        <div style="padding: 40px;">
                            <h3 style="margin-bottom: 24px; color: #667eea;">Message Style Preview</h3>
                            <div class="message-item agent">
                                <div class="message-bubble agent" id="previewAgent">This is how agent messages will look</div>
                            </div>
                            <div class="message-item customer">
                                <div class="message-bubble customer" id="previewCustomer">This is how customer messages will look</div>
                            </div>
                        </div>
                    `;
                    updateStylePreview();
                }
            } else if (currentStep === 3) {
                // Step 3: Show conversation
                renderConversationPreview();
            } else if (currentStep === 4) {
                // Step 4: Show positioning
                renderPositioningPreview();
            } else if (currentStep === 5) {
                // Step 5: Show animation
                renderAnimationPreview();
            } else if (currentStep === 6) {
                // Step 6: Show final summary
                renderExportSummary();
            }
        }

        function renderExportSummary() {
            const container = document.getElementById('previewContainer');

            const summary = `
                <div style="padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 20px;">🎉</div>
                    <h2 style="color: #667eea; margin-bottom: 16px;">Your Chat Animation is Ready!</h2>
                    <div style="max-width: 600px; color: #666; line-height: 1.8; margin-bottom: 32px;">
                        <p style="margin-bottom: 16px;">You've successfully created a chat animation with ${messages.length} message${messages.length !== 1 ? 's' : ''}.</p>
                        <p style="margin-bottom: 16px;">Use the sidebar to <strong>save your project</strong> for later, or <strong>export frames</strong> to use in presentations.</p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; width: 100%; max-width: 750px;">
                        <div style="background: #fff0f6; padding: 24px; border-radius: 12px; border: 2px solid #f5576c;">
                            <div style="font-size: 32px; margin-bottom: 8px;">🎬</div>
                            <div style="font-weight: 600; color: #f5576c; margin-bottom: 8px;">Present Mode</div>
                            <div style="font-size: 13px; color: #666;">Screen record your demo</div>
                        </div>
                        <div style="background: #f0f4ff; padding: 24px; border-radius: 12px; border: 2px solid #667eea;">
                            <div style="font-size: 32px; margin-bottom: 8px;">💾</div>
                            <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">Save Project</div>
                            <div style="font-size: 13px; color: #666;">Reload anytime to continue editing</div>
                        </div>
                        <div style="background: #f0fff4; padding: 24px; border-radius: 12px; border: 2px solid #4caf50;">
                            <div style="font-size: 32px; margin-bottom: 8px;">📥</div>
                            <div style="font-weight: 600; color: #4caf50; margin-bottom: 8px;">Export Frames</div>
                            <div style="font-size: 13px; color: #666;">${messages.length} HTML files ready</div>
                        </div>
                    </div>

                    <div style="margin-top: 32px; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px; max-width: 600px;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #856404;">💡 Pro Tip</div>
                        <div style="font-size: 13px; color: #856404; text-align: left;">
                            Save your project before exporting frames! This way you can come back later to make changes without starting from scratch.
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = summary;
        }

        function renderConversationPreview() {
            const container = document.getElementById('previewContainer');

            if (messages.length === 0) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #888;">Add messages to see the conversation preview</div>';
                return;
            }

            const agentBg = document.getElementById('agentBg').value;
            const agentColor = document.getElementById('agentColor').value;
            const agentRadius = document.getElementById('agentRadius').value;
            const agentPadding = document.getElementById('agentPadding').value;

            const customerBg = document.getElementById('customerBg').value;
            const customerColor = document.getElementById('customerColor').value;
            const customerRadius = document.getElementById('customerRadius').value;
            const customerPadding = document.getElementById('customerPadding').value;

            const messagesHTML = messages.map(msg => {
                const isAgent = msg.type === 'agent';
                const styles = {
                    bg: isAgent ? agentBg : customerBg,
                    color: isAgent ? agentColor : customerColor,
                    radius: isAgent ? agentRadius : customerRadius,
                    padding: isAgent ? agentPadding : customerPadding
                };

                return `
                    <div class="message-item ${msg.type}" style="margin-bottom: 16px;">
                        ${renderMessageWithComponents(msg.text, msg.type, styles)}
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div style="padding: 24px; overflow-y: auto; height: 100%;">
                    ${messagesHTML}
                </div>
            `;
        }

        function renderPositioningPreview() {
            const container = document.getElementById('previewContainer');
            const overlayBg = document.getElementById('overlayBg').value;
            const overlayOpacity = document.getElementById('overlayOpacity').value / 100;
            const overlayRadius = document.getElementById('overlayRadius').value;

            // Render background
            let backgroundContent = '<div style="width: 100%; height: 100%; background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%); border-radius: 8px;"></div>';

            if (backgroundHTML) {
                // Sandbox disables scripts - clean console!
                backgroundContent = `<iframe sandbox="allow-same-origin" style="width: 100%; height: 100%; border: none; border-radius: 8px; pointer-events: none;"></iframe>`;
            }

            container.innerHTML = backgroundContent;

            if (backgroundHTML) {
                const iframe = container.querySelector('iframe');
                iframe.contentDocument.open();
                iframe.contentDocument.write(backgroundHTML);
                iframe.contentDocument.close();
            }

            // Add draggable overlay
            const overlay = document.createElement('div');
            overlay.className = 'chat-overlay';
            overlay.style.left = overlayPosition.x + 'px';
            overlay.style.top = overlayPosition.y + 'px';
            overlay.style.width = overlayPosition.width + 'px';
            overlay.style.height = overlayPosition.height + 'px';
            overlay.style.background = overlayBg;
            overlay.style.opacity = overlayOpacity;
            overlay.style.borderRadius = overlayRadius + 'px';
            // NO box-shadow - breaks the illusion of blending!

            overlay.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 12px; color: #667eea;">Chat Overlay (Drag to reposition)</div>
                <div style="font-size: 13px; color: #888;">Your chat messages will appear here</div>
                <div class="overlay-handle"></div>
            `;

            container.appendChild(overlay);

            // Make draggable
            makeDraggable(overlay);
            makeResizable(overlay);

            // Add color picker click handler to container
            container.addEventListener('click', pickColorFromBackground);
        }

        function renderAnimationPreview() {
            const container = document.getElementById('previewContainer');

            if (messages.length === 0) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #888;">Add messages in Step 3 to see the animation preview</div>';
                return;
            }

            const overlayBg = document.getElementById('overlayBg').value;
            const overlayOpacity = document.getElementById('overlayOpacity').value / 100;
            const overlayRadius = document.getElementById('overlayRadius').value;

            // Render background (same as Step 4)
            let backgroundContent = '<div style="width: 100%; height: 100%; background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%); border-radius: 8px;"></div>';

            if (backgroundHTML) {
                backgroundContent = `<iframe sandbox="allow-same-origin" style="width: 100%; height: 100%; border: none; border-radius: 8px; pointer-events: none;"></iframe>`;
            }

            container.innerHTML = backgroundContent;

            if (backgroundHTML) {
                const iframe = container.querySelector('iframe');
                iframe.contentDocument.open();
                iframe.contentDocument.write(backgroundHTML);
                iframe.contentDocument.close();
            }

            // Add animated overlay on top
            const overlay = document.createElement('div');
            overlay.id = 'animationOverlay';
            overlay.style.cssText = `
                position: absolute;
                left: ${overlayPosition.x}px;
                top: ${overlayPosition.y}px;
                width: ${overlayPosition.width}px;
                height: ${overlayPosition.height}px;
                background: ${overlayBg};
                opacity: ${overlayOpacity};
                border-radius: ${overlayRadius}px;
                overflow-y: auto;
                z-index: 9999;
                padding: 16px;
            `;
            // NO box-shadow - seamless blend with background!

            overlay.innerHTML = '<div id="animationMessages"></div>';
            container.appendChild(overlay);

            currentFrame = 0;
            lastSpokenFrame = -1; // Reset voice narration tracking
            updateAnimationFrame();
        }

        function updateAnimationFrame() {
            const animContainer = document.getElementById('animationMessages');
            if (!animContainer) {
                console.error('Animation container not found');
                return;
            }

            const visibleMessages = messages.slice(0, currentFrame + 1);

            // Get style values
            const agentBg = document.getElementById('agentBg')?.value || '#ffffff';
            const agentColor = document.getElementById('agentColor')?.value || '#242424';
            const agentRadius = document.getElementById('agentRadius')?.value || '8';
            const agentPadding = document.getElementById('agentPadding')?.value || '16';

            const customerBg = document.getElementById('customerBg')?.value || '#f3f2f1';
            const customerColor = document.getElementById('customerColor')?.value || '#242424';
            const customerRadius = document.getElementById('customerRadius')?.value || '8';
            const customerPadding = document.getElementById('customerPadding')?.value || '12';

            // Build messages HTML using the SAME helper function as Step 3
            let messagesHTML = '';
            for (let i = 0; i < visibleMessages.length; i++) {
                const msg = visibleMessages[i];
                const isAgent = msg.type === 'agent';
                const styles = {
                    bg: isAgent ? agentBg : customerBg,
                    color: isAgent ? agentColor : customerColor,
                    radius: isAgent ? agentRadius : customerRadius,
                    padding: isAgent ? agentPadding : customerPadding
                };

                // Use the helper function that works in Step 3
                const messageHTML = renderMessageWithComponents(msg.text, msg.type, styles);
                messagesHTML += '<div class="message-item ' + msg.type + '" style="margin-bottom: 16px;">' + messageHTML + '</div>';
            }

            animContainer.innerHTML = messagesHTML;

            // Scroll to bottom to show latest message
            const overlay = document.getElementById('animationOverlay');
            if (overlay) {
                overlay.scrollTop = overlay.scrollHeight;
            }

            // Update frame counter
            const frameCounter = document.getElementById('frameCounter');
            if (frameCounter) {
                frameCounter.textContent = 'Frame ' + (currentFrame + 1) + ' / ' + messages.length;
            }

            // Voice narration - speak the current message if we haven't already
            if (currentFrame !== lastSpokenFrame && messages[currentFrame]) {
                lastSpokenFrame = currentFrame;
                const currentMessage = messages[currentFrame];
                if (currentMessage && currentMessage.text) {
                    // Speak the message text asynchronously
                    speakText(currentMessage.text).catch(error => {
                        console.error('Error speaking message:', error);
                    });
                }
            }
        }

        // Animation controls
        function playAnimation() {
            if (animationInterval) return;

            const speed = parseInt(document.getElementById('animSpeed').value);
            document.getElementById('playBtn').textContent = '⏸️ Pause';

            animationInterval = setInterval(() => {
                if (currentFrame < messages.length - 1) {
                    currentFrame++;
                    updateAnimationFrame();
                } else {
                    currentFrame = 0;
                    lastSpokenFrame = -1; // Reset voice tracking when looping
                    updateAnimationFrame();
                }
            }, speed);
        }

        function stopAnimation() {
            clearInterval(animationInterval);
            animationInterval = null;
            document.getElementById('playBtn').textContent = '▶️ Play';
            stopSpeaking(); // Stop any ongoing narration
        }

        function prevMessage() {
            stopSpeaking(); // Stop current narration before navigating
            if (currentFrame > 0) {
                currentFrame--;
                updateAnimationFrame();
            }
        }

        function nextMessage() {
            stopSpeaking(); // Stop current narration before navigating
            if (currentFrame < messages.length - 1) {
                currentFrame++;
                updateAnimationFrame();
            }
        }

        function updateSpeed() {
            const speed = document.getElementById('animSpeed').value;
            document.getElementById('animSpeedVal').textContent = (speed / 1000).toFixed(1) + 's per message';

            if (animationInterval) {
                stopAnimation();
                playAnimation();
            }
        }

        // Drag and resize functionality
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

            element.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                if (e.target.classList.contains('overlay-handle')) return;

                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;

                const newTop = element.offsetTop - pos2;
                const newLeft = element.offsetLeft - pos1;

                element.style.top = newTop + "px";
                element.style.left = newLeft + "px";

                overlayPosition.x = newLeft;
                overlayPosition.y = newTop;
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        function makeResizable(element) {
            const handle = element.querySelector('.overlay-handle');

            handle.onmousedown = resizeMouseDown;

            function resizeMouseDown(e) {
                e.preventDefault();
                e.stopPropagation();

                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = element.offsetWidth;
                const startHeight = element.offsetHeight;

                document.onmousemove = resize;
                document.onmouseup = stopResize;

                function resize(e) {
                    const newWidth = startWidth + (e.clientX - startX);
                    const newHeight = startHeight + (e.clientY - startY);

                    element.style.width = Math.max(300, newWidth) + 'px';
                    element.style.height = Math.max(200, newHeight) + 'px';

                    overlayPosition.width = Math.max(300, newWidth);
                    overlayPosition.height = Math.max(200, newHeight);
                }

                function stopResize() {
                    document.onmousemove = null;
                    document.onmouseup = null;
                }
            }
        }

        // Export
        function exportAnimation() {
            if (messages.length === 0) {
                alert('Please add at least one message before exporting');
                return;
            }

            const agentBg = document.getElementById('agentBg').value;
            const agentColor = document.getElementById('agentColor').value;
            const agentRadius = document.getElementById('agentRadius').value;
            const agentPadding = document.getElementById('agentPadding').value;

            const customerBg = document.getElementById('customerBg').value;
            const customerColor = document.getElementById('customerColor').value;
            const customerRadius = document.getElementById('customerRadius').value;
            const customerPadding = document.getElementById('customerPadding').value;

            const overlayBg = document.getElementById('overlayBg').value;
            const overlayOpacity = document.getElementById('overlayOpacity').value / 100;
            const overlayRadius = document.getElementById('overlayRadius').value;

            // Generate frames
            for (let i = 0; i < messages.length; i++) {
                const frameMessages = messages.slice(0, i + 1);

                const messagesHTML = frameMessages.map(msg => {
                    const isAgent = msg.type === 'agent';
                    const bg = isAgent ? agentBg : customerBg;
                    const color = isAgent ? agentColor : customerColor;
                    const radius = isAgent ? agentRadius : customerRadius;
                    const padding = isAgent ? agentPadding : customerPadding;

                    return `
                        <div style="display: flex; justify-content: ${isAgent ? 'flex-start' : 'flex-end'}; margin: 16px 0;">
                            <div style="max-width: 70%; background: ${bg}; color: ${color}; border-radius: ${radius}px; padding: ${padding}px 16px; word-wrap: break-word;">
                                ${msg.text}
                            </div>
                        </div>
                    `;
                }).join('');

                const chatHTML = `<div style="padding: 16px;">${messagesHTML}</div>`;

                // Create composite frame
                const parser = new DOMParser();
                const doc = parser.parseFromString(backgroundHTML || '<html><body style="background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%); margin: 0; padding: 0; width: 100vw; height: 100vh;"></body></html>', 'text/html');

                const overlayDiv = doc.createElement('div');
                overlayDiv.style.cssText = `
                    position: absolute;
                    left: ${overlayPosition.x}px;
                    top: ${overlayPosition.y}px;
                    width: ${overlayPosition.width}px;
                    height: ${overlayPosition.height}px;
                    background: ${overlayBg};
                    opacity: ${overlayOpacity};
                    border-radius: ${overlayRadius}px;
                    overflow: auto;
                    z-index: 9999;
                `;
                // NO box-shadow in exported frames - seamless blend!
                overlayDiv.innerHTML = chatHTML;

                doc.body.appendChild(overlayDiv);

                const frameHTML = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;

                // Download frame
                const blob = new Blob([frameHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chat-frame-${String(i + 1).padStart(2, '0')}.html`;
                a.click();
                URL.revokeObjectURL(url);
            }

            alert(`✓ Exported ${messages.length} frames successfully!\n\nLoad them into the Static Page Animator to play the animation.`);
        }

        // Pre-generate audio for all messages using Azure REST API and convert to base64
        async function generateEmbeddedAudio() {
            if (!ttsConfig || !ttsConfig.key) {
                return null; // No TTS configured, skip audio generation
            }

            const audioData = [];
            const region = ttsConfig.region || 'eastus2';
            const voiceName = ttsConfig.voiceName || 'en-US-AriaNeural';

            console.log(`Generating audio for ${messages.length} messages...`);

            try {
                for (let i = 0; i < messages.length; i++) {
                    const message = messages[i];
                    if (!message.text) {
                        audioData.push(null);
                        continue;
                    }

                    // Create SSML for the text
                    const ssml = `<speak version='1.0' xml:lang='en-US'>
                        <voice name='${voiceName}'>${escapeXml(message.text)}</voice>
                    </speak>`;

                    // Use Azure TTS REST API
                    const url = `https://${region}.tts.speech.microsoft.com/cognitiveservices/v1`;

                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Ocp-Apim-Subscription-Key': ttsConfig.key,
                                'Content-Type': 'application/ssml+xml',
                                'X-Microsoft-OutputFormat': 'audio-16khz-32kbitrate-mono-mp3'
                            },
                            body: ssml
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        // Get audio as blob
                        const audioBlob = await response.blob();

                        // Convert blob to base64
                        const audioBase64 = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(audioBlob);
                        });

                        audioData.push(audioBase64);
                        console.log(`Generated audio for message ${i + 1}/${messages.length}`);
                    } catch (error) {
                        console.error(`Error generating audio for message ${i + 1}:`, error);
                        audioData.push(null);
                    }
                }

                return audioData;
            } catch (error) {
                console.error('Error generating embedded audio:', error);
                return null;
            }
        }

        // Helper function to escape XML special characters
        function escapeXml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        // Export standalone animated chat as a single HTML file
        async function exportStandaloneAnimation() {
            if (messages.length === 0) {
                alert('Please add at least one message before exporting.');
                return;
            }

            // Ask user if they want to include audio
            let includeAudio = false;
            let audioData = null;

            if (ttsConfig && ttsConfig.key && window.SpeechSDK) {
                includeAudio = confirm('Do you want to include embedded voice narration?\n\nThis will pre-generate audio for all messages (takes a moment) and embed it in the HTML file.\n\nClick OK to include audio, Cancel to skip.');

                if (includeAudio) {
                    const originalBtn = event?.target;
                    if (originalBtn) {
                        originalBtn.disabled = true;
                        originalBtn.textContent = '⏳ Generating Audio...';
                    }

                    audioData = await generateEmbeddedAudio();

                    if (originalBtn) {
                        originalBtn.disabled = false;
                        originalBtn.textContent = '🎬 Export Standalone Animation';
                    }

                    if (!audioData) {
                        alert('Failed to generate audio. Exporting without audio.');
                        includeAudio = false;
                    } else {
                        alert(`✓ Generated audio for ${messages.length} messages!`);
                    }
                }
            }

            // Collect all settings
            const agentBg = document.getElementById('agentBg').value;
            const agentColor = document.getElementById('agentColor').value;
            const agentRadius = document.getElementById('agentRadius').value;
            const agentPadding = document.getElementById('agentPadding').value;

            const customerBg = document.getElementById('customerBg').value;
            const customerColor = document.getElementById('customerColor').value;
            const customerRadius = document.getElementById('customerRadius').value;
            const customerPadding = document.getElementById('customerPadding').value;

            // Get component settings
            const agentShowAvatar = document.getElementById('agentShowAvatar')?.checked || false;
            const agentShowTitle = document.getElementById('agentShowTitle')?.checked || false;
            const agentShowActions = document.getElementById('agentShowActions')?.checked || false;

            const customerShowAvatar = document.getElementById('customerShowAvatar')?.checked || false;
            const customerShowTitle = document.getElementById('customerShowTitle')?.checked || false;
            const customerShowActions = document.getElementById('customerShowActions')?.checked || false;

            const overlayBg = document.getElementById('overlayBg').value;
            const overlayOpacity = document.getElementById('overlayOpacity').value / 100;
            const overlayRadius = document.getElementById('overlayRadius').value;
            const animSpeed = document.getElementById('animSpeed').value;

            // Create standalone animation HTML (same as presentation mode)
            const standaloneHTML = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Animation - Standalone</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
        }
        #background {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        #background iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        #chatOverlay {
            position: absolute;
            left: ${overlayPosition.x}px;
            top: ${overlayPosition.y}px;
            width: ${overlayPosition.width}px;
            height: ${overlayPosition.height}px;
            background: ${overlayBg};
            opacity: ${overlayOpacity};
            border-radius: ${overlayRadius}px;
            overflow-y: auto;
            z-index: 9999;
            padding: 16px;
        }
        .message {
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            display: flex;
            gap: 12px;
            align-items: center;
            backdrop-filter: blur(10px);
            z-index: 99999;
        }
        .controls button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .controls button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .controls button.primary {
            background: #667eea;
            border-color: #667eea;
        }
        .controls button.primary:hover {
            background: #5568d3;
        }
        .frame-counter {
            font-size: 13px;
            padding: 0 12px;
        }
        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        .speed-control input {
            width: 100px;
        }
    </style>
</head>
<body>
    <div id="background">
        ${backgroundHTML ? `<iframe sandbox="allow-same-origin"></iframe>` : `<div style="width: 100%; height: 100%; background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);"></div>`}
    </div>
    <div id="chatOverlay">
        <div id="messages"></div>
    </div>

    <div class="controls">
        <button onclick="prevFrame()">⬅️ Prev</button>
        <button onclick="playPause()" id="playBtn" class="primary">▶️ Play</button>
        <button onclick="nextFrame()">Next ➡️</button>
        <div class="frame-counter" id="frameCounter">Frame 1 / ${messages.length}</div>
        <div class="speed-control">
            <label>Speed:</label>
            <input type="range" id="speedSlider" min="500" max="3000" value="${animSpeed}" step="100" onchange="updateSpeed()">
            <span id="speedVal">${(animSpeed / 1000).toFixed(1)}s</span>
        </div>
        ${includeAudio ? '<button onclick="toggleAudio()" id="audioBtn">🔊 Audio</button>' : ''}
        <button onclick="toggleFullscreen()">⛶ Fullscreen</button>
    </div>

    <script>
        // Data
        const messages = ${JSON.stringify(messages)};
        const audioData = ${includeAudio && audioData ? JSON.stringify(audioData) : 'null'};
        const audioEnabled = ${includeAudio ? 'true' : 'false'};
        const styles = {
            agent: {
                bg: '${agentBg}',
                color: '${agentColor}',
                radius: '${agentRadius}px',
                padding: '${agentPadding}px'
            },
            customer: {
                bg: '${customerBg}',
                color: '${customerColor}',
                radius: '${customerRadius}px',
                padding: '${customerPadding}px'
            }
        };
        const components = {
            agent: {
                showAvatar: ${agentShowAvatar},
                showTitle: ${agentShowTitle},
                showActions: ${agentShowActions}
            },
            customer: {
                showAvatar: ${customerShowAvatar},
                showTitle: ${customerShowTitle},
                showActions: ${customerShowActions}
            }
        };

        let currentFrame = 0;
        let isPlaying = false;
        let playInterval = null;
        let speed = ${animSpeed};
        let currentAudio = null;
        let audioOn = audioEnabled;
        let lastPlayedFrame = -1;

        // Load background if exists
        ${backgroundHTML ? `
        const iframe = document.querySelector('#background iframe');
        const backgroundData = ${JSON.stringify(backgroundHTML)};
        iframe.contentDocument.open();
        iframe.contentDocument.write(backgroundData);
        iframe.contentDocument.close();
        ` : ''}

        // Format message text to avoid wall of text
        function formatMessageText(text) {
            const sentences = text.split(/\\.\\s+/);
            if (sentences.length > 3) {
                const paragraphs = [];
                for (let i = 0; i < sentences.length; i += 2) {
                    const paragraph = sentences.slice(i, i + 2).join('. ');
                    paragraphs.push(paragraph + (paragraph.endsWith('.') ? '' : '.'));
                }
                return paragraphs.map(p => '<p style="margin: 0 0 8px 0; line-height: 1.6;">' + p + '</p>').join('');
            }
            return '<span style="line-height: 1.6;">' + text + '</span>';
        }

        // Render message with components
        function renderMessageComponent(msg) {
            const isAgent = msg.type === 'agent';
            const style = isAgent ? styles.agent : styles.customer;
            const comp = isAgent ? components.agent : components.customer;

            let html = '<div style="display: flex; align-items: flex-start; gap: 12px; max-width: 90%; ' + (!isAgent ? 'margin-left: auto; justify-content: flex-end;' : '') + '">';

            if (isAgent && comp.showAvatar) {
                html += '<div style="width: 32px; height: 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 600;">AI</div>';
            }

            html += '<div style="flex: 1; min-width: 0; ' + (!isAgent ? 'display: flex; flex-direction: column; align-items: flex-end;' : '') + '">';

            if (comp.showTitle) {
                html += '<div style="font-size: 13px; font-weight: 600; color: #616161; margin-bottom: 4px;">' + (isAgent ? 'AI Assistant' : 'You') + '</div>';
            }

            html += '<div style="background-color: ' + style.bg + '; color: ' + style.color + '; border-radius: ' + style.radius + '; padding: ' + style.padding + '; font-size: 14px;">' + formatMessageText(msg.text) + '</div>';

            if (comp.showActions) {
                if (isAgent) {
                    html += '<div style="display: flex; gap: 8px; margin-top: 8px; align-items: center;"><button style="background: none; border: none; cursor: pointer; padding: 4px; opacity: 0.6;">👍</button><button style="background: none; border: none; cursor: pointer; padding: 4px; opacity: 0.6;">👎</button><button style="background: none; border: none; cursor: pointer; padding: 4px; opacity: 0.6;">🔊</button><button style="background: none; border: none; cursor: pointer; padding: 4px; opacity: 0.6;">📋</button></div>';
                } else {
                    html += '<div style="display: flex; gap: 8px; margin-top: 8px; align-items: center;"><button style="background: none; border: none; cursor: pointer; padding: 4px; opacity: 0.6;">✏️</button><button style="background: none; border: none; cursor: pointer; padding: 4px; opacity: 0.6;">🗑️</button></div>';
                }
            }

            html += '</div>';

            if (!isAgent && comp.showAvatar) {
                html += '<div style="width: 32px; height: 32px; background: #e0e0e0; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: #616161; font-size: 14px; font-weight: 600;">U</div>';
            }

            html += '</div>';
            return html;
        }

        // Audio functions
        function playAudio(frameIndex) {
            if (!audioOn || !audioData || !audioData[frameIndex]) return;

            stopAudio();

            try {
                currentAudio = new Audio(audioData[frameIndex]);
                currentAudio.play().catch(err => console.error('Audio playback error:', err));
            } catch (err) {
                console.error('Audio creation error:', err);
            }
        }

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
        }

        function toggleAudio() {
            audioOn = !audioOn;
            const btn = document.getElementById('audioBtn');
            if (btn) {
                btn.textContent = audioOn ? '🔊 Audio' : '🔇 Muted';
            }
            if (!audioOn) {
                stopAudio();
            }
        }

        // Render current frame
        function render() {
            const container = document.getElementById('messages');
            const visibleMessages = messages.slice(0, currentFrame + 1);

            let html = '';
            for (let i = 0; i < visibleMessages.length; i++) {
                const msg = visibleMessages[i];
                html += '<div class="message ' + msg.type + '" style="margin-bottom: 16px;">' + renderMessageComponent(msg) + '</div>';
            }

            container.innerHTML = html;
            document.getElementById('chatOverlay').scrollTop = document.getElementById('chatOverlay').scrollHeight;
            document.getElementById('frameCounter').textContent = 'Frame ' + (currentFrame + 1) + ' / ' + messages.length;

            // Play audio for current frame if not already played
            if (currentFrame !== lastPlayedFrame) {
                lastPlayedFrame = currentFrame;
                playAudio(currentFrame);
            }
        }

        // Playback controls
        function playPause() {
            if (isPlaying) {
                stop();
            } else {
                play();
            }
        }

        function play() {
            isPlaying = true;
            document.getElementById('playBtn').innerHTML = '⏸️ Pause';

            playInterval = setInterval(() => {
                if (currentFrame < messages.length - 1) {
                    currentFrame++;
                    render();
                } else {
                    currentFrame = 0;
                    lastPlayedFrame = -1; // Reset audio tracking when looping
                    render();
                }
            }, speed);
        }

        function stop() {
            isPlaying = false;
            document.getElementById('playBtn').innerHTML = '▶️ Play';
            clearInterval(playInterval);
            stopAudio();
        }

        function prevFrame() {
            stop();
            if (currentFrame > 0) {
                currentFrame--;
                render();
            }
        }

        function nextFrame() {
            stop();
            if (currentFrame < messages.length - 1) {
                currentFrame++;
                render();
            }
        }

        function updateSpeed() {
            speed = parseInt(document.getElementById('speedSlider').value);
            document.getElementById('speedVal').textContent = (speed / 1000).toFixed(1) + 's';

            if (isPlaying) {
                stop();
                play();
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Initial render
        lastPlayedFrame = -1; // Reset audio tracking
        render();

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ') {
                e.preventDefault();
                playPause();
            } else if (e.key === 'ArrowLeft') {
                prevFrame();
            } else if (e.key === 'ArrowRight') {
                nextFrame();
            } else if (e.key === 'f' || e.key === 'F') {
                toggleFullscreen();
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopAudio();
        });
    <\/script>
</body>
</html>`;

            // Create blob and download
            const blob = new Blob([standaloneHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-animation-standalone-${Date.now()}.html`;
            a.click();
            URL.revokeObjectURL(url);

            alert(`✓ Standalone animation exported successfully!\n\nThe file contains:\n• All ${messages.length} messages with animations\n• Complete playback controls\n• Your custom styling\n• Background (if set)\n\nJust open the HTML file to play the animation!`);
        }

        // Save entire project to JSON
        function saveProject() {
            const project = {
                version: "1.0",
                timestamp: new Date().toISOString(),
                projectType: "chat-animation-studio",
                background: {
                    html: backgroundHTML
                },
                styles: {
                    agent: {
                        background: document.getElementById('agentBg').value,
                        color: document.getElementById('agentColor').value,
                        borderRadius: document.getElementById('agentRadius').value,
                        padding: document.getElementById('agentPadding').value
                    },
                    customer: {
                        background: document.getElementById('customerBg').value,
                        color: document.getElementById('customerColor').value,
                        borderRadius: document.getElementById('customerRadius').value,
                        padding: document.getElementById('customerPadding').value
                    },
                    overlay: {
                        background: document.getElementById('overlayBg').value,
                        opacity: document.getElementById('overlayOpacity').value,
                        borderRadius: document.getElementById('overlayRadius').value,
                        position: overlayPosition
                    }
                },
                conversation: {
                    messages: messages,
                    messageCount: messages.length
                },
                animation: {
                    speed: document.getElementById('animSpeed').value
                }
            };

            const jsonString = JSON.stringify(project, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-animation-project-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            const statusDiv = document.getElementById('projectStatus');
            if (statusDiv) {
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = `✓ Project saved successfully! File: chat-animation-project-${Date.now()}.json`;
            }
        }

        // Open presentation mode for screen recording
        function openPresentationMode() {
            // Simply call the existing togglePresenterMode function
            togglePresenterMode();
        }

        // Toggle presenter mode
        function togglePresenterMode() {
            // Go to preview step if not already there
            if (currentStep !== 5) {
                goToStep(5);
            }

            // Add full-screen styles
            document.body.classList.toggle('presenter-mode');

            // You can add additional presentation mode logic here if needed
            alert('Presenter mode toggled! Press F11 for fullscreen, or use the animation controls in Step 5.');
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopSpeaking();
            if (speechSynthesizer) {
                speechSynthesizer.close();
            }
        });

        // (Remaining functions like loadProject, style capture functions, etc. continue unchanged from your original file...)
    </script>

    <!-- Azure Speech SDK for Text-to-Speech -->
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
</body></html>
