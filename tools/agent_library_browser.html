<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Microsoft AI Accelerate - Complete Platform</title>
    <style>
      /* Reset and Base Styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-color: #0078d4;
        --secondary-color: #40e0d0;
        --success-color: #00d4aa;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --dark-bg: #1a1a2e;
        --card-bg: #16213e;
        --text-primary: #333;
        --text-secondary: #666;
        --border-color: #e0e0e0;
        --shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 4px 15px rgba(0, 0, 0, 0.15);
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f5f5;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Main Navigation */
      .main-nav {
        background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
        color: white;
        padding: 1rem 0;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .nav-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nav-brand {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .nav-brand h1 {
        font-size: 1.5rem;
        font-weight: 600;
      }

      .nav-tabs {
        display: flex;
        gap: 0.5rem;
      }

      .nav-tab {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.95rem;
        font-weight: 500;
      }

      .nav-tab:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
      }

      .nav-tab.active {
        background: white;
        color: #0078d4;
      }

      /* App Sections */
      .app-section {
        display: none;
        animation: fadeIn 0.3s ease-in;
      }

      .app-section.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Header Styles */
      header {
        background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
        color: white;
        padding: 2.5rem 0;
        text-align: center;
        margin-bottom: 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .ms-logo {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-bottom: 1rem;
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        font-weight: 300;
        letter-spacing: 1px;
      }

      h2 {
        font-size: 1.8rem;
        color: #0078d4;
        margin-bottom: 1rem;
      }

      h3 {
        font-size: 1.3rem;
        color: #0078d4;
        margin-bottom: 1rem;
      }

      .subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        font-weight: 300;
      }

      /* Common UI Components */
      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-primary {
        background: #0078d4;
        color: white;
      }

      .btn-primary:hover {
        background: #005a9e;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0, 120, 212, 0.3);
      }

      .btn-secondary {
        background: #e0e0e0;
        color: #333;
      }

      .btn-secondary:hover {
        background: #d0d0d0;
      }

      .btn-success {
        background: #00d4aa;
        color: white;
      }

      .btn-success:hover {
        background: #00b090;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3);
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      .btn-warning {
        background: #f59e0b;
        color: white;
      }

      .btn-warning:hover {
        background: #d97706;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
      }

      /* Form Controls */
      input[type="text"],
      input[type="number"],
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 1rem;
        transition: all 0.3s;
        background-color: #fafafa;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #0078d4;
        background-color: white;
        box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
      }

      /* Cards and Sections */
      .card {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
      }

      .info-box {
        background: #e3f2fd;
        border-left: 4px solid #0078d4;
        padding: 1.2rem;
        margin-bottom: 1.8rem;
        border-radius: 6px;
      }

      .info-box p {
        margin: 0;
        color: #1565c0;
        font-size: 0.95rem;
      }

      /* Template Grid */
      .template-grid {
        display: none;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
      }

      /* Template List View Styles */
      .template-list {
        display: none;
      }

      .template-list.active {
        display: block;
      }

      .template-list-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.2s;
        display: flex;
        gap: 1.5rem;
        align-items: start;
      }

      .template-list-item:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transform: translateX(4px);
        border-color: #0078d4;
      }

      .template-list-item.dynamic-stack {
        border: 2px solid #667eea;
        background: linear-gradient(to right, #ffffff, #f8f6ff);
      }

      .template-list-content {
        flex: 1;
        display: grid;
        grid-template-columns: 1.5fr 1fr 0.5fr 200px;
        gap: 1.5rem;
        align-items: center;
      }

      .template-list-main {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .template-list-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #0078d4;
        margin-bottom: 0.25rem;
      }

      .template-list-description {
        color: #666;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .template-list-agents {
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem;
        margin-top: 0.5rem;
      }

      .template-list-meta {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .template-list-stats {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        text-align: center;
      }

      .template-list-actions {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .template-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        transition: all 0.3s;
        cursor: pointer;
        position: relative;
        border: 2px solid transparent;
        overflow: hidden;
      }

      .template-card.dynamic-stack {
        border: 2px solid #667eea;
        background: linear-gradient(to bottom, #ffffff, #f8f6ff);
      }

      .template-card.dynamic-stack:hover {
        border-color: #764ba2;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
      }

      .template-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #0078d4, #40e0d0);
        transform: scaleX(0);
        transition: transform 0.3s ease;
      }

      .template-card:hover::before {
        transform: scaleX(1);
      }

      .template-card:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
        border-color: #0078d4;
      }

      .template-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
      }

      .template-title {
        font-size: 1.3rem;
        color: #0078d4;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .template-description {
        color: #666;
        margin-bottom: 1.5rem;
        line-height: 1.5;
      }

      .template-agents {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
      }

      .template-agents-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #555;
        margin-bottom: 0.75rem;
      }

      .agent-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        background: white;
        border: 1px solid #e0e0e0;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        margin: 0.25rem;
        font-size: 0.85rem;
        color: #555;
      }

      .template-stats {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        padding: 1rem 0;
        border-top: 1px solid #e0e0e0;
        border-bottom: 1px solid #e0e0e0;
      }

      .template-stat {
        text-align: center;
      }

      .template-stat-value {
        font-size: 1.2rem;
        font-weight: 600;
        color: #0078d4;
      }

      .template-stat-label {
        font-size: 0.8rem;
        color: #666;
      }

      /* Agent Store Styles */
      .agent-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 2rem;
      }

      /* View Toggle Styles */
      .view-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .view-toggle {
        display: flex;
        gap: 0.5rem;
        background: #f5f5f5;
        padding: 0.25rem;
        border-radius: 6px;
      }

      .view-btn {
        padding: 0.5rem 1rem;
        background: transparent;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        color: #666;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .view-btn:hover {
        background: rgba(0, 120, 212, 0.1);
        color: #0078d4;
      }

      .view-btn.active {
        background: white;
        color: #0078d4;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* List View Styles */
      .agent-list {
        display: none;
      }

      .agent-list.active {
        display: block;
      }

      .agent-grid.list-view {
        display: none;
      }

      .list-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 0.75rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      .list-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateX(4px);
        border-color: #0078d4;
      }

      .list-item-icon {
        font-size: 2rem;
        min-width: 50px;
        text-align: center;
      }

      .list-item-content {
        flex: 1;
        display: grid;
        grid-template-columns: 2fr 1fr 150px 200px;
        gap: 1.5rem;
        align-items: center;
      }

      .list-item-main {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .list-item-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #0078d4;
      }

      .list-item-description {
        color: #666;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .list-item-meta {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .list-item-category {
        font-size: 0.85rem;
        color: #666;
        background: #f5f5f5;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        text-align: center;
      }

      .list-item-size {
        font-size: 0.85rem;
        color: #999;
        text-align: center;
      }

      .list-item-actions {
        display: flex;
        gap: 0.5rem;
      }

      .list-item-actions .btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
      }

      @media (max-width: 1024px) {
        .list-item-content {
          grid-template-columns: 1fr;
          gap: 0.75rem;
        }

        .list-item-actions {
          justify-content: flex-start;
        }
      }

      .agent-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 16px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .agent-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #0078d4, #40e0d0);
        transform: scaleX(0);
        transition: transform 0.3s ease;
      }

      .agent-card:hover::before {
        transform: scaleX(1);
      }

      .agent-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        border-color: #0078d4;
      }

      .agent-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
      }

      .agent-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }

      .agent-badge {
        background: rgba(64, 224, 208, 0.2);
        color: #40e0d0;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .agent-name {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .agent-description {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        line-height: 1.5;
        min-height: 60px;
      }

      .agent-features {
        list-style: none;
        margin-bottom: 1rem;
        min-height: 100px;
      }

      .agent-features li {
        color: #666;
        font-size: 0.85rem;
        padding: 0.25rem 0;
        padding-left: 1.2rem;
        position: relative;
      }

      .agent-features li::before {
        content: "‚úì";
        position: absolute;
        left: 0;
        color: #00d4aa;
      }

      /* GitHub Repo Info */
      .repo-info {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
        margin-bottom: 2rem;
      }

      .repo-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 500;
        transition: transform 0.2s;
      }

      .repo-link:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      /* Discovery Tool Styles */
      .progress-bar {
        background-color: #e0e0e0;
        height: 8px;
        border-radius: 4px;
        margin-bottom: 2rem;
        overflow: hidden;
      }

      .progress {
        background: linear-gradient(90deg, #00d4aa 0%, #0078d4 100%);
        height: 100%;
        width: 0%;
        transition: width 0.3s ease;
        border-radius: 4px;
      }

      .step {
        display: none;
        background: white;
        padding: 2.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
      }

      .step.active {
        display: block;
        animation: fadeIn 0.3s ease-in;
      }

      .step-header {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid #f0f0f0;
      }

      .step-number {
        display: inline-block;
        background: #0078d4;
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        text-align: center;
        line-height: 35px;
        margin-right: 15px;
        font-weight: bold;
        font-size: 1.1rem;
      }

      /* Cart Sidebar */
      .cart-sidebar {
        position: fixed;
        right: -450px;
        top: 0;
        width: 450px;
        height: 100vh;
        background: white;
        border-left: 1px solid #e0e0e0;
        z-index: 1000;
        transition: right 0.3s ease;
        display: flex;
        flex-direction: column;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      }

      .cart-sidebar.active {
        right: 0;
      }

      .cart-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8f9fa;
      }

      .cart-content {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
      }

      .cart-item {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .cart-footer {
        padding: 1.5rem;
        border-top: 1px solid #e0e0e0;
        background: #f8f9fa;
      }

      /* Loading Overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .loading-overlay.visible {
        opacity: 1;
        pointer-events: all;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #0078d4;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        color: white;
        font-size: 1.2rem;
      }

      /* Toast Notification */
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #333;
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        display: none;
        animation: slideUp 0.3s ease;
        z-index: 3000;
        max-width: 300px;
      }

      .toast.show {
        display: block;
      }

      .toast.success {
        background: #4caf50;
      }

      .toast.error {
        background: #f44336;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* Badges */
      .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
      }

      .badge-complexity-low {
        background: #d4f4dd;
        color: #1e7e34;
      }

      .badge-complexity-medium {
        background: #fff3cd;
        color: #856404;
      }

      .badge-complexity-high {
        background: #f8d7da;
        color: #721c24;
      }

      /* Search and Filter */
      .search-section {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
      }

      .search-box {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .search-input {
        flex: 1;
        padding: 12px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 1rem;
        transition: all 0.3s;
      }

      .search-input:focus {
        outline: none;
        border-color: #0078d4;
        box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
      }

      .filter-section {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 2px solid #f0f0f0;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        min-width: 200px;
      }

      .filter-label {
        font-weight: 600;
        color: #555;
        font-size: 0.9rem;
      }

      .filter-select {
        padding: 8px;
        border: 2px solid #e0e0e0;
        border-radius: 4px;
        font-size: 0.9rem;
        background: white;
        cursor: pointer;
      }

      .filter-btn {
        background: white;
        border: 1px solid #e0e0e0;
        color: #333;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .filter-btn:hover {
        background: #0078d4;
        color: white;
        transform: translateY(-2px);
      }

      .filter-btn.active {
        background: #0078d4;
        color: white;
        border-color: #0078d4;
      }

      /* Action Buttons */
      .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid #f0f0f0;
        flex-wrap: wrap;
      }

      .button-group {
        display: flex;
        justify-content: space-between;
        margin-top: 2.5rem;
        padding-top: 2rem;
        border-top: 2px solid #f0f0f0;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 4rem;
        color: #666;
      }

      .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      .empty-state-title {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: #555;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
      }

      .close-btn:hover {
        background: #f0f0f0;
        color: #333;
      }

      /* Stats Cards */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        text-align: center;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
      }

      /* Code Viewer Modal */
      .code-viewer-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        backdrop-filter: blur(2px);
      }

      .code-viewer-content {
        background: white;
        width: 90%;
        max-width: 1200px;
        height: 90vh;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .code-viewer-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8f9fa;
      }

      .code-viewer-body {
        flex: 1;
        overflow: auto;
        background: #1e1e1e;
        padding: 1.5rem;
      }

      .code-content {
        color: #d4d4d4;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 13px;
        line-height: 1.6;
        white-space: pre;
      }

      /* Python Syntax Highlighting */
      .keyword {
        color: #569cd6;
      }
      .string {
        color: #ce9178;
      }
      .comment {
        color: #6a9955;
      }
      .function {
        color: #dcdcaa;
      }
      .class {
        color: #4ec9b0;
      }
      .number {
        color: #b5cea8;
      }
      .decorator {
        color: #ffd700;
      }
      .self {
        color: #9cdcfe;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        h1 {
          font-size: 2rem;
        }

        .nav-tabs {
          flex-direction: column;
          width: 100%;
        }

        .nav-tab {
          width: 100%;
          text-align: center;
        }

        .template-grid,
        .agent-grid {
          grid-template-columns: 1fr;
        }

        .search-box {
          flex-direction: column;
        }

        .filter-section {
          flex-direction: column;
        }

        .filter-group {
          width: 100%;
        }

        .code-viewer-content {
          width: 95%;
        }

        .action-buttons,
        .button-group {
          flex-direction: column;
        }

        .action-buttons .btn,
        .button-group button {
          width: 100%;
        }

        .cart-sidebar {
          width: 100%;
          right: -100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading...</div>
    </div>

    <!-- Main Navigation -->
    <nav class="main-nav">
      <div class="nav-container">
        <div class="nav-brand">
          <h1>üöÄ Microsoft AI Accelerate</h1>
        </div>
        <div class="nav-tabs">
          <button class="nav-tab" onclick="switchApp('discovery')">
            üîç Discovery Tool
          </button>
          <button class="nav-tab" onclick="switchApp('setup')">
            üöÄ Setup Guide
          </button>
          <button class="nav-tab active" onclick="switchApp('templates')">
            üìö Template Library
          </button>
          <button class="nav-tab" onclick="switchApp('agents')">
            ü§ñ Agent Store
          </button>
        </div>
      </div>
    </nav>

    <!-- Setup Guide Section -->
    <div id="setupApp" class="app-section">
      <div class="container">
        <header>
          <div class="ms-logo">MICROSOFT AI ACCELERATE</div>
          <h1>üöÄ One-Click Azure Setup</h1>
          <p class="subtitle">Deploy your AI agent infrastructure in minutes</p>
        </header>

        <div style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
          <!-- Step 1: Deploy to Azure -->
          <div style="background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%); color: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
            <h2 style="color: white; margin-bottom: 1rem;">Step 1: Deploy to Azure (1 minute)</h2>
            <p style="margin-bottom: 1.5rem; opacity: 0.95;">Click the button below to automatically deploy all required Azure resources including Azure OpenAI, Function App, and Storage.</p>
            <a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fkody-w%2FAI-Agent-Templates%2Fmain%2Fazuredeploy.json" 
               target="_blank"
               style="display: inline-block; background: white; color: #0078d4; padding: 1rem 2rem; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 1.1rem; transition: transform 0.2s;">
              <img src="https://aka.ms/deploytoazurebutton" alt="Deploy to Azure" style="height: 40px;">
            </a>
          </div>

          <!-- Step 2: Test Your Endpoint -->
          <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
            <h2 style="color: #1f2937; margin-bottom: 1rem;">Step 2: Test Your Endpoint</h2>
            <p style="color: #6b7280; margin-bottom: 1rem;">After deployment completes, you'll see "Your deployment is complete" ‚úÖ</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1.5rem;">
              <div>
                <h3 style="color: #374151; font-size: 1.1rem; margin-bottom: 0.5rem;">1. Click "Outputs" Tab</h3>
                <img src="https://raw.githubusercontent.com/kody-w/Copilot-Agent-365/main/docs/images/afterTemplate1.png" 
                     alt="Click Outputs Tab" 
                     style="width: 100%; border: 1px solid #e5e7eb; border-radius: 8px;">
                <p style="color: #6b7280; font-size: 0.9rem; margin-top: 0.5rem;">Find the "Outputs" tab in the left sidebar</p>
              </div>
              
              <div>
                <h3 style="color: #374151; font-size: 1.1rem; margin-bottom: 0.5rem;">2. Copy Your Endpoint URL</h3>
                <img src="https://raw.githubusercontent.com/kody-w/Copilot-Agent-365/main/docs/images/afterTemplate2.png" 
                     alt="Copy Endpoint URL" 
                     style="width: 100%; border: 1px solid #e5e7eb; border-radius: 8px;">
                <p style="color: #6b7280; font-size: 0.9rem; margin-top: 0.5rem;">Copy the functionEndpoint value</p>
              </div>
            </div>

            <div style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin-top: 1.5rem;">
              <h4 style="color: #374151; margin-bottom: 0.5rem;">Test Your Endpoint:</h4>
              <pre style="background: #1f2937; color: #10b981; padding: 1rem; border-radius: 6px; overflow-x: auto; font-size: 0.9rem;">curl -X POST [YOUR_FUNCTION_URL] \
  -H "Content-Type: application/json" \
  -d '{"action": "test", "agent": "basic_agent"}'</pre>
            </div>
          </div>

          <!-- Step 3: Connect to Copilot Studio (Optional) -->
          <div style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
            <h2 style="color: white; margin-bottom: 1rem;">Step 3: Connect to Microsoft 365 Copilot (Optional)</h2>
            <p style="margin-bottom: 1.5rem; opacity: 0.95;">Deploy your AI agents directly into Microsoft Teams and M365 Copilot using our pre-configured Power Platform solution.</p>
            
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <a href="https://github.com/kody-w/AI-Agent-Templates/raw/main/MSFTAIBASMultiAgentCopilot_1_0_0_2.zip" 
                 download="MSFTAIBASMultiAgentCopilot_1_0_0_2.zip"
                 style="display: inline-block; background: white; color: #7c3aed; padding: 1rem 2rem; border-radius: 8px; text-decoration: none; font-weight: 600; transition: transform 0.2s;"
                 onmouseover="this.style.transform='translateY(-2px)'"
                 onmouseout="this.style.transform='translateY(0)'">
                üì¶ Download Power Platform Solution
              </a>
              <button onclick="document.getElementById('copilotInstructions').style.display='block'" 
                      style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                      onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                      onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                üìñ View Setup Instructions
              </button>
            </div>
            
            <!-- Detailed Instructions (Hidden by default) -->
            <div id="copilotInstructions" style="display: none; margin-top: 2rem; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1.5rem;">
              <h3 style="color: white; margin-bottom: 1rem;">üöÄ Quick Setup Guide</h3>
              
              <div style="background: rgba(255,255,255,0.1); border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                <h4 style="color: white; margin-bottom: 0.5rem;">1Ô∏è‚É£ Import Solution to Power Platform</h4>
                <ol style="margin-left: 1.5rem; opacity: 0.95;">
                  <li>Go to <a href="https://make.powerapps.com" target="_blank" style="color: #fbbf24;">make.powerapps.com</a></li>
                  <li>Navigate to Solutions ‚Üí Import solution</li>
                  <li>Upload the downloaded ZIP file</li>
                  <li>Click Next ‚Üí Import</li>
                </ol>
              </div>
              
              <div style="background: rgba(255,255,255,0.1); border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                <h4 style="color: white; margin-bottom: 0.5rem;">2Ô∏è‚É£ Configure Power Automate Connection</h4>
                <ol style="margin-left: 1.5rem; opacity: 0.95;">
                  <li>Open the imported solution</li>
                  <li>Find "Talk to MAC (Migration Assessment Copilot)" flow</li>
                  <li>Edit the flow and update the HTTP action:</li>
                  <li style="margin-top: 0.5rem;">
                    <code style="background: rgba(0,0,0,0.3); padding: 0.5rem; border-radius: 4px; display: block;">
                      URL: [Your Function URL from Step 2]<br>
                      Key: [Your Function Key]
                    </code>
                  </li>
                  <li>Save and turn on the flow</li>
                </ol>
              </div>
              
              <div style="background: rgba(255,255,255,0.1); border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                <h4 style="color: white; margin-bottom: 0.5rem;">3Ô∏è‚É£ Configure Copilot Studio Bot</h4>
                <ol style="margin-left: 1.5rem; opacity: 0.95;">
                  <li>Go to <a href="https://copilotstudio.microsoft.com" target="_blank" style="color: #fbbf24;">Copilot Studio</a></li>
                  <li>Find your imported bot "Agent"</li>
                  <li>Open Topics ‚Üí MAIN topic</li>
                  <li>Verify the Power Automate action is connected</li>
                  <li>Test in the Test pane</li>
                </ol>
              </div>
              
              <div style="background: rgba(255,255,255,0.1); border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                <h4 style="color: white; margin-bottom: 0.5rem;">4Ô∏è‚É£ Deploy to Microsoft 365</h4>
                <ol style="margin-left: 1.5rem; opacity: 0.95;">
                  <li>In Copilot Studio, go to Channels</li>
                  <li>Select "Microsoft Teams"</li>
                  <li>Click "Turn on Teams"</li>
                  <li>For M365 Copilot integration:
                    <ul style="margin-top: 0.5rem;">
                      <li>Enable "Microsoft 365 Copilot" channel</li>
                      <li>Configure declarative agent settings</li>
                      <li>Submit for admin approval if required</li>
                    </ul>
                  </li>
                </ol>
              </div>
              
              <div style="background: #fef3c7; color: #92400e; border-radius: 6px; padding: 1rem; margin-top: 1rem;">
                <strong>‚ö†Ô∏è Prerequisites:</strong>
                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                  <li>Power Platform license (or trial)</li>
                  <li>Copilot Studio license (for M365 integration)</li>
                  <li>Azure Function must be accessible from Power Platform</li>
                  <li>Admin consent may be required for M365 Copilot deployment</li>
                </ul>
              </div>
              
              <button onclick="document.getElementById('copilotInstructions').style.display='none'" 
                      style="margin-top: 1rem; background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                ‚úï Close Instructions
              </button>
            </div>
          </div>

          <!-- Step 4: Choose Your Stack -->
          <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
            <h2 style="color: white; margin-bottom: 1rem;">Step 4: Choose Your Agent Stack</h2>
            <p style="margin-bottom: 1.5rem; opacity: 0.95;">Browse our template library to select and deploy agent stacks for your specific use cases.</p>
            <button onclick="switchApp('templates')" 
                    style="background: white; color: #10b981; border: none; padding: 1rem 2rem; border-radius: 8px; font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: transform 0.2s;"
                    onmouseover="this.style.transform='translateY(-2px)'"
                    onmouseout="this.style.transform='translateY(0)'">
              Browse Template Library ‚Üí
            </button>
          </div>

          <!-- Architecture Overview -->
          <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 2rem; margin-bottom: 2rem;">
            <h3 style="color: #1f2937; margin-bottom: 1rem;">üèóÔ∏è Solution Architecture</h3>
            
            <!-- Mermaid Diagram Container -->
            <div id="architectureDiagram" style="background: #f9fafb; border-radius: 8px; padding: 1.5rem; display: flex; justify-content: center;">
              <pre class="mermaid" style="background: transparent;">
graph TB
    subgraph "User Interface Layer"
        M365[Microsoft 365 Copilot]
        Teams[Microsoft Teams]
        Web[Web Interface]
    end
    
    subgraph "Conversation Layer"
        CS[Copilot Studio<br/>‚Ä¢ Natural Language Processing<br/>‚Ä¢ Conversation Management<br/>‚Ä¢ User Authentication]
    end
    
    subgraph "Integration Layer"
        PA[Power Automate<br/>‚Ä¢ User Context - Office 365<br/>‚Ä¢ Data Transformation<br/>‚Ä¢ Error Handling]
    end
    
    subgraph "Processing Layer"
        AF[Azure Function<br/>‚Ä¢ Agent Selection & Routing<br/>‚Ä¢ Memory Management<br/>‚Ä¢ Azure OpenAI Integration]
    end
    
    subgraph "Agent Layer"
        CRM[CRM Agents<br/>Dynamics/Salesforce]
        DOC[Document Agents<br/>SharePoint/OneDrive]
        EMAIL[Email Agents<br/>Outlook Integration]
        CAL[Calendar Agents<br/>Meeting Management]
        CUSTOM[Custom Agents<br/>Business Logic]
    end
    
    subgraph "Data Layer"
        Storage[(Azure Storage<br/>Agent Memory)]
        OpenAI[Azure OpenAI<br/>GPT-4o]
        CRMData[(CRM Systems<br/>Business Data)]
    end
    
    M365 --> CS
    Teams --> CS
    Web --> CS
    CS --> PA
    PA --> AF
    AF --> CRM
    AF --> DOC
    AF --> EMAIL
    AF --> CAL
    AF --> CUSTOM
    AF <--> Storage
    AF <--> OpenAI
    CRM <--> CRMData
    DOC <--> Storage
    EMAIL <--> Storage
    
    classDef userInterface fill:#eff6ff,stroke:#3b82f6,stroke-width:2px
    classDef conversation fill:#f3e8ff,stroke:#9333ea,stroke-width:2px
    classDef integration fill:#fef3c7,stroke:#f59e0b,stroke-width:2px
    classDef processing fill:#dcfce7,stroke:#22c55e,stroke-width:2px
    classDef agents fill:#fce7f3,stroke:#ec4899,stroke-width:2px
    classDef data fill:#e0e7ff,stroke:#6366f1,stroke-width:2px
    
    class M365,Teams,Web userInterface
    class CS conversation
    class PA integration
    class AF processing
    class CRM,DOC,EMAIL,CAL,CUSTOM agents
    class Storage,OpenAI,CRMData data
              </pre>
            </div>
            
            
            <div style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
              <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 1rem; border-radius: 4px;">
                <strong style="color: #1e40af;">User Interface</strong>
                <p style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem;">Microsoft Teams, M365 Copilot, or custom web interface</p>
              </div>
              <div style="background: #f3e8ff; border-left: 4px solid #9333ea; padding: 1rem; border-radius: 4px;">
                <strong style="color: #581c87;">Conversation Layer</strong>
                <p style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem;">Copilot Studio manages conversations and NLU</p>
              </div>
              <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 4px;">
                <strong style="color: #92400e;">Integration Layer</strong>
                <p style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem;">Power Automate connects systems securely</p>
              </div>
              <div style="background: #dcfce7; border-left: 4px solid #22c55e; padding: 1rem; border-radius: 4px;">
                <strong style="color: #166534;">Processing Layer</strong>
                <p style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem;">Azure Functions execute agent logic</p>
              </div>
            </div>
          </div>

          <!-- Additional Resources -->
          <div style="background: #f9fafb; border-radius: 12px; padding: 2rem;">
            <h3 style="color: #1f2937; margin-bottom: 1rem;">üìö Resources & Documentation</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
              <a href="https://github.com/kody-w/AI-Agent-Templates" target="_blank" 
                 style="background: white; padding: 1rem; border-radius: 8px; text-decoration: none; color: #374151; border: 1px solid #e5e7eb; transition: all 0.2s;"
                 onmouseover="this.style.borderColor='#0078d4'; this.style.transform='translateY(-2px)'"
                 onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'">
                <strong>üìñ GitHub Repository</strong>
                <p style="color: #6b7280; font-size: 0.9rem; margin-top: 0.5rem;">Source code and documentation</p>
              </a>
              
              <a href="https://docs.microsoft.com/azure/azure-functions/" target="_blank"
                 style="background: white; padding: 1rem; border-radius: 8px; text-decoration: none; color: #374151; border: 1px solid #e5e7eb; transition: all 0.2s;"
                 onmouseover="this.style.borderColor='#0078d4'; this.style.transform='translateY(-2px)'"
                 onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'">
                <strong>‚ö° Azure Functions Docs</strong>
                <p style="color: #6b7280; font-size: 0.9rem; margin-top: 0.5rem;">Learn about serverless computing</p>
              </a>
              
              <a href="https://learn.microsoft.com/azure/ai-services/openai/" target="_blank"
                 style="background: white; padding: 1rem; border-radius: 8px; text-decoration: none; color: #374151; border: 1px solid #e5e7eb; transition: all 0.2s;"
                 onmouseover="this.style.borderColor='#0078d4'; this.style.transform='translateY(-2px)'"
                 onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)'">
                <strong>üß† Azure OpenAI Docs</strong>
                <p style="color: #6b7280; font-size: 0.9rem; margin-top: 0.5rem;">AI model documentation</p>
              </a>
            </div>
          </div>

          <!-- Deployment Details -->
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 2rem; margin-top: 2rem;">
            <h3 style="color: #1f2937; margin-bottom: 1rem;">üîß What Gets Deployed</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
              <div>
                <strong style="color: #0078d4;">Azure OpenAI</strong>
                <p style="color: #6b7280; font-size: 0.9rem;">GPT-4o model deployment</p>
              </div>
              <div>
                <strong style="color: #0078d4;">Function App</strong>
                <p style="color: #6b7280; font-size: 0.9rem;">Serverless compute</p>
              </div>
              <div>
                <strong style="color: #0078d4;">Storage Account</strong>
                <p style="color: #6b7280; font-size: 0.9rem;">Agent memory & files</p>
              </div>
              <div>
                <strong style="color: #0078d4;">App Insights</strong>
                <p style="color: #6b7280; font-size: 0.9rem;">Monitoring & analytics</p>
              </div>
            </div>
            
            <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 1rem; margin-top: 1.5rem;">
              <strong style="color: #92400e;">üí∞ Estimated Cost:</strong>
              <span style="color: #78350f;">~$5-10/month base + OpenAI usage (~$0.01 per 1K tokens)</span>
            </div>
          </div>

          <!-- Troubleshooting -->
          <details style="background: #f9fafb; border-radius: 12px; padding: 1rem; margin-top: 2rem;">
            <summary style="cursor: pointer; font-weight: 600; color: #1f2937; padding: 0.5rem;">
              ‚ùì Troubleshooting & FAQ
            </summary>
            <div style="margin-top: 1rem; padding-left: 1rem;">
              <div style="margin-bottom: 1rem;">
                <strong style="color: #374151;">Deployment fails with "quota exceeded"</strong>
                <p style="color: #6b7280; font-size: 0.9rem;">Try a different region or request a quota increase in Azure Portal</p>
              </div>
              <div style="margin-bottom: 1rem;">
                <strong style="color: #374151;">Function returns 401 Unauthorized</strong>
                <p style="color: #6b7280; font-size: 0.9rem;">Make sure you're using the function key from the Azure Portal</p>
              </div>
              <div style="margin-bottom: 1rem;">
                <strong style="color: #374151;">How do I add custom agents?</strong>
                <p style="color: #6b7280; font-size: 0.9rem;">Deploy agent code to your Function App via GitHub Actions or Azure DevOps</p>
              </div>
            </div>
          </details>
        </div>
      </div>
    </div>

    <!-- Template Library Section -->
    <div id="templatesApp" class="app-section active">
      <div class="container">
        <header style="background: linear-gradient(135deg, #4f6fc4 0%, #3b5998 100%); 
                       color: white; 
                       padding: 1.5rem; 
                       border-radius: 12px; 
                       margin-bottom: 1.5rem;
                       box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 0.75rem; 
                          letter-spacing: 0.15em; 
                          text-transform: uppercase; 
                          opacity: 0.9;
                          font-weight: 500;">Microsoft AI Accelerate</div>
              <h1 style="font-size: 2rem; 
                         margin: 0.5rem 0 0 0; 
                         font-weight: 600;
                         text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                üöÄ Agentic Template Library
              </h1>
            </div>
            <button
              class="btn"
              onclick="agentStore.toggleCart()"
              style="background: rgba(255, 255, 255, 0.2);
                     backdrop-filter: blur(10px);
                     border: 1px solid rgba(255, 255, 255, 0.3);
                     color: white;
                     padding: 0.75rem 1.5rem;
                     border-radius: 8px;
                     display: inline-flex; 
                     align-items: center; 
                     gap: 0.5rem;
                     transition: all 0.3s ease;
                     cursor: pointer;
                     font-weight: 500;"
              onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'"
              onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'"
            >
              <span>üõí</span>
              <span class="badge" id="templateCartCount" style="background: #ff6b6b; padding: 0.25rem 0.5rem; border-radius: 12px;">0</span>
              <span>My Stack</span>
            </button>
          </div>
        </header>

        <!-- Industry Filter -->
        <div class="industry-filter-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 1.25rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); border: 1px solid #e0e0e0;">
          <h3 style="margin-bottom: 0.75rem; color: #0078d4; font-size: 1.2rem;">üè¢ Select Your Industry</h3>
          <div id="industryButtons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-bottom: 1rem;">
            <!-- Industry buttons will be dynamically added here -->
          </div>
          <div style="text-align: center; margin-top: 1rem;">
            <button class="btn btn-secondary" onclick="templateManager.clearIndustryFilter()" style="padding: 0.5rem 1.5rem;">
              <span>üåê</span> Show All Industries
            </button>
          </div>
        </div>


        <!-- Search and Filter -->
        <div class="search-section" style="padding: 0.75rem; background: white; border-radius: 8px; margin-bottom: 1rem;">
          <h4 style="margin-bottom: 0.75rem; font-size: 1rem; color: #666;">Refine Your Search</h4>
          <div class="search-box">
            <input
              type="text"
              class="search-input"
              id="templateSearchInput"
              placeholder="Search templates by name, description, or use case..."
            />
            <button
              class="btn btn-primary"
              onclick="templateManager.searchTemplates()"
            >
              üîç Search
            </button>
            <button
              class="btn btn-secondary"
              onclick="templateManager.resetFilters()"
            >
              ‚Ü∫ Reset
            </button>
          </div>

          <div class="filter-section">
            <div class="filter-group">
              <label class="filter-label">Use Case</label>
              <select
                class="filter-select"
                id="useCaseFilter"
                onchange="templateManager.filterTemplates()"
              >
                <option value="">All Use Cases</option>
                <option value="communication">Communication</option>
                <option value="productivity">Productivity</option>
                <option value="analytics">Analytics</option>
                <option value="customer-service">Customer Service</option>
                <option value="development">Development</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Complexity</label>
              <select
                class="filter-select"
                id="complexityFilter"
                onchange="templateManager.filterTemplates()"
              >
                <option value="">All Complexities</option>
                <option value="starter">Starter (2-3 agents)</option>
                <option value="intermediate">Intermediate (4-5 agents)</option>
                <option value="advanced">Advanced (6+ agents)</option>
              </select>
            </div>
          </div>
        </div>

        <div class="template-grid" id="templateGrid" style="display: none;">
          <!-- Templates will be dynamically loaded here -->
        </div>

        <!-- Template List View -->
        <div class="template-list active" id="templateList">
          <!-- List items will be dynamically loaded here -->
        </div>

        <div class="empty-state" id="templateEmptyState" style="display: none">
          <div class="empty-state-icon">üîç</div>
          <div class="empty-state-title">No Templates Found</div>
        </div>
      </div>
    </div>

    <!-- Discovery Tool Section -->
    <div id="discoveryApp" class="app-section">
      <div class="container">
        <header>
          <div class="ms-logo">MICROSOFT AI ACCELERATE</div>
          <h1>AI Use Case Discovery Tool</h1>
          <p class="subtitle">Identify High-Impact AI Opportunities</p>
        </header>

        <div class="progress-bar">
          <div class="progress" id="progressBar"></div>
        </div>

        <!-- Step 1: Business Context -->
        <div class="step active" id="disc-step1">
          <div class="step-header">
            <span class="step-number">1</span>
            <h2 style="display: inline-block">Business Overview</h2>
          </div>

          <div class="info-box">
            <p>
              Let's understand your business context to identify AI
              opportunities.
            </p>
          </div>

          <div class="form-group">
            <label for="companyName">Company Name</label>
            <input
              type="text"
              id="companyName"
              placeholder="Enter your company name"
            />
          </div>

          <div class="form-group">
            <label for="industry">Primary Industry</label>
            <select id="industry">
              <option value="">Select your industry</option>
              <option value="financial">Financial Services</option>
              <option value="healthcare">Healthcare</option>
              <option value="retail">Retail & E-commerce</option>
              <option value="manufacturing">Manufacturing</option>
              <option value="technology">Technology</option>
            </select>
          </div>

          <div class="button-group">
            <div></div>
            <button class="btn btn-primary" onclick="discoveryTool.nextStep()">
              Next: Identify Processes
            </button>
          </div>
        </div>

        <!-- Step 2: Process Identification -->
        <div class="step" id="disc-step2">
          <div class="step-header">
            <span class="step-number">2</span>
            <h2 style="display: inline-block">Process Identification</h2>
          </div>

          <div class="info-box">
            <p>Select the key processes you'd like to optimize with AI.</p>
          </div>

          <div class="button-group">
            <button
              class="btn btn-secondary"
              onclick="discoveryTool.previousStep()"
            >
              Previous
            </button>
            <button
              class="btn btn-success"
              onclick="discoveryTool.calculateResults()"
            >
              Generate AI Use Cases
            </button>
          </div>
        </div>

        <!-- Results -->
        <div class="step" id="disc-results">
          <div class="card">
            <h2>Recommended Agent Stacks for Your Industry</h2>
            <div id="recommendedStacks"></div>
            <div class="button-group">
              <button class="btn btn-secondary" onclick="location.reload()">
                Start Over
              </button>
              <button class="btn btn-primary" onclick="switchApp('templates')">
                Browse All Templates
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Agent Store Section -->
    <div id="agentsApp" class="app-section">
      <div class="container">
        <header>
          <div class="ms-logo">MICROSOFT AI ACCELERATE</div>
          <h1>ü§ñ AI Agent Store</h1>
          <p class="subtitle">Enterprise-Ready AI Agents from GitHub</p>
          <div style="text-align: center; margin-top: 1rem">
            <button
              class="btn btn-primary"
              onclick="agentStore.toggleCart()"
              style="display: inline-flex"
            >
              <span>üõí</span>
              <span class="badge" id="cartCount">0</span>
              <span>My Stack</span>
            </button>
          </div>
        </header>

        <!-- GitHub Repository Info -->
        <div class="repo-info">
          <a
            href="https://github.com/kody-w/AI-Agent-Templates"
            target="_blank"
            class="repo-link"
          >
            <svg height="20" width="20" viewBox="0 0 16 16" fill="currentColor">
              <path
                d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"
              ></path>
            </svg>
            View on GitHub
          </a>
          <button class="btn btn-warning" onclick="agentStore.refreshAgents()">
            üîÑ Refresh List
          </button>
          <span style="color: #666"
            >Fetching agents directly from GitHub repository</span
          >
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalAgents">0</div>
            <div class="stat-label">Total Agents</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="filteredAgents">0</div>
            <div class="stat-label">Filtered</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="cartAgents">0</div>
            <div class="stat-label">In Cart</div>
          </div>
        </div>

        <!-- Search and Filter -->
        <div class="search-section">
          <div class="search-box">
            <input
              type="text"
              class="search-input"
              id="agentSearchInput"
              placeholder="Search agents by name or description..."
            />
            <button class="btn btn-primary" onclick="agentStore.searchAgents()">
              üîç Search
            </button>
          </div>
        </div>

        <!-- Category Filter -->
        <div
          style="
            background: #f8f9fa;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            border-radius: 10px;
          "
        >
          <div
            style="
              display: flex;
              gap: 1rem;
              flex-wrap: wrap;
              justify-content: center;
            "
          >
            <button
              class="filter-btn active"
              data-category="all"
              onclick="agentStore.filterAgents('all')"
            >
              All Agents
            </button>
            <button
              class="filter-btn"
              data-category="communication"
              onclick="agentStore.filterAgents('communication')"
            >
              üí¨ Communication
            </button>
            <button
              class="filter-btn"
              data-category="productivity"
              onclick="agentStore.filterAgents('productivity')"
            >
              ‚ö° Productivity
            </button>
            <button
              class="filter-btn"
              data-category="analytics"
              onclick="agentStore.filterAgents('analytics')"
            >
              üìä Analytics
            </button>
            <button
              class="filter-btn"
              data-category="automation"
              onclick="agentStore.filterAgents('automation')"
            >
              üîß Automation
            </button>
            <button
              class="filter-btn"
              data-category="integration"
              onclick="agentStore.filterAgents('integration')"
            >
              üîó Integration
            </button>
          </div>
        </div>


        <!-- Agent Grid -->
        <div class="agent-grid" id="agentGrid" style="display: none;">
          <!-- Agent cards will be dynamically loaded here -->
        </div>

        <!-- Agent List View -->
        <div class="agent-list active" id="agentList">
          <!-- List items will be dynamically loaded here -->
        </div>

        <div class="empty-state" id="agentEmptyState" style="display: none">
          <div class="empty-state-icon">ü§ñ</div>
          <div class="empty-state-title">No Agents Found</div>
          <p>Loading agents from GitHub repository...</p>
        </div>
      </div>
    </div>

    <!-- Cart Sidebar -->
    <div class="cart-sidebar" id="cartSidebar">
      <div class="cart-header">
        <h2>üõí Your Agent Stack</h2>
        <button class="close-btn" onclick="agentStore.toggleCart()">‚úï</button>
      </div>

      <div class="cart-content">
        <div id="cartItems"></div>
        <div class="empty-state" id="cartEmpty">
          <p>Your cart is empty</p>
        </div>
      </div>

      <div class="cart-footer" id="cartFooter" style="display: none">
        <div style="margin-bottom: 1rem">
          <div
            style="
              display: flex;
              justify-content: space-between;
              padding: 0.5rem 0;
            "
          >
            <span>Total Agents:</span>
            <span id="totalCartAgents">0</span>
          </div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 0.5rem">
          <button class="btn btn-primary" onclick="agentStore.downloadAll()">
            üì• Download All
          </button>
          <button class="btn btn-secondary" onclick="agentStore.clearCart()">
            Clear Cart
          </button>
        </div>
      </div>
    </div>

    <!-- Code Viewer Modal -->
    <div class="code-viewer-modal" id="codeViewerModal">
      <div class="code-viewer-content">
        <div class="code-viewer-header">
          <h2 id="codeViewerTitle">Agent Code</h2>
          <div style="display: flex; gap: 1rem">
            <button class="btn btn-success" onclick="agentStore.copyCode()">
              üìã Copy Code
            </button>
            <button
              class="btn btn-primary"
              onclick="agentStore.downloadCurrentAgent()"
            >
              üíæ Download
            </button>
            <button class="close-btn" onclick="agentStore.closeCodeViewer()">
              ‚úï
            </button>
          </div>
        </div>
        <div class="code-viewer-body">
          <pre class="code-content" id="codeContent"></pre>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
      // Global state
      let currentApp = "templates";

      // Switch between apps
      function switchApp(app) {
        currentApp = app;

        // Update navigation
        document.querySelectorAll(".nav-tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.classList.add("active");

        // Hide all sections
        document.querySelectorAll(".app-section").forEach((section) => {
          section.classList.remove("active");
        });

        // Show selected section
        if (app === "setup") {
          document.getElementById("setupApp").classList.add("active");
          // Re-render Mermaid diagrams when showing setup tab
          if (typeof mermaid !== 'undefined') {
            setTimeout(() => {
              mermaid.init(undefined, document.querySelectorAll('#setupApp .mermaid'));
            }, 100);
          }
        } else if (app === "templates") {
          document.getElementById("templatesApp").classList.add("active");
          if (!templateManager.templatesLoaded) {
            templateManager.loadTemplates();
          }
        } else if (app === "discovery") {
          document.getElementById("discoveryApp").classList.add("active");
        } else if (app === "agents") {
          document.getElementById("agentsApp").classList.add("active");
          if (agentStore.agents.length === 0) {
            agentStore.loadAgents();
          }
        }
      }

      // Template Manager
      class TemplateManager {
        constructor() {
          this.templatesLoaded = false;
          this.agentTemplates = [];
          this.filteredTemplates = [];
          this.dynamicStacks = [];
          this.currentView = "list";
          this.industries = new Map();
          this.selectedIndustry = null;
        }

        async loadTemplates() {
          // First ensure agents are loaded
          if (agentStore.agents.length === 0) {
            await agentStore.loadAgents();
          }

          // Load dynamic stacks from GitHub FIRST and wait for completion
          await this.loadDynamicStacks();
          
          // Define hardcoded templates
          const hardcodedTemplates = [
            {
              id: "basic-starter",
              name: "Basic Starter Pack",
              description:
                "Essential memory-enhanced agents for getting started with AI automation. Includes basic functionality with context retention.",
              useCase: "productivity",
              complexity: "starter",
              estimatedTime: "1 week",
              industry: "Cross-Industry",
              agents: [
                "basic_agent", // References basic_agent.py
                "context_memory_agent", // References context_memory_agent.py
                "manage_memory_agent", // References manage_memory_agent.py
              ],
              benefits: [
                "Quick deployment",
                "Memory and context retention",
                "Easy to customize",
                "Immediate value",
              ],
            },
            {
              id: "email-automation",
              name: "Email Automation Suite",
              description:
                "Complete email management solution with drafting capabilities and memory features.",
              useCase: "communication",
              complexity: "starter",
              estimatedTime: "1-2 weeks",
              industry: "Cross-Industry",
              agents: [
                "email_drafting_agent", // References email_drafting_agent.py
                "context_memory_agent", // References context_memory_agent.py
                "manage_memory_agent", // References manage_memory_agent.py
              ],
              benefits: [
                "Automated email drafting",
                "Context-aware responses",
                "Memory of past interactions",
                "Efficient communication",
              ],
            },
            {
              id: "document-processing",
              name: "Document Processing Suite",
              description:
                "Advanced document extraction and generation with SharePoint integration.",
              useCase: "productivity",
              complexity: "intermediate",
              estimatedTime: "2-3 weeks",
              industry: "Cross-Industry",
              agents: [
                "extract_sharepoint_document_url_agent", // References extract_sharepoint_document_url_agent.py
                "image_generation_agent", // References image_generation_agent.py
                "powerpoint_agent", // References powerpoint_agent.py
                "context_memory_agent", // References context_memory_agent.py
              ],
              benefits: [
                "SharePoint integration",
                "Document extraction",
                "Image generation",
                "PowerPoint automation",
              ],
            },
            {
              id: "microsoft-365-suite",
              name: "Microsoft 365 Integration Pack",
              description:
                "Full Microsoft 365 integration with Dynamics, PowerPoint, and SharePoint.",
              useCase: "productivity",
              complexity: "advanced",
              estimatedTime: "3-4 weeks",
              industry: "Cross-Industry",
              agents: [
                "dynamics_365_agent", // References dynamics_365_agent.py
                "powerpoint_agent", // References powerpoint_agent.py
                "extract_sharepoint_document_url_agent", // References extract_sharepoint_document_url_agent.py
                "context_memory_agent", // References context_memory_agent.py
                "manage_memory_agent", // References manage_memory_agent.py
              ],
              benefits: [
                "Complete MS 365 integration",
                "CRM connectivity",
                "Document management",
                "Enterprise-ready",
              ],
            },
            {
              id: "news-monitoring",
              name: "News & Content Monitoring",
              description:
                "Stay updated with automated news aggregation and adaptive content display.",
              useCase: "analytics",
              complexity: "starter",
              estimatedTime: "1 week",
              industry: "Cross-Industry",
              agents: [
                "hacker_news_agent", // References hacker_news_agent.py
                "adaptive_card_agent", // References adaptive_card_agent.py
                "context_memory_agent", // References context_memory_agent.py
              ],
              benefits: [
                "Real-time news monitoring",
                "Adaptive content display",
                "Contextual awareness",
                "Automated updates",
              ],
            },
            {
              id: "creative-suite",
              name: "Creative Content Suite",
              description:
                "Image generation and presentation creation tools for creative teams.",
              useCase: "communication",
              complexity: "intermediate",
              estimatedTime: "2-3 weeks",
              industry: "Cross-Industry",
              agents: [
                "image_generation_agent", // References image_generation_agent.py
                "powerpoint_agent", // References powerpoint_agent.py
                "adaptive_card_agent", // References adaptive_card_agent.py
                "email_drafting_agent", // References email_drafting_agent.py
              ],
              benefits: [
                "AI-powered image creation",
                "Presentation automation",
                "Adaptive content formatting",
                "Creative workflow optimization",
              ],
            },
            {
              id: "enterprise-complete",
              name: "Enterprise Complete Stack",
              description:
                "Full enterprise solution with all available agents for maximum capability.",
              useCase: "productivity",
              complexity: "advanced",
              estimatedTime: "4-6 weeks",
              industry: "Cross-Industry",
              agents: [
                "basic_agent",
                "context_memory_agent",
                "manage_memory_agent",
                "dynamics_365_agent",
                "email_drafting_agent",
                "extract_sharepoint_document_url_agent",
                "image_generation_agent",
                "powerpoint_agent",
                "hacker_news_agent",
                "adaptive_card_agent",
              ],
              benefits: [
                "Complete functionality",
                "All integrations included",
                "Maximum automation",
                "Enterprise scalability",
              ],
            },
          ];

          // Combine hardcoded templates with dynamic stacks that were loaded
          this.agentTemplates = [...hardcodedTemplates, ...this.dynamicStacks];
          console.log(`Total templates after combining: ${this.agentTemplates.length} (7 hardcoded + ${this.dynamicStacks.length} dynamic)`);
          
          // Sort templates by data completeness (most complete first)
          this.agentTemplates.sort((a, b) => {
            // Calculate completeness score for each template
            const getCompletenessScore = (template) => {
              let score = 0;
              
              // Has demo available (highest priority)
              if (template.demo && template.demo.available) score += 100;
              
              // Has live mode capability
              if (template.hasLiveMode) score += 50;
              
              // Has downloadable files
              if (template.files && template.files.length > 0) score += 30;
              
              // Has detailed metadata
              if (template.features && template.features.length > 0) score += 20;
              if (template.benefits && template.benefits.length > 0) score += 15;
              if (template.technicalRequirements) score += 15;
              
              // Has multiple agents
              if (template.agents && template.agents.length > 3) score += 10;
              else if (template.agents && template.agents.length > 0) score += 5;
              
              // Has components defined
              if (template.components && template.components.length > 0) score += 10;
              
              // Has use case and complexity defined
              if (template.useCase) score += 5;
              if (template.complexity) score += 5;
              
              // Is a dynamic stack (loaded from GitHub)
              if (template.isDynamic) score += 10;
              
              return score;
            };
            
            const scoreA = getCompletenessScore(a);
            const scoreB = getCompletenessScore(b);
            
            // Sort by score (highest first), then by name
            if (scoreA !== scoreB) {
              return scoreB - scoreA;
            }
            return a.name.localeCompare(b.name);
          });
          
          this.filteredTemplates = [...this.agentTemplates];
          this.templatesLoaded = true;
          
          // Build industry map for filtering
          this.buildIndustryMap();
          
          // Check for saved industry preference
          const savedIndustry = localStorage.getItem('selectedIndustry');
          if (savedIndustry && this.industries.has(savedIndustry)) {
            this.filterByIndustry(savedIndustry);
          } else {
            this.renderTemplates(this.filteredTemplates);
            this.renderIndustryButtons();
          }
        }

        async loadDynamicStacks() {
          try {
            // Wait a bit for agentStore to fully initialize if needed
            if (!agentStore.stacksManifest && window.agentStore) {
              await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Check for pending manifest that might not have been shared yet
            if (!this.stacksManifest && window.pendingStacksManifest) {
              this.stacksManifest = window.pendingStacksManifest;
              console.log(`Retrieved ${this.stacksManifest.length} pending stacks from window`);
            }
            
            // First try to use manifest data if available (check all sources)
            const manifestStacks = this.stacksManifest || 
                                  agentStore.stacksManifest || 
                                  (window.agentStore && window.agentStore.stacksManifest) ||
                                  window.pendingStacksManifest;
            
            console.log('Checking for manifest stacks:', {
              'this.stacksManifest': this.stacksManifest ? this.stacksManifest.length : 'none',
              'agentStore.stacksManifest': agentStore.stacksManifest ? agentStore.stacksManifest.length : 'none',
              'window.agentStore': window.agentStore ? (window.agentStore.stacksManifest ? window.agentStore.stacksManifest.length : 'none') : 'no window.agentStore',
              'window.pendingStacksManifest': window.pendingStacksManifest ? window.pendingStacksManifest.length : 'none'
            });
            
            if (manifestStacks && manifestStacks.length > 0) {
              console.log(`Loading ${manifestStacks.length} stacks from manifest`);
              this.loadStacksFromManifest(manifestStacks);
              return;
            }
            
            // Fallback to API calls if manifest not available
            const apiUrl = `https://api.github.com/repos/${agentStore.GITHUB_REPO}/contents/${agentStore.STACKS_PATH}?ref=${agentStore.BRANCH}`;
            const response = await fetch(apiUrl);

            if (response.status === 403) {
              console.warn("GitHub API rate limit reached. Using static stacks only.");
              return;
            }

            if (!response.ok) {
              console.error("Failed to load dynamic stacks");
              return;
            }

            const stackDirs = await response.json();
            this.dynamicStacks = [];

            // Process each stack directory
            for (const stackDir of stackDirs) {
              if (stackDir.type === "dir") {
                const stackTemplate = await this.createStackTemplate(stackDir);
                if (stackTemplate) {
                  this.dynamicStacks.push(stackTemplate);
                }
              }
            }
          } catch (error) {
            console.error("Error loading dynamic stacks:", error);
          }
        }

        loadStacksFromManifest(stacksData) {
          this.dynamicStacks = [];
          console.log(`Processing ${stacksData.length} stacks from manifest`);
          
          for (const stack of stacksData) {
            // Extract files list from manifest or detect from stack structure
            let filesList = [];
            if (stack.files && stack.files.length > 0) {
              filesList = stack.files.filter(f => 
                f.endsWith('.zip') || 
                f.endsWith('.html') || 
                f.endsWith('.json') ||
                f.endsWith('.xml')
              ).map(f => f.split('/').pop());
            }
            
            const template = {
              id: stack.id,
              name: stack.metadata?.name || this.formatStackName(stack.id),
              description: stack.metadata?.description || `Complete ${stack.name} solution`,
              longDescription: stack.metadata?.longDescription,
              category: stack.metadata?.category || 'general',
              complexity: stack.metadata?.complexity || 'intermediate',
              estimatedTime: stack.metadata?.estimatedSetupTime || '1-2 weeks',
              agents: stack.agents.map(a => a.id),
              benefits: stack.metadata?.benefits || [],
              features: stack.metadata?.features || [],
              useCases: stack.metadata?.useCases,
              technicalRequirements: stack.metadata?.technicalRequirements,
              components: stack.metadata?.components,
              demo: stack.metadata?.demo,
              files: filesList,  // Add files list
              isDynamic: true,
              stackPath: stack.id,
              hasMetadata: !!stack.metadata,
              industry: stack.industry || 'General',
              manifestData: stack  // Store the full manifest data for later use
            };
            
            this.dynamicStacks.push(template);
            
            // Also add stack agents to agentStore if not already there
            if (stack.agents && stack.agents.length > 0) {
              stack.agents.forEach(agent => {
                if (!agentStore.agents.find(a => a.id === agent.id)) {
                  agentStore.agents.push(agent);
                }
              });
            }
          }
          
          console.log(`Loaded ${this.dynamicStacks.length} stacks from manifest`);
        }

        async createStackTemplate(stackDir, loadAgents = false) {
          try {
            let metadata = null;
            
            // Try to fetch metadata.json for the stack
            const metadataUrl = `https://api.github.com/repos/${agentStore.GITHUB_REPO}/contents/${stackDir.path}/metadata.json?ref=${agentStore.BRANCH}`;
            try {
              const metadataResponse = await fetch(metadataUrl);
              if (metadataResponse.ok) {
                const metadataFile = await metadataResponse.json();
                // Decode base64 content
                const decodedContent = atob(metadataFile.content);
                metadata = JSON.parse(decodedContent);
              }
            } catch (error) {
              console.log(`No metadata.json found for ${stackDir.name}, using defaults`);
            }

            const stackName = this.formatStackName(stackDir.name);
            let agentIds = [];
            
            // Only load agents if explicitly requested (lazy loading)
            if (loadAgents) {
              // Check for agents subdirectory
              const agentsUrl = `https://api.github.com/repos/${agentStore.GITHUB_REPO}/contents/${stackDir.path}/agents?ref=${agentStore.BRANCH}`;
              const agentsResponse = await fetch(agentsUrl);
              
              if (agentsResponse.ok) {
                const agentFiles = await agentsResponse.json();
                const pythonAgentIds = agentFiles
                  .filter(file => file.name.endsWith(".py") && file.name !== "__init__.py")
                  .map(file => `${stackDir.name}_${file.name.replace(".py", "")}`);
                agentIds.push(...pythonAgentIds);
              }
              
              // Also check for Python files in the root of the stack directory
              const rootUrl = `https://api.github.com/repos/${agentStore.GITHUB_REPO}/contents/${stackDir.path}?ref=${agentStore.BRANCH}`;
              const rootResponse = await fetch(rootUrl);
              
              if (rootResponse.ok) {
                const rootFiles = await rootResponse.json();
                const rootPythonIds = rootFiles
                  .filter(file => file.type === "file" && file.name.endsWith(".py") && file.name !== "__init__.py")
                  .map(file => `${stackDir.name}_${file.name.replace(".py", "")}`);
                agentIds.push(...rootPythonIds);
              }
            } else {
              // Use agent list from metadata if available
              if (metadata && metadata.components) {
                agentIds = metadata.components.map(c => `${stackDir.name}_${c.name.replace(".py", "")}`);
              }
            }

            if (agentIds.length === 0 && !metadata) return null;

            // Check for additional files in the stack
            let filesList = [];
            if (metadata && metadata.files) {
              filesList = metadata.files;
            } else {
              // Try to detect files in the files directory
              try {
                const filesUrl = `https://api.github.com/repos/${agentStore.GITHUB_REPO}/contents/${stackDir.path}/files?ref=${agentStore.BRANCH}`;
                const filesResponse = await fetch(filesUrl);
                if (filesResponse.ok) {
                  const files = await filesResponse.json();
                  filesList = files.filter(f => f.type === 'file').map(f => f.name);
                }
              } catch (err) {
                // Files directory might not exist
              }
            }
            
            // Use metadata if available, otherwise use defaults
            if (metadata) {
              return {
                id: stackDir.name,
                name: metadata.name || `${stackName} Stack`,
                description: metadata.description || `Complete ${stackName} solution with ${agentIds.length} integrated agents`,
                longDescription: metadata.longDescription,
                useCase: metadata.category || this.determineStackUseCase(stackDir.name),
                complexity: metadata.complexity || "intermediate",
                estimatedTime: metadata.estimatedSetupTime || `${Math.ceil(agentIds.length / 2)} weeks`,
                agents: agentIds,
                benefits: metadata.benefits || [
                  `${agentIds.length} specialized agents`,
                  "Pre-integrated solution",
                  "Ready to deploy",
                  "GitHub-sourced",
                ],
                features: metadata.features,
                useCases: metadata.useCases,
                technicalRequirements: metadata.technicalRequirements,
                components: metadata.components,
                architecture: metadata.architecture,
                deployment: metadata.deployment,
                security: metadata.security,
                performance: metadata.performance,
                support: metadata.support,
                pricing: metadata.pricing,
                changelog: metadata.changelog,
                screenshots: metadata.screenshots,
                videos: metadata.videos,
                relatedStacks: metadata.relatedStacks,
                tags: metadata.tags,
                version: metadata.version,
                author: metadata.author,
                demo: metadata.demo,
                files: filesList,  // Add files list
                isDynamic: true,
                stackPath: stackDir.name,
                hasMetadata: true,
                agentsLoaded: loadAgents  // Track if agents were loaded
              };
            } else {
              // Fallback to default template creation
              let complexity = "starter";
              if (agentIds.length > 5) complexity = "advanced";
              else if (agentIds.length > 3) complexity = "intermediate";

              return {
                id: stackDir.name,
                name: `${stackName} Stack`,
                description: `Complete ${stackName} solution with ${agentIds.length} integrated agents`,
                useCase: this.determineStackUseCase(stackDir.name),
                complexity: complexity,
                estimatedTime: `${Math.ceil(agentIds.length / 2)} weeks`,
                agents: agentIds,
                benefits: [
                  `${agentIds.length} specialized agents`,
                  "Pre-integrated solution",
                  "Ready to deploy",
                  "GitHub-sourced",
                ],
                files: filesList,  // Add files list even for fallback
                isDynamic: true,
                stackPath: stackDir.name,
                hasMetadata: false,
                agentsLoaded: loadAgents  // Track if agents were loaded
              };
            }
          } catch (error) {
            console.error(`Error creating stack template for ${stackDir.name}:`, error);
            return null;
          }
        }

        formatStackName(dirname) {
          return dirname
            .replace(/_stack$/, "")
            .split("_")
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(" ");
        }

        determineStackUseCase(stackName) {
          if (stackName.includes("crm") || stackName.includes("sales")) return "sales";
          if (stackName.includes("email") || stackName.includes("voice")) return "communication";
          if (stackName.includes("data") || stackName.includes("analysis")) return "analytics";
          return "productivity";
        }

        setView(view) {
          // Always use list view
          this.currentView = 'list';
          this.renderTemplates(this.filteredTemplates);
        }

        renderTemplates(templates) {
          const grid = document.getElementById("templateGrid");
          const list = document.getElementById("templateList");
          const emptyState = document.getElementById("templateEmptyState");
          const templateCount = document.getElementById("templateCount");

          if (!grid && !list) return;

          // Update template count
          if (templateCount) {
            templateCount.textContent = `${templates.length} template${templates.length !== 1 ? 's' : ''}`;
          }

          if (templates.length === 0) {
            if (grid) grid.style.display = "none";
            if (list) list.innerHTML = "";
            if (emptyState) emptyState.style.display = "block";
            return;
          }

          if (emptyState) emptyState.style.display = "none";

          // Render based on current view
          if (this.currentView === 'list') {
            // Render list view with industry grouping when not filtered
            if (list) {
              let html = '';
              
              // If no specific industry is selected, group by industry
              if (!this.selectedIndustry) {
                // Define industry order and config
                const industryOrder = [
                  'B2B Sales',
                  'B2C Sales',
                  'Healthcare',
                  'Financial Services',
                  'Manufacturing',
                  'Retail & CPG',
                  'Energy & Utilities',
                  'Professional Services',
                  'Software & Digital Products',
                  'Federal Government',
                  'State & Local Government',
                  'Cross-Industry',
                  'General'
                ];
                
                const industryConfig = {
                  'B2B Sales': { icon: 'üíº', color: '#0078d4' },
                  'B2C Sales': { icon: 'üõçÔ∏è', color: '#e74c3c' },
                  'Healthcare': { icon: 'üè•', color: '#27ae60' },
                  'Financial Services': { icon: 'üè¶', color: '#2c3e50' },
                  'Energy & Utilities': { icon: '‚ö°', color: '#f39c12' },
                  'Manufacturing': { icon: 'üè≠', color: '#34495e' },
                  'Professional Services': { icon: 'üíª', color: '#8e44ad' },
                  'Software & Digital Products': { icon: 'üì±', color: '#3498db' },
                  'Retail & CPG': { icon: 'üõí', color: '#e67e22' },
                  'Federal Government': { icon: 'üèõÔ∏è', color: '#c0392b' },
                  'State & Local Government': { icon: 'üè¢', color: '#16a085' },
                  'Cross-Industry': { icon: 'üåê', color: '#95a5a6' },
                  'General': { icon: 'üì¶', color: '#7f8c8d' }
                };
                
                // Group templates by industry
                const templatesByIndustry = {};
                templates.forEach(template => {
                  const industry = template.industry || 'General';
                  if (!templatesByIndustry[industry]) {
                    templatesByIndustry[industry] = [];
                  }
                  templatesByIndustry[industry].push(template);
                });
                
                // Render each industry group in order
                industryOrder.forEach(industry => {
                  if (templatesByIndustry[industry] && templatesByIndustry[industry].length > 0) {
                    const config = industryConfig[industry];
                    
                    // Add industry header
                    html += `
                      <div style="background: linear-gradient(135deg, ${config.color}15 0%, ${config.color}05 100%); border-left: 4px solid ${config.color}; padding: 1rem; margin: 1.5rem 0 1rem; border-radius: 8px;">
                        <h3 style="color: ${config.color}; margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                          <span style="font-size: 1.5rem;">${config.icon}</span>
                          <span>${industry}</span>
                          <span style="background: ${config.color}; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.9rem; margin-left: auto;">
                            ${templatesByIndustry[industry].length} stacks
                          </span>
                        </h3>
                      </div>
                    `;
                    
                    // Add templates for this industry
                    html += templatesByIndustry[industry]
                      .map((template) => {
                        const isInCart = this.isTemplateInCart(template);
                        const complexityLabel = {
                          starter: "Starter",
                          intermediate: "Intermediate",
                          advanced: "Advanced",
                        }[template.complexity];

                  // Get agent details for display
                  const agentDetails = template.agents.map((agentId) => {
                    const agent = agentStore.agents.find((a) => a.id === agentId);
                    return agent
                      ? { id: agentId, name: agent.name, icon: agent.icon }
                      : {
                          id: agentId,
                          name: this.formatAgentName(agentId),
                          icon: "ü§ñ",
                        };
                  });

                  return `
                    <div class="template-list-item ${template.isDynamic ? 'dynamic-stack' : ''}">
                        <div class="template-list-content">
                            <div class="template-list-main">
                                <div class="template-list-title">${template.name}</div>
                                <div class="template-list-description">${template.description}</div>
                                <div class="template-list-agents">
                                    ${agentDetails
                                      .map(
                                        (agent) =>
                                          `<span class="agent-pill">${agent.icon} ${agent.name}</span>`
                                      )
                                      .join("")}
                                </div>
                            </div>
                            <div class="template-list-meta">
                                <span class="badge badge-complexity-${
                                  template.complexity === "starter"
                                    ? "low"
                                    : template.complexity === "intermediate"
                                    ? "medium"
                                    : "high"
                                }">
                                    ${complexityLabel}
                                </span>
                                <span style="color: #666; font-size: 0.85rem;">${template.estimatedTime}</span>
                                ${
                                  (template.demo && template.demo.available) || template.isDynamic
                                    ? '<span style="color: #10b981; font-size: 0.85rem; font-weight: 500;">üéÆ Demo Available</span>'
                                    : ''
                                }
                            </div>
                            <div class="template-list-stats">
                                <div style="font-size: 1.2rem; font-weight: 600; color: #0078d4;">${template.agents.length}</div>
                                <div style="font-size: 0.8rem; color: #666;">Agents</div>
                            </div>
                            <div class="template-list-actions">
                                <button class="btn btn-secondary" onclick="(async () => await templateManager.viewTemplateDetails('${template.id}'))()">
                                    üëÅÔ∏è View
                                </button>
                                ${
                                  (template.demo && template.demo.available) || template.isDynamic
                                    ? `<button class="btn btn-secondary" onclick="templateManager.openDemo('${template.id}')">
                                        üéÆ Demo
                                       </button>`
                                    : ''
                                }
                                ${
                                  isInCart
                                    ? `<button class="btn btn-danger" onclick="templateManager.removeTemplateFromCart('${template.id}')">
                                        ‚úï Remove
                                       </button>`
                                    : `<button class="btn btn-primary" onclick="templateManager.addTemplateToCart('${template.id}')">
                                        ‚ûï Add
                                       </button>`
                                }
                            </div>
                        </div>
                    </div>
                  `;
                      })
                      .join("");
                  }
                });
                
                list.innerHTML = html;
              } else {
                // If industry is selected, render normally without grouping
                list.innerHTML = templates
                  .map((template) => {
                    const isInCart = this.isTemplateInCart(template);
                    const complexityLabel = {
                      starter: "Starter",
                      intermediate: "Intermediate",
                      advanced: "Advanced",
                    }[template.complexity];

                    // Get agent details for display
                    const agentDetails = template.agents.map((agentId) => {
                      const agent = agentStore.agents.find((a) => a.id === agentId);
                      return agent
                        ? { id: agentId, name: agent.name, icon: agent.icon }
                        : {
                            id: agentId,
                            name: this.formatAgentName(agentId),
                            icon: "ü§ñ",
                          };
                    });

                    return `
                      <div class="template-list-item ${template.isDynamic ? 'dynamic-stack' : ''}">
                          <div class="template-list-content">
                              <div class="template-list-main">
                                  <div class="template-list-title">${template.name}</div>
                                  <div class="template-list-description">${template.description}</div>
                                  <div class="template-list-agents">
                                      ${agentDetails
                                        .map(
                                          (agent) =>
                                            `<span class="agent-pill">${agent.icon} ${agent.name}</span>`
                                        )
                                        .join("")}
                                  </div>
                              </div>
                              <div class="template-list-meta">
                                  <span class="badge badge-complexity-${
                                    template.complexity === "starter"
                                      ? "low"
                                      : template.complexity === "intermediate"
                                      ? "medium"
                                      : "high"
                                  }">
                                      ${complexityLabel}
                                  </span>
                                  <span style="color: #666; font-size: 0.85rem;">${template.estimatedTime}</span>
                                  ${
                                    (template.demo && template.demo.available) || template.isDynamic
                                      ? '<span style="color: #10b981; font-size: 0.85rem; font-weight: 500;">üéÆ Demo Available</span>'
                                      : ''
                                  }
                              </div>
                              <div class="template-list-stats">
                                  <div style="font-size: 1.2rem; font-weight: 600; color: #0078d4;">${template.agents.length}</div>
                                  <div style="font-size: 0.8rem; color: #666;">Agents</div>
                              </div>
                              <div class="template-list-actions">
                                  <button class="btn btn-secondary" onclick="(async () => await templateManager.viewTemplateDetails('${template.id}'))()">
                                      üëÅÔ∏è View
                                  </button>
                                  ${
                                    (template.demo && template.demo.available) || template.isDynamic
                                      ? `<button class="btn btn-secondary" onclick="templateManager.openDemo('${template.id}')">
                                          üéÆ Demo
                                         </button>`
                                      : ''
                                  }
                                  ${
                                    isInCart
                                      ? `<button class="btn btn-danger" onclick="templateManager.removeTemplateFromCart('${template.id}')">
                                          ‚úï Remove
                                         </button>`
                                      : `<button class="btn btn-primary" onclick="templateManager.addTemplateToCart('${template.id}')">
                                          ‚ûï Add
                                         </button>`
                                  }
                              </div>
                          </div>
                      </div>
                    `;
                  })
                  .join("");
              }
            }
          } else {
            // Render gallery view (sorted by industry)
            if (grid) {
              grid.style.display = "grid";
              
              // Sort templates by industry for consistent display
              const sortedTemplates = [...templates].sort((a, b) => {
                const industryOrder = [
                  'B2B Sales',
                  'B2C Sales',
                  'Healthcare',
                  'Financial Services',
                  'Manufacturing',
                  'Retail & CPG',
                  'Energy & Utilities',
                  'Professional Services',
                  'Software & Digital Products',
                  'Federal Government',
                  'State & Local Government',
                  'Cross-Industry',
                  'General'
                ];
                
                const industryA = a.industry || 'General';
                const industryB = b.industry || 'General';
                const indexA = industryOrder.indexOf(industryA);
                const indexB = industryOrder.indexOf(industryB);
                
                if (indexA !== indexB) {
                  const orderA = indexA === -1 ? 999 : indexA;
                  const orderB = indexB === -1 ? 999 : indexB;
                  return orderA - orderB;
                }
                
                // Within same industry, sort by name
                return a.name.localeCompare(b.name);
              });

              grid.innerHTML = sortedTemplates
            .map((template) => {
              const isInCart = this.isTemplateInCart(template);
              const complexityLabel = {
                starter: "Starter",
                intermediate: "Intermediate",
                advanced: "Advanced",
              }[template.complexity];

              // Get agent details for display
              const agentDetails = template.agents.map((agentId) => {
                const agent = agentStore.agents.find((a) => a.id === agentId);
                return agent
                  ? { id: agentId, name: agent.name, icon: agent.icon }
                  : {
                      id: agentId,
                      name: this.formatAgentName(agentId),
                      icon: "ü§ñ",
                    };
              });

              return `
                        <div class="template-card ${template.isDynamic ? 'dynamic-stack' : ''}">
                            <div class="template-header">
                                <div>
                                    <h3 class="template-title">${
                                      template.name
                                    }</h3>
                                    <span class="badge badge-complexity-${
                                      template.complexity === "starter"
                                        ? "low"
                                        : template.complexity === "intermediate"
                                        ? "medium"
                                        : "high"
                                    }">
                                        ${complexityLabel} ‚Ä¢ ${
                template.estimatedTime
              }
                                    </span>
                                </div>
                            </div>

                            ${template.isDynamic ? `
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.75rem; text-align: center; font-weight: 500;">
                                üöÄ Dynamic GitHub Stack
                            </div>
                            ` : ''}
                            ${(template.demo && template.demo.available) || template.isDynamic ? `
                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.75rem; text-align: center; font-weight: 500;">
                                üéÆ Interactive Demo Available
                            </div>
                            ` : ''}

                            <p class="template-description">${
                              template.description
                            }</p>

                            <div class="template-agents">
                                <div class="template-agents-title">Included Agents (${
                                  template.agents.length
                                }):</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    ${agentDetails
                                      .map(
                                        (agent) =>
                                          `<span class="agent-pill">${agent.icon} ${agent.name}</span>`
                                      )
                                      .join("")}
                                </div>
                            </div>

                            <div class="template-stats">
                                <div class="template-stat">
                                    <div class="template-stat-value">${
                                      template.agents.length
                                    }</div>
                                    <div class="template-stat-label">Agents</div>
                                </div>
                                <div class="template-stat">
                                    <div class="template-stat-value">${
                                      template.benefits.length
                                    }</div>
                                    <div class="template-stat-label">Benefits</div>
                                </div>
                                <div class="template-stat">
                                    <div class="template-stat-value">${
                                      template.estimatedTime.split("-")[0]
                                    }</div>
                                    <div class="template-stat-label">Min. Time</div>
                                </div>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <strong style="color: #555; font-size: 0.9rem;">Key Benefits:</strong>
                                <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                    ${template.benefits
                                      .map(
                                        (benefit) =>
                                          `<li style="color: #666; font-size: 0.85rem; margin: 0.25rem 0;">${benefit}</li>`
                                      )
                                      .join("")}
                                </ul>
                            </div>

                            <div class="action-buttons">
                                ${
                                  isInCart
                                    ? `<button class="btn btn-danger" onclick="templateManager.removeTemplateFromCart('${template.id.replace(/'/g, "\\'")}')">
                                        ‚úï Remove Stack
                                       </button>`
                                    : `<button class="btn btn-success" onclick="templateManager.addTemplateToCart('${template.id.replace(/'/g, "\\'")}')">
                                        ‚ûï Add Entire Stack to Cart
                                       </button>`
                                }
                                <button class="btn btn-secondary" onclick="(async () => await templateManager.viewTemplateDetails('${template.id.replace(/'/g, "\\'")}'))()">
                                    üëÅÔ∏è View Details
                                </button>
                                ${
                                  (template.demo && template.demo.available) || template.isDynamic
                                    ? `<button class="btn btn-secondary" onclick="templateManager.openDemo('${template.id.replace(/'/g, "\\'")}')">
                                        üéÆ Open Demo
                                       </button>`
                                    : ''
                                }
                            </div>
                        </div>
                    `;
              })
              .join("");
            }
          }
        }

        openDemo(templateId) {
          // Find the template
          const template = [...this.agentTemplates, ...this.dynamicStacks].find(t => t.id === templateId);
          if (!template) return;

          // Build demo URL based on template type
          let demoUrl = '';
          if (template.demo && template.demo.url) {
            // Use the provided demo URL from manifest (should now have correct paths)
            demoUrl = template.demo.url;
          } else if (template.isDynamic && template.stackPath) {
            // For dynamic stacks, use the stackPath which may include industry folder
            const demoFileName = templateId.replace('_stack', '_demo.html');
            demoUrl = `agent_stacks/${template.stackPath}/demos/${demoFileName}`;
          } else {
            // Default path - try with industry folder structure
            const demoFileName = templateId.replace('_stack', '_demo.html');
            demoUrl = `agent_stacks/${templateId}/demos/${demoFileName}`;
          }

          // Open the demo in same window
          if (demoUrl) {
            window.location.href = demoUrl;
          } else {
            console.error('Demo URL not found for template:', templateId);
            showToast('Demo not available for this template', 'warning');
          }
        }

        clearIndustryFilter() {
          this.selectedIndustry = null;
          localStorage.removeItem('selectedIndustry');
          
          // Reset to all templates
          this.filteredTemplates = [...this.agentTemplates];
          this.renderTemplates(this.filteredTemplates);
          this.renderIndustryButtons();
          
          // Reset search placeholder
          const searchInput = document.getElementById('templateSearchInput');
          if (searchInput) {
            searchInput.placeholder = 'Search templates by name, description, or use case...';
          }
          
          showToast('Showing all stacks', 'info');
        }
        
        filterByIndustry(industry, save = true) {
          this.selectedIndustry = industry;
          
          if (save) {
            localStorage.setItem('selectedIndustry', industry);
          }
          
          // Filter templates
          this.filteredTemplates = this.agentTemplates.filter(template => 
            template.industry === industry
          );
          
          // Update UI
          this.renderTemplates(this.filteredTemplates);
          this.renderIndustryButtons();
          
          // Update the search placeholder
          const searchInput = document.getElementById('templateSearchInput');
          if (searchInput) {
            searchInput.placeholder = `Search within ${industry}...`;
          }
          
          // Show toast
          showToast(`Showing ${this.filteredTemplates.length} stacks for ${industry}`, 'info');
        }
        
        buildIndustryMap() {
          this.industries.clear();
          
          // Industry display names and icons
          const industryConfig = {
            'B2B Sales': { icon: 'üíº', color: '#0078d4' },
            'B2C Sales': { icon: 'üõçÔ∏è', color: '#e74c3c' },
            'Healthcare': { icon: 'üè•', color: '#27ae60' },
            'Financial Services': { icon: 'üè¶', color: '#2c3e50' },
            'Energy & Utilities': { icon: '‚ö°', color: '#f39c12' },
            'Manufacturing': { icon: 'üè≠', color: '#34495e' },
            'Professional Services': { icon: 'üíª', color: '#8e44ad' },
            'Software & Digital Products': { icon: 'üì±', color: '#3498db' },
            'Retail & CPG': { icon: 'üõí', color: '#e67e22' },
            'Federal Government': { icon: 'üèõÔ∏è', color: '#c0392b' },
            'State & Local Government': { icon: 'üè¢', color: '#16a085' },
            'Cross-Industry': { icon: 'üåê', color: '#95a5a6' },
            'General': { icon: 'üì¶', color: '#7f8c8d' }
          };
          
          // Count stacks per industry
          this.agentTemplates.forEach(template => {
            const industry = template.industry || 'General';
            if (!this.industries.has(industry)) {
              this.industries.set(industry, {
                count: 0,
                ...industryConfig[industry] || { icon: 'üìÅ', color: '#95a5a6' }
              });
            }
            this.industries.get(industry).count++;
          });
        }
        
        renderIndustryButtons() {
          const container = document.getElementById('industryButtons');
          if (!container) return;
          
          // Ensure industries map exists
          if (!this.industries || this.industries.size === 0) {
            console.warn('Industries not yet loaded, building map now');
            this.buildIndustryMap();
          }
          
          // Sort industries by count (descending) but put General/Cross-Industry last
          const sortedIndustries = Array.from(this.industries.entries())
            .sort((a, b) => {
              if (a[0] === 'General' || a[0] === 'Cross-Industry') return 1;
              if (b[0] === 'General' || b[0] === 'Cross-Industry') return -1;
              return b[1].count - a[1].count;
            });
          
          container.innerHTML = sortedIndustries
            .map(([industry, data]) => `
              <button 
                class="industry-btn ${this.selectedIndustry === industry ? 'active' : ''}" 
                onclick="templateManager.filterByIndustry('${industry.replace(/'/g, "\\'")}')" 
                style="
                  background: ${this.selectedIndustry === industry ? data.color : 'white'};
                  color: ${this.selectedIndustry === industry ? 'white' : data.color};
                  border: 2px solid ${data.color};
                  padding: 0.75rem;
                  border-radius: 8px;
                  cursor: pointer;
                  transition: all 0.3s;
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  font-weight: 500;
                "
                onmouseover="if(!this.classList.contains('active')) { this.style.background='${data.color}'; this.style.color='white'; }"
                onmouseout="if(!this.classList.contains('active')) { this.style.background='white'; this.style.color='${data.color}'; }"
              >
                <span style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="font-size: 1.2rem;">${data.icon}</span>
                  <span>${industry}</span>
                </span>
                <span style="background: rgba(255, 255, 255, 0.3); padding: 0.2rem 0.5rem; border-radius: 12px;">
                  ${data.count}
                </span>
              </button>
            `)
            .join('');
        }
        
        formatAgentName(agentId) {
          return agentId
            .split("_")
            .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
            .join(" ")
            .replace(" Agent", "");
        }

        isTemplateInCart(template) {
          // Check if all agents in the template are in the cart
          return template.agents.every((agentId) =>
            agentStore.cart.some((cartItem) => cartItem.id === agentId)
          );
        }

        async loadStackAgentsIfNeeded(template) {
          // Check if this is a dynamic stack that hasn't loaded agents yet
          if (template.isDynamic && !template.agentsLoaded) {
            console.log(`Checking agents for stack: ${template.name}`);
            
            // First check if agents are already in the manifest data
            if (template.manifestData && template.manifestData.agents && template.manifestData.agents.length > 0) {
              // Agents are already loaded from manifest
              template.manifestData.agents.forEach(agent => {
                if (!agentStore.agents.find(a => a.id === agent.id)) {
                  agentStore.agents.push(agent);
                }
              });
              template.agents = template.manifestData.agents.map(a => a.id);
              template.agentsLoaded = true;
              console.log(`Using ${template.manifestData.agents.length} agents from manifest for ${template.name}`);
              return;
            }
            
            // If not in manifest, try loading via raw URLs (no API limits)
            try {
              console.log(`Loading agents via raw URLs for stack: ${template.name}`);
              const stackAgents = await agentStore.loadStackAgentsViaRawUrls(template.stackPath);
              
              // Add loaded agents to the agent store
              stackAgents.forEach(agent => {
                if (!agentStore.agents.find(a => a.id === agent.id)) {
                  agentStore.agents.push(agent);
                }
              });
              
              // Update template with actual agent IDs
              template.agents = stackAgents.map(a => a.id);
              template.agentsLoaded = true;
              
              console.log(`Loaded ${stackAgents.length} agents for ${template.name} via raw URLs`);
            } catch (error) {
              console.error(`Failed to load agents for stack ${template.name}:`, error);
              // Use empty array if loading fails
              template.agents = [];
              template.agentsLoaded = true;
            }
          }
        }

        async addTemplateToCart(templateId) {
          const template = this.agentTemplates.find((t) => t.id === templateId);
          if (!template) return;

          // Lazy load agents if needed
          await this.loadStackAgentsIfNeeded(template);

          // Ensure agents are loaded
          if (agentStore.agents.length === 0) {
            showToast("Loading agents...", "info");
            await agentStore.loadAgents();
          }

          // Add each agent from the template to the cart
          let addedCount = 0;
          for (const agentId of template.agents) {
            const agent = agentStore.agents.find((a) => a.id === agentId);
            if (
              agent &&
              !agentStore.cart.find((item) => item.id === agent.id)
            ) {
              agentStore.cart.push(agent);
              addedCount++;
            }
          }

          agentStore.updateCartUI();
          this.updateTemplateCartCount();
          this.renderTemplates(this.filteredTemplates);

          if (addedCount > 0) {
            showToast(
              `Added ${addedCount} agents from "${template.name}" to your stack`,
              "success"
            );
          } else {
            showToast(
              "All agents from this template are already in your stack",
              "info"
            );
          }
        }

        removeTemplateFromCart(templateId) {
          const template = this.agentTemplates.find((t) => t.id === templateId);
          if (!template) return;

          // Remove each agent from the template from the cart
          let removedCount = 0;
          for (const agentId of template.agents) {
            const index = agentStore.cart.findIndex(
              (item) => item.id === agentId
            );
            if (index !== -1) {
              agentStore.cart.splice(index, 1);
              removedCount++;
            }
          }

          agentStore.updateCartUI();
          this.updateTemplateCartCount();
          this.renderTemplates(this.filteredTemplates);

          if (removedCount > 0) {
            showToast(
              `Removed ${removedCount} agents from "${template.name}"`,
              "success"
            );
          }
        }

        async viewTemplateDetails(templateId, fromHashChange = false) {
          const template = this.agentTemplates.find((t) => t.id === templateId);
          if (!template) return;
          
          // Check if modal already exists and remove it
          const existingModal = document.getElementById('stackModalBackdrop');
          if (existingModal) {
            existingModal.remove();
          }
          
          // Update URL hash for permalinking (only if not called from hash change event)
          if (!fromHashChange) {
            window.location.hash = `stack-${templateId}`;
          }

          // Lazy load agents if needed
          await this.loadStackAgentsIfNeeded(template);

          // Create modal backdrop
          const backdrop = document.createElement('div');
          backdrop.id = 'stackModalBackdrop';
          backdrop.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 2rem;
          `;

          // Create modal content
          const modal = document.createElement('div');
          modal.style.cssText = `
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 9999;
          `;

          // Build modal HTML based on available metadata
          let modalHTML = `
            <div style="padding: 2rem;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                <div>
                  <h2 style="margin: 0; color: #333; font-size: 1.8rem;">${template.name}</h2>
                  ${template.version ? `<span style="color: #666; font-size: 0.9rem;">Version ${template.version}</span>` : ''}
                  ${template.author ? `<span style="color: #666; font-size: 0.9rem; margin-left: 1rem;">by ${template.author}</span>` : ''}
                </div>
                <button onclick="document.getElementById('stackModalBackdrop').remove(); window.location.hash = '';" style="background: #ef4444; color: white; border: none; border-radius: 8px; padding: 0.5rem 1rem; cursor: pointer; font-size: 1rem;">‚úï Close</button>
              </div>
          `;

          // Add badges
          modalHTML += `
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
              <span style="background: ${template.complexity === 'starter' ? '#10b981' : template.complexity === 'intermediate' ? '#f59e0b' : '#ef4444'}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">${template.complexity}</span>
              <span style="background: #3b82f6; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">${template.estimatedTime}</span>
              <span style="background: #8b5cf6; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">${template.useCase}</span>
              ${template.hasMetadata ? '<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">üìä Rich Metadata</span>' : ''}
            </div>
          `;

          // Description section
          modalHTML += `
            <div style="margin-bottom: 2rem;">
              <h3 style="color: #333; margin-bottom: 0.5rem;">Description</h3>
              <p style="color: #666; line-height: 1.6;">${template.description}</p>
              ${template.longDescription ? `<p style="color: #666; line-height: 1.6; margin-top: 1rem;">${template.longDescription}</p>` : ''}
            </div>
          `;

          // Features section (if available)
          if (template.features && template.features.length > 0) {
            modalHTML += `
              <div style="margin-bottom: 2rem;">
                <h3 style="color: #333; margin-bottom: 0.5rem;">Features</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 0.5rem;">
                  ${template.features.map(feature => `
                    <div style="display: flex; align-items: start;">
                      <span style="color: #10b981; margin-right: 0.5rem;">‚úì</span>
                      <span style="color: #666; font-size: 0.9rem;">${feature}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }

          // Use Cases section (if available)
          if (template.useCases && template.useCases.length > 0) {
            modalHTML += `
              <div style="margin-bottom: 2rem;">
                <h3 style="color: #333; margin-bottom: 0.5rem;">Use Cases</h3>
                <div style="display: grid; gap: 1rem;">
                  ${template.useCases.map(useCase => `
                    <div style="background: #f3f4f6; padding: 1rem; border-radius: 8px;">
                      <h4 style="color: #333; margin: 0 0 0.5rem 0; font-size: 1rem;">${useCase.title}</h4>
                      <p style="color: #666; margin: 0; font-size: 0.9rem;">${useCase.description}</p>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }

          // Components/Agents section
          modalHTML += `
            <div style="margin-bottom: 2rem;">
              <h3 style="color: #333; margin-bottom: 0.5rem;">Included Components (${template.agents.length})</h3>
              <div style="display: grid; gap: 0.75rem;">
          `;

          if (template.components && template.components.length > 0) {
            // Use detailed component info if available
            template.components.forEach(component => {
              modalHTML += `
                <div style="background: #f9fafb; padding: 0.75rem; border-radius: 8px; border-left: 3px solid #3b82f6;">
                  <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                      <strong style="color: #333;">${component.name}</strong>
                      <span style="color: #6b7280; font-size: 0.85rem; margin-left: 0.5rem;">${component.role}</span>
                    </div>
                  </div>
                  <p style="color: #666; margin: 0.5rem 0 0 0; font-size: 0.9rem;">${component.description}</p>
                </div>
              `;
            });
          } else {
            // Fallback to simple agent list
            template.agents.forEach(agentId => {
              const agent = agentStore.agents.find(a => a.id === agentId);
              modalHTML += `
                <div style="background: #f9fafb; padding: 0.75rem; border-radius: 8px;">
                  ${agent ? `${agent.icon} ${agent.name}` : this.formatAgentName(agentId)}
                </div>
              `;
            });
          }

          modalHTML += `</div></div>`;

          // Technical Requirements (if available)
          if (template.technicalRequirements) {
            modalHTML += `
              <div style="margin-bottom: 2rem;">
                <h3 style="color: #333; margin-bottom: 0.5rem;">Technical Requirements</h3>
                <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; border: 1px solid #fbbf24;">
                  ${template.technicalRequirements.platforms ? `
                    <div style="margin-bottom: 0.75rem;">
                      <strong style="color: #92400e;">Platforms:</strong>
                      <span style="color: #78350f; margin-left: 0.5rem;">${template.technicalRequirements.platforms.join(', ')}</span>
                    </div>
                  ` : ''}
                  ${template.technicalRequirements.dependencies ? `
                    <div style="margin-bottom: 0.75rem;">
                      <strong style="color: #92400e;">Dependencies:</strong>
                      <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                        ${template.technicalRequirements.dependencies.map(dep => `
                          <li style="color: #78350f; font-size: 0.9rem;">${dep}</li>
                        `).join('')}
                      </ul>
                    </div>
                  ` : ''}
                  ${template.technicalRequirements.apiKeys ? `
                    <div>
                      <strong style="color: #92400e;">Required API Keys:</strong>
                      <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                        ${template.technicalRequirements.apiKeys.map(key => `
                          <code style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">${key}</code>
                        `).join('')}
                      </div>
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          }

          // Benefits section
          modalHTML += `
            <div style="margin-bottom: 2rem;">
              <h3 style="color: #333; margin-bottom: 0.5rem;">Key Benefits</h3>
              <ul style="color: #666; padding-left: 1.5rem;">
                ${template.benefits.map(benefit => `<li style="margin: 0.5rem 0;">${benefit}</li>`).join('')}
              </ul>
            </div>
          `;

          // Demo section (if available)
          if (template.demo && template.demo.available) {
            modalHTML += `
              <div style="margin-bottom: 2rem;">
                <h3 style="color: #333; margin-bottom: 0.5rem;">üéÆ Interactive Demo</h3>
                <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 1.5rem; border-radius: 12px; border: 2px solid #10b981;">
                  <h4 style="color: #065f46; margin: 0 0 0.75rem 0;">${template.demo.title || 'Try the Demo'}</h4>
                  <p style="color: #047857; margin: 0 0 1rem 0; font-size: 0.95rem;">${template.demo.description || 'Experience this stack with an interactive demonstration.'}</p>
                  ${template.demo.features ? `
                    <ul style="margin: 0 0 1rem 0; padding-left: 1.5rem;">
                      ${template.demo.features.map(feature => `
                        <li style="color: #059669; font-size: 0.9rem; margin: 0.25rem 0;">${feature}</li>
                      `).join('')}
                    </ul>
                  ` : ''}
                  <button onclick="window.open('${template.demo.url}', '_blank');" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; cursor: pointer; font-size: 1rem; font-weight: 600; width: 100%; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2); transition: transform 0.2s;">
                    üöÄ Launch Interactive Demo
                  </button>
                </div>
              </div>
            `;
          }

          // Tags (if available)
          if (template.tags && template.tags.length > 0) {
            modalHTML += `
              <div style="margin-bottom: 2rem;">
                <h3 style="color: #333; margin-bottom: 0.5rem;">Tags</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                  ${template.tags.map(tag => `
                    <span style="background: #e5e7eb; color: #374151; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">#${tag}</span>
                  `).join('')}
                </div>
              </div>
            `;
          }

          // Action buttons
          modalHTML += `
            <div style="display: flex; gap: 1rem; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
              ${!this.isTemplateInCart(template) ? `
                <button onclick="templateManager.addTemplateToCart('${template.id.replace(/'/g, "\\'")}'); document.getElementById('stackModalBackdrop').remove(); window.location.hash = '';" style="background: #10b981; color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; cursor: pointer; font-size: 1rem; font-weight: 500;">
                  ‚ûï Add Stack to Cart
                </button>
              ` : `
                <button style="background: #6b7280; color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; cursor: not-allowed; font-size: 1rem; font-weight: 500;" disabled>
                  ‚úì Already in Cart
                </button>
              `}
              ${template.demo && template.demo.available ? `
                <button onclick="window.open('${template.demo.url}', '_blank');" style="background: #3b82f6; color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; cursor: pointer; font-size: 1rem; font-weight: 500;">
                  üéÆ Try Demo
                </button>
              ` : ''}
              ${template.isDynamic ? `
                <button onclick="templateManager.exportStackTradingCard('${template.id.replace(/'/g, "\\'")}')" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; cursor: pointer; font-size: 1rem; font-weight: 500; box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3);">
                  üì¶ Export Trading Card
                </button>
              ` : ''}
              <button onclick="document.getElementById('stackModalBackdrop').remove(); window.location.hash = '';" style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; padding: 0.75rem 1.5rem; cursor: pointer; font-size: 1rem;">
                Close
              </button>
            </div>
          `;

          modalHTML += `</div>`;
          modal.innerHTML = modalHTML;
          backdrop.appendChild(modal);

          // Close on backdrop click
          backdrop.addEventListener('click', (e) => {
            if (e.target === backdrop) {
              backdrop.remove();
              window.location.hash = '';
            }
          });

          document.body.appendChild(backdrop);
        }

        searchTemplates() {
          const searchTerm = document
            .getElementById("templateSearchInput")
            .value.toLowerCase();

          if (!searchTerm) {
            this.filteredTemplates = [...this.agentTemplates];
          } else {
            this.filteredTemplates = this.agentTemplates.filter(
              (template) =>
                template.name.toLowerCase().includes(searchTerm) ||
                template.description.toLowerCase().includes(searchTerm) ||
                template.useCase.toLowerCase().includes(searchTerm) ||
                template.agents.some((a) =>
                  a.toLowerCase().includes(searchTerm)
                ) ||
                template.benefits.some((b) =>
                  b.toLowerCase().includes(searchTerm)
                )
            );
          }

          this.applyFilters();
        }

        filterTemplates() {
          this.applyFilters();
        }

        applyFilters() {
          const useCase = document.getElementById("useCaseFilter").value;
          const complexity = document.getElementById("complexityFilter").value;
          const searchTerm = document
            .getElementById("templateSearchInput")
            .value.toLowerCase();

          let filtered = [...this.agentTemplates];

          if (searchTerm) {
            filtered = filtered.filter(
              (template) =>
                template.name.toLowerCase().includes(searchTerm) ||
                template.description.toLowerCase().includes(searchTerm) ||
                template.useCase.toLowerCase().includes(searchTerm) ||
                template.agents.some((a) =>
                  a.toLowerCase().includes(searchTerm)
                ) ||
                template.benefits.some((b) =>
                  b.toLowerCase().includes(searchTerm)
                )
            );
          }

          if (useCase) {
            filtered = filtered.filter((t) => t.useCase === useCase);
          }

          if (complexity) {
            filtered = filtered.filter((t) => t.complexity === complexity);
          }

          this.filteredTemplates = filtered;
          this.renderTemplates(this.filteredTemplates);
        }
        resetFilters() {
          document.getElementById("templateSearchInput").value = "";
          document.getElementById("useCaseFilter").value = "";
          document.getElementById("complexityFilter").value = "";
          this.filteredTemplates = [...this.agentTemplates];
          this.renderTemplates(this.filteredTemplates);
        }

        updateTemplateCartCount() {
          const count = document.getElementById("templateCartCount");
          if (count) count.textContent = agentStore.cart.length;
        }

        async exportStackTradingCard(templateId) {
          const template = this.agentTemplates.find((t) => t.id === templateId);
          if (!template) {
            showToast("Template not found", "error");
            return;
          }

          // Lazy load agents if needed
          await this.loadStackAgentsIfNeeded(template);

          showToast("Creating complete package with all components...", "info");

          try {
            // Check if stack has additional files
            const hasDemo = template.demo && template.demo.available;
            const hasFiles = template.files && template.files.length > 0;
            const needsZip = hasDemo || hasFiles || template.agents.length > 1;
            
            if (needsZip) {
              // Create a zip package with all components
              await this.exportStackAsZip(template);
            } else {
              // Single file export as HTML trading card
              await this.exportStackAsHTML(template);
            }
          } catch (error) {
            console.error("Error exporting stack:", error);
            showToast("Failed to export stack", "error");
          }
        }

        async exportStackAsZip(template) {
          // Load JSZip if needed
          if (typeof JSZip === 'undefined') {
            await agentStore.loadJSZip();
          }

          const zip = new JSZip();
          const stackFolder = zip.folder(template.name.replace(/[^a-z0-9]/gi, '_'));
          
          // Add agents
          const agentsFolder = stackFolder.folder('agents');
          const agentCode = {};
          
          for (const agentId of template.agents) {
            const agent = agentStore.agents.find(a => a.id === agentId);
            if (agent && agent.url) {
              try {
                const response = await fetch(agent.url);
                if (response.ok) {
                  const code = await response.text();
                  agentCode[agent.filename] = code;
                  agentsFolder.file(agent.filename, code);
                }
              } catch (error) {
                console.error(`Failed to fetch ${agent.filename}:`, error);
              }
            }
          }
          
          // Add demo files
          if (template.demo && template.demo.url) {
            const demoFolder = stackFolder.folder('demos');
            try {
              const demoFilename = template.demo.url.split('/').pop();
              const demoResponse = await fetch(template.demo.url);
              if (demoResponse.ok) {
                const demoContent = await demoResponse.text();
                demoFolder.file(demoFilename, demoContent);
              }
            } catch (err) {
              console.error('Failed to fetch demo:', err);
            }
          }
          
          // Add additional files
          if (template.files && template.files.length > 0) {
            const filesFolder = stackFolder.folder('files');
            for (const file of template.files) {
              try {
                const filePath = `agent_stacks/${template.id}/files/${file}`;
                const fileResponse = await fetch(filePath);
                if (fileResponse.ok) {
                  const fileBlob = await fileResponse.blob();
                  filesFolder.file(file, fileBlob);
                }
              } catch (err) {
                console.error(`Failed to fetch file ${file}:`, err);
              }
            }
          }
          
          // Add metadata
          stackFolder.file('metadata.json', JSON.stringify(template, null, 2));
          
          // Generate and add trading card HTML
          const tradingCardHTML = this.generateTradingCardHTML(template, agentCode);
          stackFolder.file('trading_card.html', tradingCardHTML);
          
          // Add README
          const readme = this.generateStackReadmeForExport(template);
          stackFolder.file('README.md', readme);
          
          // Generate and download zip
          const content = await zip.generateAsync({ type: 'blob' });
          const url = URL.createObjectURL(content);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${template.id}_complete_package.zip`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          showToast(`Complete package exported for ${template.name}!`, "success");
        }

        async exportStackAsHTML(template) {
          // Fetch all agent code for the stack
          const agentCode = {};
          for (const agentId of template.agents) {
            const agent = agentStore.agents.find(a => a.id === agentId);
            if (agent && agent.url) {
              try {
                const response = await fetch(agent.url);
                if (response.ok) {
                  agentCode[agent.filename] = await response.text();
                }
              } catch (error) {
                console.error(`Failed to fetch ${agent.filename}:`, error);
              }
            }
          }

          // Generate the trading card HTML
          const tradingCardHTML = this.generateTradingCardHTML(template, agentCode);
          
          // Create a blob and download
          const blob = new Blob([tradingCardHTML], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${template.id}_trading_card.html`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          showToast(`Trading Card exported for ${template.name}!`, "success");
        }

        generateStackReadmeForExport(template) {
          let readme = `# ${template.name}\n\n`;
          readme += `${template.description}\n\n`;
          readme += `## Stack Information\n\n`;
          readme += `- **Version:** ${template.version || '1.0.0'}\n`;
          readme += `- **Complexity:** ${template.complexity}\n`;
          readme += `- **Setup Time:** ${template.estimatedTime}\n`;
          readme += `- **Agents:** ${template.agents.length}\n\n`;
          
          if (template.features && template.features.length > 0) {
            readme += `## Features\n\n`;
            for (const feature of template.features) {
              readme += `- ${feature}\n`;
            }
            readme += `\n`;
          }
          
          if (template.benefits && template.benefits.length > 0) {
            readme += `## Benefits\n\n`;
            for (const benefit of template.benefits) {
              readme += `- ${benefit}\n`;
            }
            readme += `\n`;
          }
          
          readme += `## Installation\n\n`;
          readme += `1. Deploy base infrastructure from [Copilot-Agent-365](https://github.com/kody-w/Copilot-Agent-365)\n`;
          readme += `2. Copy agent files from \`agents/\` folder to your deployment\n`;
          
          if (template.demo && template.demo.available) {
            readme += `3. Open the demo file in \`demos/\` folder to test functionality\n`;
          }
          
          if (template.files && template.files.length > 0) {
            readme += `4. Additional resources are available in the \`files/\` folder\n`;
          }
          
          if (template.technicalRequirements && template.technicalRequirements.apiKeys) {
            readme += `\n## Required API Keys\n\n`;
            for (const key of template.technicalRequirements.apiKeys) {
              readme += `- \`${key}\`\n`;
            }
          }
          
          return readme;
        }

        loadTradingCardGenerator() {
          // Load the external trading card generator
          const script = document.createElement('script');
          script.src = '/generate_trading_card.js';
          document.head.appendChild(script);
        }
        
        generateTradingCardHTML(template, agentCode) {
          // Load and use the external generator
          try {
            // First, load the external script if not already loaded
            if (typeof window.generateTradingCardHTML !== 'function') {
              // Create the function inline from the external pattern
              const escapeHtml = (text) => {
                const map = {
                  '&': '&amp;',
                  '<': '&lt;',
                  '>': '&gt;',
                  '"': '&quot;',
                  "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
              };
              
              // Build all components without template literals
              const escapedCode = {};
              for (const [filename, code] of Object.entries(agentCode)) {
                escapedCode[filename] = escapeHtml(code);
              }
              
              const codeTabs = Object.keys(agentCode).map((filename, index) => 
                '<button class="code-tab' + (index === 0 ? ' active' : '') + '" onclick="showCode(\'' + filename + '\')">' + filename + '</button>'
              ).join('');
              
              const codeContent = Object.entries(escapedCode).map(([filename, code], index) => 
                '<div class="code-content" id="code-' + filename + '" style="display: ' + (index === 0 ? 'block' : 'none') + ';"><pre>' + code + '</pre></div>'
              ).join('');
              
              const demoButton = template.demo && template.demo.available ? 
                '<button onclick="window.location.href=\'' + template.demo.url + '\'" class="btn btn-success">üéÆ Try Demo</button>' : '';
              
              const agentsList = template.agents.map(agentId => 
                '<div class="agent-item"><strong>' + agentId.replace(/_/g, ' ').replace('.py', '') + '</strong></div>'
              ).join('');
              
              const featuresHtml = (template.features || template.benefits || []).slice(0, 6).map(feature => 
                '<div class="feature-item"><span>‚úì</span><span>' + feature + '</span></div>'
              ).join('');
              
              let apiKeysHtml = '';
              if (template.technicalRequirements && template.technicalRequirements.apiKeys) {
                const keysHtml = template.technicalRequirements.apiKeys.map(key => 
                  '<code style="background: white; padding: 0.25rem 0.5rem; border-radius: 4px;">' + key + '</code>'
                ).join('');
                
                apiKeysHtml = '<div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 8px;">' +
                  '<strong style="color: #92400e;">Required API Keys:</strong>' +
                  '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">' + keysHtml + '</div></div>';
              }
              
              const complexityStars = template.complexity === 'starter' ? '‚≠ê' : 
                                     template.complexity === 'intermediate' ? '‚≠ê‚≠ê' : '‚≠ê‚≠ê‚≠ê';
              
              const agentCodeJSON = JSON.stringify(agentCode);
              
              // Build the complete HTML using the external generator pattern
              let html = '';
              // Add the HTML from generate_trading_card.js
              // For now, use a simplified version
              const script = document.createElement('script');
              script.src = 'generate_trading_card.js';
              document.head.appendChild(script);
              
              // Wait a moment for script to load then regenerate
              setTimeout(() => {
                if (typeof window.generateTradingCardHTML === 'function') {
                  return window.generateTradingCardHTML(template, agentCode);
                }
              }, 100);
            }
            
            // Use the external function if available
            if (typeof window.generateTradingCardHTML === 'function') {
              return window.generateTradingCardHTML(template, agentCode);
            }
          } catch (error) {
            console.error('Error generating trading card:', error);
          }
          
          // Fallback
          return '<!DOCTYPE html><html><body><h1>Error generating trading card</h1></body></html>';
        }
        
        escapeHtml(text) {
          const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
          };
          return text.replace(/[&<>"']/g, m => map[m]);
        }
      }

      // Discovery Tool
      class DiscoveryTool {
        constructor() {
          this.currentStep = 1;
          this.totalSteps = 2;
          this.collectedData = {};
        }

        nextStep() {
          this.collectStepData(this.currentStep);
          document
            .getElementById(`disc-step${this.currentStep}`)
            .classList.remove("active");
          this.currentStep++;
          document
            .getElementById(`disc-step${this.currentStep}`)
            .classList.add("active");
          this.updateProgress();
        }

        previousStep() {
          document
            .getElementById(`disc-step${this.currentStep}`)
            .classList.remove("active");
          this.currentStep--;
          document
            .getElementById(`disc-step${this.currentStep}`)
            .classList.add("active");
          this.updateProgress();
        }

        updateProgress() {
          const progress = (this.currentStep / this.totalSteps) * 100;
          const progressBar = document.getElementById("progressBar");
          if (progressBar) {
            progressBar.style.width = progress + "%";
          }
        }

        collectStepData(step) {
          if (step === 1) {
            this.collectedData.company = {
              name: document.getElementById("companyName").value,
              industry: document.getElementById("industry").value,
            };
          }
        }

        async calculateResults() {
          this.collectStepData(this.currentStep);

          document
            .getElementById(`disc-step${this.currentStep}`)
            .classList.remove("active");
          document.getElementById("disc-results").classList.add("active");

          // Ensure templates are loaded
          if (!templateManager.templatesLoaded) {
            await templateManager.loadTemplates();
          }

          // Recommend templates based on industry
          const industry = this.collectedData.company.industry;
          let recommendedTemplates = [];

          if (industry === "financial" || industry === "retail") {
            recommendedTemplates = [
              "basic-starter",
              "microsoft-365-suite",
              "email-automation",
            ];
          } else if (industry === "healthcare") {
            recommendedTemplates = [
              "document-processing",
              "microsoft-365-suite",
            ];
          } else if (industry === "technology") {
            recommendedTemplates = [
              "creative-suite",
              "news-monitoring",
              "enterprise-complete",
            ];
          } else {
            recommendedTemplates = [
              "basic-starter",
              "email-automation",
              "document-processing",
            ];
          }

          const stacksDiv = document.getElementById("recommendedStacks");
          if (stacksDiv) {
            stacksDiv.innerHTML = recommendedTemplates
              .map((templateId) => {
                const template = templateManager.agentTemplates.find(
                  (t) => t.id === templateId
                );
                if (!template) return "";

                return `
                            <div class="card" style="margin-bottom: 1rem;">
                                <h3>${template.name}</h3>
                                <p>${template.description}</p>
                                <p style="color: #666;">Agents: ${template.agents.length} | Time: ${template.estimatedTime}</p>
                                <button class="btn btn-primary" onclick="templateManager.addTemplateToCart('${template.id.replace(/'/g, "\\'")}')"
                                    Add to Cart
                                </button>
                            </div>
                        `;
              })
              .join("");
          }
        }
      }

      // Agent Store with GitHub Integration
      class AgentStore {
        constructor() {
          // Updated to use the new GitHub repository
          this.GITHUB_REPO = "kody-w/AI-Agent-Templates";
          this.BRANCH = "main";
          this.AGENTS_PATH = "agents";
          this.STACKS_PATH = "agent_stacks";
          this.agents = [];
          this.stacks = [];
          this.filteredAgents = [];
          this.cart = [];
          this.agentCode = {};
          this.currentAgent = null;
          this.currentFilter = "all";
          this.currentView = "list";
        }

        async loadAgents() {
          try {
            this.showLoading(true);

            // Try to load from manifest first (single request instead of many API calls)
            const manifestLoaded = await this.loadFromManifest();
            
            if (!manifestLoaded) {
              // Fallback to raw URL loading (no API, no rate limits!)
              console.warn("Manifest not available, falling back to raw URL loading");
              const singularAgents = await this.loadAgentsViaRawUrls();
              const stackAgents = await this.loadStacksViaRawUrls();
              this.agents = [...singularAgents, ...stackAgents];
            }

            // Sort agents alphabetically
            this.agents.sort((a, b) => a.name.localeCompare(b.name));

            this.filteredAgents = [...this.agents];
            this.updateStats();
            this.renderAgents();

            this.showLoading(false);
            const agentCount = this.agents.filter(a => a.type === 'singular').length;
            const stackCount = this.stacksManifest ? this.stacksManifest.length : 0;
            showToast(
              `Loaded ${agentCount} agents and ${stackCount} stacks`,
              "success"
            );
          } catch (error) {
            console.error("Error loading agents:", error);
            this.showLoading(false);
            this.showError(
              "Failed to load agents. Please check your connection and try again."
            );
            showToast("Error loading agents", "error");
          }
        }

        async loadAgentsViaRawUrls() {
          console.log("Loading agents via raw GitHub URLs (no API, no rate limits!)...");
          
          try {
            // First load the index file that lists all agents
            const indexUrl = `https://raw.githubusercontent.com/${this.GITHUB_REPO}/${this.BRANCH}/${this.AGENTS_PATH}/index.json`;
            const indexResponse = await fetch(indexUrl);
            
            let agentFiles;
            if (indexResponse.ok) {
              const index = await indexResponse.json();
              agentFiles = index.agents || [];
            } else {
              // Fallback to hardcoded list if index.json doesn't exist yet
              console.warn("Index file not found, using hardcoded list");
              agentFiles = [
                'basic_agent.py',
                'calendar_agent.py',
                'code_review_agent.py',
                'context_memory_agent.py',
                'duckduckgo_search_agent.py',
                'dynamics_365_agent.py',
                'email_drafting_agent.py',
                'FetchRandomWikipediaArticle_agent.py',
                'hacker_news_agent.py',
                'image_generation_agent.py',
                'manage_memory_agent.py',
                'meeting_prep_agent.py',
                'motivational_quote_skill.py',
                'powerpoint_agent.py',
                'salesforce_query_agent.py',
                'servicenow_agent.py',
                'SharePointDocumentExtractorAgent_agent.py',
                'adaptive_card_agent.py'
              ];
            }

            const agents = [];
            
            // For each agent, we can optionally load its raw content to get size
            // But to keep it fast, we'll just use the list and approximate sizes
            for (const filename of agentFiles) {
              if (filename === '__init__.py') continue;
              
              const id = filename.replace('.py', '');
              agents.push({
                id: id,
                name: this.formatAgentName(filename),
                filename: filename,
                path: `${this.AGENTS_PATH}/${filename}`,
                url: `https://raw.githubusercontent.com/${this.GITHUB_REPO}/${this.BRANCH}/${this.AGENTS_PATH}/${filename}`,
                icon: this.getAgentIcon(filename),
                category: this.getAgentCategory(filename),
                description: this.getAgentDescription(filename),
                features: this.getAgentFeatures(filename),
                size: "~10KB", // Approximate size
                type: "singular",
                stackName: null
              });
            }

            return agents;
          } catch (error) {
            console.error("Error loading agents via raw URLs:", error);
            return this.getLocalAgents();
          }
        }

        async loadStackAgentsViaRawUrls(stackName) {
          console.log(`Loading agents for stack ${stackName} via raw URLs...`);
          const stackAgents = [];
          
          try {
            // Load the metadata.json for this specific stack
            const metadataUrl = `https://raw.githubusercontent.com/${this.GITHUB_REPO}/${this.BRANCH}/${this.STACKS_PATH}/${stackName}/metadata.json`;
            const response = await fetch(metadataUrl);
            
            if (response.ok) {
              const metadata = await response.json();
              
              // Add agents from this stack
              if (metadata.agents) {
                metadata.agents.forEach(agentFile => {
                  const filename = agentFile.split('/').pop();
                  const id = `${stackName}_${filename.replace('.py', '')}`;
                  
                  stackAgents.push({
                    id: id,
                    name: this.formatAgentName(filename),
                    filename: filename,
                    path: `${this.STACKS_PATH}/${stackName}/agents/${filename}`,
                    url: `https://raw.githubusercontent.com/${this.GITHUB_REPO}/${this.BRANCH}/${this.STACKS_PATH}/${stackName}/agents/${filename}`,
                    icon: 'üì¶',
                    category: 'stack',
                    description: `Part of ${metadata.name || stackName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`,
                    features: metadata.features || ["Stack functionality", "Integrated solution", "Production ready", "Enterprise scale"],
                    size: "~15KB",
                    type: "stack",
                    stackName: metadata.name || stackName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    stackPath: stackName
                  });
                });
              }
            }
          } catch (error) {
            console.error(`Failed to load metadata for stack ${stackName}:`, error);
          }
          
          return stackAgents;
        }

        async loadStacksViaRawUrls() {
          console.log("Loading stacks via raw URLs...");
          
          // Known stacks - we maintain this list
          const stacks = [
            'voice_to_crm_stack',
            'crm_bulk_data_creator_stack',
            'email_drafting_stack',
            'simulation_sales_stack'
          ];

          const stackAgents = [];
          
          for (const stackName of stacks) {
            try {
              // Load the metadata.json for each stack
              const metadataUrl = `https://raw.githubusercontent.com/${this.GITHUB_REPO}/${this.BRANCH}/${this.STACKS_PATH}/${stackName}/metadata.json`;
              const response = await fetch(metadataUrl);
              
              if (response.ok) {
                const metadata = await response.json();
                
                // Add agents from this stack
                if (metadata.agents) {
                  metadata.agents.forEach(agentFile => {
                    const filename = agentFile.split('/').pop();
                    const id = `${stackName}_${filename.replace('.py', '')}`;
                    
                    stackAgents.push({
                      id: id,
                      name: this.formatAgentName(filename),
                      filename: filename,
                      path: `${this.STACKS_PATH}/${stackName}/agents/${filename}`,
                      url: `https://raw.githubusercontent.com/${this.GITHUB_REPO}/${this.BRANCH}/${this.STACKS_PATH}/${stackName}/agents/${filename}`,
                      icon: 'üì¶',
                      category: 'stack',
                      description: `Part of ${metadata.name || stackName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`,
                      features: metadata.features || ["Stack functionality", "Integrated solution", "Production ready", "Enterprise scale"],
                      size: "~15KB",
                      type: "stack",
                      stackName: metadata.name || stackName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                      stackPath: stackName
                    });
                  });
                }
              }
            } catch (error) {
              console.warn(`Failed to load stack ${stackName}:`, error);
            }
          }
          
          return stackAgents;
        }

        async loadFromManifest() {
          try {
            // Load directly from GitHub raw URL (works without server)
            const manifestUrl = `https://raw.githubusercontent.com/${this.GITHUB_REPO}/${this.BRANCH}/manifest.json`;
            const response = await fetch(manifestUrl);
            
            if (!response.ok) {
              console.warn("Manifest file not found at GitHub");
              return false;
            }
            
            const manifest = await response.json();
            console.log(`Loaded manifest version ${manifest.version}, generated at ${manifest.generated}`);
            
            // Load all singular agents from manifest
            this.agents = manifest.agents || [];
            
            // Add agents from stacks to the main collection
            if (manifest.stacks) {
              manifest.stacks.forEach(stack => {
                if (stack.agents) {
                  this.agents.push(...stack.agents);
                }
              });
            }
            
            // Store stack information for lazy loading
            this.stacksManifest = manifest.stacks || [];
            console.log(`Manifest has ${this.stacksManifest.length} stacks`);
            
            // Also share with TemplateManager for stack templates
            if (window.templateManager) {
              window.templateManager.stacksManifest = this.stacksManifest;
              console.log(`Shared ${this.stacksManifest.length} stacks with templateManager`);
            } else {
              console.warn('TemplateManager not available yet, will retry sharing manifest');
              // Store in window for later access
              window.pendingStacksManifest = this.stacksManifest;
            }
            
            console.log(`Loaded ${this.agents.length} agents from manifest`);
            return true;
            
          } catch (error) {
            console.error("Error loading manifest:", error);
            return false;
          }
        }

        async loadSingularAgents() {
          try {
            // Fetch the list of files from GitHub API
            const apiUrl = `https://api.github.com/repos/${this.GITHUB_REPO}/contents/${this.AGENTS_PATH}?ref=${this.BRANCH}`;
            const response = await fetch(apiUrl);

            if (response.status === 403) {
              console.warn("GitHub API rate limit reached. Using local development mode.");
              return this.getLocalAgents();
            }

            if (!response.ok) {
              throw new Error(`GitHub API returned ${response.status}`);
            }

            const files = await response.json();

            // Filter for Python files and exclude __init__.py
            return files
              .filter(
                (file) =>
                  file.name.endsWith(".py") && file.name !== "__init__.py"
              )
              .map((file) => ({
                id: file.name.replace(".py", ""),
                name: this.formatAgentName(file.name),
                filename: file.name,
                path: file.path,
                url: file.download_url,
                size: this.formatFileSize(file.size),
                rawSize: file.size,
                sha: file.sha,
                icon: this.getAgentIcon(file.name),
                category: this.getAgentCategory(file.name),
                description: this.getAgentDescription(file.name),
                features: this.getAgentFeatures(file.name),
                type: "singular",
                stackName: null
              }));
          } catch (error) {
            console.error("Error loading singular agents:", error);
            return [];
          }
        }

        async loadAgentStacks() {
          try {
            // Fetch the list of stacks from GitHub API
            const apiUrl = `https://api.github.com/repos/${this.GITHUB_REPO}/contents/${this.STACKS_PATH}?ref=${this.BRANCH}`;
            const response = await fetch(apiUrl);

            if (response.status === 403) {
              console.warn("GitHub API rate limit reached for stacks. Using local development mode.");
              return this.getLocalStacks();
            }

            if (!response.ok) {
              throw new Error(`GitHub API returned ${response.status}`);
            }

            const stackDirs = await response.json();
            const allStackAgents = [];

            // Process each stack directory
            for (const stackDir of stackDirs) {
              if (stackDir.type === "dir") {
                const stackAgents = await this.loadStackAgents(stackDir);
                allStackAgents.push(...stackAgents);
              }
            }

            return allStackAgents;
          } catch (error) {
            console.error("Error loading agent stacks:", error);
            return [];
          }
        }

        async loadStackAgents(stackDir) {
          const stackAgents = [];
          const stackName = this.formatStackName(stackDir.name);
          
          try {
            // Check for agents subdirectory
            const agentsUrl = `https://api.github.com/repos/${this.GITHUB_REPO}/contents/${stackDir.path}/agents?ref=${this.BRANCH}`;
            const agentsResponse = await fetch(agentsUrl);
            
            if (agentsResponse.ok) {
              const agentFiles = await agentsResponse.json();
              
              // Process agent files in the agents subdirectory
              const pythonAgents = agentFiles
                .filter(file => file.name.endsWith(".py") && file.name !== "__init__.py")
                .map(file => ({
                  id: `${stackDir.name}_${file.name.replace(".py", "")}`,
                  name: this.formatAgentName(file.name),
                  filename: file.name,
                  path: file.path,
                  url: file.download_url,
                  size: this.formatFileSize(file.size),
                  rawSize: file.size,
                  sha: file.sha,
                  icon: "üì¶",
                  category: "stack",
                  description: `Part of ${stackName} stack`,
                  features: this.getAgentFeatures(file.name),
                  type: "stack",
                  stackName: stackName,
                  stackPath: stackDir.name
                }));
              
              stackAgents.push(...pythonAgents);
            }
            
            // Also check for Python files in the root of the stack directory
            const rootUrl = `https://api.github.com/repos/${this.GITHUB_REPO}/contents/${stackDir.path}?ref=${this.BRANCH}`;
            const rootResponse = await fetch(rootUrl);
            
            if (rootResponse.ok) {
              const rootFiles = await rootResponse.json();
              
              const rootPythonFiles = rootFiles
                .filter(file => file.type === "file" && file.name.endsWith(".py") && file.name !== "__init__.py")
                .map(file => ({
                  id: `${stackDir.name}_${file.name.replace(".py", "")}`,
                  name: this.formatAgentName(file.name),
                  filename: file.name,
                  path: file.path,
                  url: file.download_url,
                  size: this.formatFileSize(file.size),
                  rawSize: file.size,
                  sha: file.sha,
                  icon: "üì¶",
                  category: "stack",
                  description: `Part of ${stackName} stack`,
                  features: this.getAgentFeatures(file.name),
                  type: "stack",
                  stackName: stackName,
                  stackPath: stackDir.name
                }));
              
              stackAgents.push(...rootPythonFiles);
            }
          } catch (error) {
            console.error(`Error loading agents from stack ${stackDir.name}:`, error);
          }
          
          return stackAgents;
        }

        getLocalAgents() {
          // Return a basic set of agents for local development
          console.log("Using local agent list (GitHub API unavailable)");
          return [
            {
              id: "basic_agent",
              name: "Basic Agent",
              filename: "basic_agent.py",
              path: "agents/basic_agent.py",
              url: "https://raw.githubusercontent.com/kody-w/AI-Agent-Templates/main/agents/basic_agent.py",
              icon: "ü§ñ",
              category: "core",
              description: "Base agent class",
              features: ["Base functionality", "Core operations", "Extensible framework", "Simple API"],
              size: "5KB",
              type: "singular"
            },
            {
              id: "calendar_agent",
              name: "Calendar Agent",
              filename: "calendar_agent.py",
              path: "agents/calendar_agent.py",
              url: "https://raw.githubusercontent.com/kody-w/AI-Agent-Templates/main/agents/calendar_agent.py",
              icon: "üìÖ",
              category: "productivity",
              description: "Calendar scheduling agent",
              features: ["Meeting scheduling", "Conflict resolution", "Availability checking", "Calendar sync"],
              size: "8KB",
              type: "singular"
            },
            {
              id: "email_drafting_agent",
              name: "Email Drafting Agent",
              filename: "email_drafting_agent.py",
              path: "agents/email_drafting_agent.py",
              url: "https://raw.githubusercontent.com/kody-w/AI-Agent-Templates/main/agents/email_drafting_agent.py",
              icon: "‚úâÔ∏è",
              category: "communication",
              description: "Email composition agent",
              features: ["Email drafting", "Template support", "Auto-formatting", "Multi-language"],
              size: "10KB",
              type: "singular"
            }
          ];
        }

        getLocalStacks() {
          // Return basic stack agents for local development
          console.log("Using local stack list (GitHub API unavailable)");
          return [
            {
              id: "voice_to_crm_stack_dynamics_365_agent",
              name: "Dynamics 365 Agent",
              filename: "dynamics_365_agent.py",
              path: "agent_stacks/voice_to_crm_stack/agents/dynamics_365_agent.py",
              url: "https://raw.githubusercontent.com/kody-w/AI-Agent-Templates/main/agent_stacks/voice_to_crm_stack/agents/dynamics_365_agent.py",
              icon: "üì¶",
              category: "stack",
              description: "Part of Voice to CRM Stack",
              features: ["CRM integration", "Voice processing", "Data sync", "API automation"],
              size: "12KB",
              type: "stack",
              stackName: "Voice to CRM Stack",
              stackPath: "voice_to_crm_stack"
            }
          ];
        }

        formatStackName(dirname) {
          // Convert directory name to readable stack name
          return dirname
            .replace(/_stack$/, "")
            .split("_")
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(" ");
        }

        formatAgentName(filename) {
          // Convert filename to readable name
          const baseName = filename.replace(".py", "");
          return baseName
            .split("_")
            .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
            .join(" ")
            .replace(" Agent", " Agent");
        }

        getAgentIcon(filename) {
          const iconMap = {
            "voice_to_text_agent.py": "üé§",
            "text_to_speech_agent.py": "üîä",
            "email_agent.py": "‚úâÔ∏è",
            "email_drafting_agent.py": "‚úâÔ∏è",
            "calendar_scheduler_agent.py": "üìÖ",
            "task_manager_agent.py": "‚úÖ",
            "document_processor_agent.py": "üìÑ",
            "pdf_generator_agent.py": "üìë",
            "data_analysis_agent.py": "üìä",
            "report_generator_agent.py": "üìà",
            "visualization_agent.py": "üìâ",
            "translation_agent.py": "üåê",
            "sentiment_analysis_agent.py": "üòä",
            "customer_support_agent.py": "üéß",
            "notification_agent.py": "üîî",
            "crm_integration_agent.py": "üíº",
            "database_agent.py": "üóÑÔ∏è",
            "api_integration_agent.py": "üîó",
            "web_scraper_agent.py": "üï∑Ô∏è",
            "content_writer_agent.py": "‚úçÔ∏è",
            "seo_optimizer_agent.py": "üîç",
            "social_media_agent.py": "üì±",
            "workflow_automation_agent.py": "‚öôÔ∏è",
            "file_manager_agent.py": "üìÅ",
            "backup_agent.py": "üíæ",
            "security_monitor_agent.py": "üîí",
            "performance_monitor_agent.py": "‚ö°",
            "log_analyzer_agent.py": "üìã",
            "chat_bot_agent.py": "üí¨",
            "voice_assistant_agent.py": "üó£Ô∏è",
            "image_processor_agent.py": "üñºÔ∏è",
            "video_processor_agent.py": "üé•",
            "basic_agent.py": "ü§ñ",
            "context_memory_agent.py": "üß†",
            "manage_memory_agent.py": "üí≠",
            "dynamics_365_agent.py": "üíº",
            "extract_sharepoint_document_url_agent.py": "üìÅ",
            "image_generation_agent.py": "üé®",
            "powerpoint_agent.py": "üìä",
            "hacker_news_agent.py": "üì∞",
            "adaptive_card_agent.py": "üÉè",
          };
          return iconMap[filename] || "ü§ñ";
        }

        getAgentCategory(filename) {
          const categoryMap = {
            "voice_to_text_agent.py": "communication",
            "text_to_speech_agent.py": "communication",
            "email_agent.py": "communication",
            "email_drafting_agent.py": "communication",
            "calendar_scheduler_agent.py": "productivity",
            "task_manager_agent.py": "productivity",
            "document_processor_agent.py": "productivity",
            "pdf_generator_agent.py": "productivity",
            "data_analysis_agent.py": "analytics",
            "report_generator_agent.py": "analytics",
            "visualization_agent.py": "analytics",
            "translation_agent.py": "communication",
            "sentiment_analysis_agent.py": "analytics",
            "customer_support_agent.py": "communication",
            "notification_agent.py": "automation",
            "crm_integration_agent.py": "integration",
            "database_agent.py": "integration",
            "api_integration_agent.py": "integration",
            "web_scraper_agent.py": "automation",
            "content_writer_agent.py": "communication",
            "seo_optimizer_agent.py": "communication",
            "social_media_agent.py": "communication",
            "workflow_automation_agent.py": "automation",
            "file_manager_agent.py": "productivity",
            "backup_agent.py": "automation",
            "security_monitor_agent.py": "automation",
            "performance_monitor_agent.py": "analytics",
            "log_analyzer_agent.py": "analytics",
            "chat_bot_agent.py": "communication",
            "voice_assistant_agent.py": "communication",
            "image_processor_agent.py": "productivity",
            "video_processor_agent.py": "productivity",
            "basic_agent.py": "productivity",
            "context_memory_agent.py": "productivity",
            "manage_memory_agent.py": "productivity",
            "dynamics_365_agent.py": "integration",
            "extract_sharepoint_document_url_agent.py": "integration",
            "image_generation_agent.py": "productivity",
            "powerpoint_agent.py": "productivity",
            "hacker_news_agent.py": "analytics",
            "adaptive_card_agent.py": "productivity",
          };
          return categoryMap[filename] || "other";
        }

        getAgentDescription(filename) {
          const descriptionMap = {
            "voice_to_text_agent.py":
              "Converts voice input to text using advanced speech recognition",
            "text_to_speech_agent.py":
              "Generates natural-sounding speech from text input",
            "email_agent.py":
              "Manages email composition, sending, and inbox organization",
            "email_drafting_agent.py":
              "Intelligent email drafting with context awareness",
            "calendar_scheduler_agent.py":
              "Handles calendar events, scheduling, and meeting coordination",
            "task_manager_agent.py":
              "Organizes tasks, sets priorities, and tracks progress",
            "document_processor_agent.py":
              "Processes and analyzes various document formats",
            "pdf_generator_agent.py":
              "Creates professional PDF documents from various sources",
            "data_analysis_agent.py":
              "Performs advanced data analysis and insights generation",
            "report_generator_agent.py":
              "Creates comprehensive reports with data visualization",
            "visualization_agent.py":
              "Generates charts, graphs, and visual representations",
            "translation_agent.py":
              "Provides real-time translation between multiple languages",
            "sentiment_analysis_agent.py":
              "Analyzes text sentiment and emotional tone",
            "customer_support_agent.py":
              "Handles customer inquiries and support tickets",
            "notification_agent.py":
              "Manages and sends notifications across multiple channels",
            "crm_integration_agent.py":
              "Integrates with CRM systems for customer data management",
            "database_agent.py": "Manages database operations and queries",
            "api_integration_agent.py":
              "Connects with external APIs and services",
            "web_scraper_agent.py":
              "Extracts data from websites and web applications",
            "content_writer_agent.py":
              "Generates high-quality written content using AI",
            "seo_optimizer_agent.py":
              "Optimizes content for search engine rankings",
            "social_media_agent.py":
              "Manages social media posts and engagement",
            "workflow_automation_agent.py":
              "Automates complex business workflows",
            "file_manager_agent.py": "Organizes and manages file systems",
            "backup_agent.py": "Automates data backup and recovery processes",
            "security_monitor_agent.py":
              "Monitors system security and detects threats",
            "performance_monitor_agent.py": "Tracks system performance metrics",
            "log_analyzer_agent.py":
              "Analyzes system logs for insights and issues",
            "chat_bot_agent.py": "Provides conversational AI interface",
            "voice_assistant_agent.py": "Voice-activated personal assistant",
            "image_processor_agent.py": "Processes and analyzes images",
            "video_processor_agent.py": "Handles video processing and analysis",
            "basic_agent.py": "Foundation agent with core capabilities",
            "context_memory_agent.py":
              "Maintains context and conversation memory",
            "manage_memory_agent.py": "Manages and optimizes memory storage",
            "dynamics_365_agent.py": "Integrates with Microsoft Dynamics 365",
            "extract_sharepoint_document_url_agent.py":
              "Extracts documents from SharePoint URLs",
            "image_generation_agent.py": "Generates images using AI models",
            "powerpoint_agent.py":
              "Creates and manages PowerPoint presentations",
            "hacker_news_agent.py":
              "Monitors and aggregates Hacker News content",
            "adaptive_card_agent.py":
              "Creates adaptive cards for various platforms",
          };
          return (
            descriptionMap[filename] ||
            "Custom AI agent for enterprise automation"
          );
        }

        getAgentFeatures(filename) {
          const featuresMap = {
            "voice_to_text_agent.py": [
              "Real-time transcription",
              "Multiple language support",
              "Noise cancellation",
              "Speaker identification",
            ],
            "text_to_speech_agent.py": [
              "Natural voice synthesis",
              "Multiple voice options",
              "Emotion control",
              "Speed adjustment",
            ],
            "email_agent.py": [
              "Smart composition",
              "Auto-categorization",
              "Template management",
              "Schedule sending",
            ],
            "email_drafting_agent.py": [
              "Context-aware drafting",
              "Template suggestions",
              "Smart replies",
              "Tone adjustment",
            ],
            "calendar_scheduler_agent.py": [
              "Smart scheduling",
              "Conflict detection",
              "Time zone handling",
              "Meeting optimization",
            ],
            "task_manager_agent.py": [
              "Priority management",
              "Deadline tracking",
              "Team collaboration",
              "Progress monitoring",
            ],
            "document_processor_agent.py": [
              "Multi-format support",
              "Text extraction",
              "Metadata analysis",
              "Content indexing",
            ],
            "pdf_generator_agent.py": [
              "Template-based generation",
              "Dynamic content",
              "Formatting options",
              "Digital signatures",
            ],
            "data_analysis_agent.py": [
              "Statistical analysis",
              "Pattern recognition",
              "Predictive modeling",
              "Data cleaning",
            ],
            "visualization_agent.py": [
              "Interactive charts",
              "Real-time updates",
              "Custom themes",
              "Export options",
            ],
            "translation_agent.py": [
              "100+ languages",
              "Context awareness",
              "Industry terminology",
              "Real-time translation",
            ],
            "customer_support_agent.py": [
              "Ticket routing",
              "Response templates",
              "Escalation handling",
              "Customer history",
            ],
            "crm_integration_agent.py": [
              "Lead management",
              "Contact sync",
              "Pipeline tracking",
              "Activity logging",
            ],
            "basic_agent.py": [
              "Core functionality",
              "Basic automation",
              "Simple workflows",
              "Easy customization",
            ],
            "context_memory_agent.py": [
              "Conversation tracking",
              "Context retention",
              "Memory optimization",
              "State management",
            ],
            "manage_memory_agent.py": [
              "Memory allocation",
              "Storage optimization",
              "Cache management",
              "Data persistence",
            ],
            "dynamics_365_agent.py": [
              "CRM integration",
              "Sales automation",
              "Customer insights",
              "Pipeline management",
            ],
            "extract_sharepoint_document_url_agent.py": [
              "URL extraction",
              "Document retrieval",
              "Metadata parsing",
              "Batch processing",
            ],
            "image_generation_agent.py": [
              "AI image creation",
              "Style customization",
              "Batch generation",
              "Format options",
            ],
            "powerpoint_agent.py": [
              "Slide generation",
              "Template application",
              "Content formatting",
              "Export options",
            ],
            "hacker_news_agent.py": [
              "Real-time monitoring",
              "Content aggregation",
              "Trend analysis",
              "Custom filters",
            ],
            "adaptive_card_agent.py": [
              "Dynamic layouts",
              "Interactive elements",
              "Cross-platform support",
              "Template library",
            ],
          };
          return (
            featuresMap[filename] || [
              "Custom functionality",
              "API integration",
              "Automated workflows",
              "Enterprise ready",
            ]
          );
        }

        formatFileSize(bytes) {
          if (bytes === 0) return "0 Bytes";
          const k = 1024;
          const sizes = ["Bytes", "KB", "MB"];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return (
            Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i]
          );
        }

        showLoading(show) {
          const grid = document.getElementById("agentGrid");
          const emptyState = document.getElementById("agentEmptyState");

          if (show) {
            if (grid)
              grid.innerHTML =
                '<div style="text-align: center; padding: 3rem;"><div class="loading-spinner" style="margin: 0 auto;"></div><p style="margin-top: 1rem;">Loading agents from GitHub...</p></div>';
            if (emptyState) emptyState.style.display = "none";
          } else {
            if (this.agents.length === 0 && emptyState) {
              emptyState.style.display = "block";
              if (grid) grid.innerHTML = "";
            }
          }
        }

        showError(message) {
          const grid = document.getElementById("agentGrid");
          if (grid) {
            grid.innerHTML = `<div class="error-message" style="grid-column: 1/-1;">${message}</div>`;
          }
        }

        setView(view) {
          // Always use list view
          this.currentView = 'list';
          this.renderAgents();
        }

        renderAgents(agentsToRender = this.filteredAgents) {
          const grid = document.getElementById("agentGrid");
          const list = document.getElementById("agentList");
          const emptyState = document.getElementById("agentEmptyState");
          const agentCount = document.getElementById("agentCount");

          if (!grid && !list) return;

          // Update agent count
          if (agentCount) {
            agentCount.textContent = `${agentsToRender.length} agent${agentsToRender.length !== 1 ? 's' : ''}`;
          }

          if (agentsToRender.length === 0) {
            if (grid) grid.innerHTML = "";
            if (list) list.innerHTML = "";
            if (emptyState) emptyState.style.display = "block";
            return;
          }

          if (emptyState) emptyState.style.display = "none";

          // Render based on current view
          if (this.currentView === 'list') {
            // Render list view
            if (list) {
              list.innerHTML = agentsToRender
                .map(
                  (agent) => `
                    <div class="list-item">
                        <div class="list-item-icon">${agent.icon || 'ü§ñ'}</div>
                        <div class="list-item-content">
                            <div class="list-item-main">
                                <div class="list-item-name">${agent.name}</div>
                                <div class="list-item-description">${agent.description || 'No description available'}</div>
                            </div>
                            <div class="list-item-meta">
                                <div class="list-item-category">${agent.category || agent.type || 'general'}</div>
                                <div class="list-item-size">${agent.size || agent.size_formatted || 'N/A'}</div>
                            </div>
                            <div class="list-item-filename" style="color: #999; font-size: 0.85rem;">
                                ${agent.filename || 'Unknown'}
                            </div>
                            <div class="list-item-actions">
                                <button class="btn btn-secondary" onclick="agentStore.viewCode('${agent.id.replace(/'/g, "\\'")}')">
                                    üëÅÔ∏è View
                                </button>
                                ${
                                  this.cart.find((item) => item.id === agent.id)
                                    ? `<button class="btn btn-danger" onclick="agentStore.removeFromCart('${agent.id.replace(/'/g, "\\'")}')">
                                        ‚úï Remove
                                       </button>`
                                    : `<button class="btn btn-primary" onclick="agentStore.addToCart('${agent.id.replace(/'/g, "\\'")}')">
                                        ‚ûï Add
                                       </button>`
                                }
                            </div>
                        </div>
                    </div>
                  `
                )
                .join("");
            }
          } else {
            // Render gallery view (existing grid code)
            if (grid) {
              grid.innerHTML = agentsToRender
                .map(
                  (agent) => `
                        <div class="agent-card">
                            <div class="agent-header">
                                <div>
                                    <div class="agent-icon">${agent.icon || 'ü§ñ'}</div>
                                    <h3 class="agent-name">${agent.name}</h3>
                                </div>
                                <span class="agent-badge">${agent.size || agent.size_formatted || 'N/A'}</span>
                            </div>
                            <p class="agent-description">${agent.description || 'No description available'}</p>
                            <ul class="agent-features">
                                ${(agent.features || [])
                                  .map((f) => `<li>${f}</li>`)
                                  .join("")}
                            </ul>
                            <div style="display: flex; justify-content: space-between; padding: 1rem 0; border-top: 1px solid #e0e0e0;">
                                <span style="color: #666; font-size: 0.85rem;">${
                                  agent.filename || 'Unknown'
                                }</span>
                                <span style="color: #666; font-size: 0.85rem;">${
                                  agent.category || agent.type || 'general'
                                }</span>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-secondary" onclick="agentStore.viewCode('${agent.id.replace(/'/g, "\\'")}')">
                                    üëÅÔ∏è View Code
                                </button>
                                ${
                                  this.cart.find((item) => item.id === agent.id)
                                    ? `<button class="btn btn-danger" onclick="agentStore.removeFromCart('${agent.id.replace(/'/g, "\\'")}')">
                                        ‚úï Remove
                                       </button>`
                                    : `<button class="btn btn-primary" onclick="agentStore.addToCart('${agent.id.replace(/'/g, "\\'")}')">
                                        ‚ûï Add to Stack
                                       </button>`
                                }
                            </div>
                        </div>
                    `
                )
                .join("");
            }
          }
        }

        async viewCode(agentId) {
          const agent = this.agents.find((a) => a.id === agentId);
          if (!agent) return;

          this.currentAgent = agent;

          // Show loading in modal
          const modal = document.getElementById("codeViewerModal");
          const codeContent = document.getElementById("codeContent");
          const title = document.getElementById("codeViewerTitle");

          if (modal) modal.style.display = "flex";
          if (title) title.textContent = agent.name;
          if (codeContent)
            codeContent.innerHTML =
              '<span style="color: #999;">Loading code...</span>';

          try {
            // Check if we already have the code cached
            if (!this.agentCode[agent.id]) {
              // Fetch the code from GitHub
              const response = await fetch(agent.url);
              if (!response.ok) {
                throw new Error(`Failed to load code: ${response.status}`);
              }
              this.agentCode[agent.id] = await response.text();
            }

            // Display code with syntax highlighting
            const code = this.agentCode[agent.id];
            const highlightedCode = this.highlightPython(code);
            if (codeContent) codeContent.innerHTML = highlightedCode;
          } catch (error) {
            console.error("Error loading agent code:", error);
            if (codeContent) {
              codeContent.innerHTML =
                '<span style="color: #f44336;">Error loading code. Please try again.</span>';
            }
            showToast("Failed to load agent code", "error");
          }
        }

        highlightPython(code) {
          // Escape HTML first
          code = code
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");

          // Python syntax highlighting
          return (
            code
              // Decorators
              .replace(/(@\w+)/g, '<span class="decorator">$1</span>')
              // Comments
              .replace(/(#.*$)/gm, '<span class="comment">$1</span>')
              // Triple-quoted strings (docstrings)
              .replace(
                /("""[\s\S]*?"""|'''[\s\S]*?''')/g,
                '<span class="string">$1</span>'
              )
              // Single-line strings
              .replace(
                /(['"]).+?\1/g,
                (match) => `<span class="string">${match}</span>`
              )
              // Keywords
              .replace(
                /\b(class|def|import|from|return|if|else|elif|for|while|try|except|finally|with|as|pass|raise|assert|yield|lambda|and|or|not|in|is|None|True|False|self|super|break|continue|global|nonlocal|del|async|await)\b/g,
                '<span class="keyword">$1</span>'
              )
              // Numbers
              .replace(/\b(\d+\.?\d*)\b/g, '<span class="number">$1</span>')
              // Class names (capitalized words)
              .replace(
                /\b([A-Z][a-zA-Z0-9_]*)\b/g,
                '<span class="class">$1</span>'
              )
              // Function calls
              .replace(
                /\b([a-z_][a-zA-Z0-9_]*)\s*(?=\()/g,
                '<span class="function">$1</span>'
              )
              // self keyword
              .replace(/\bself\b/g, '<span class="self">self</span>')
          );
        }

        closeCodeViewer() {
          const modal = document.getElementById("codeViewerModal");
          if (modal) modal.style.display = "none";
          this.currentAgent = null;
        }

        copyCode() {
          if (!this.currentAgent || !this.agentCode[this.currentAgent.id])
            return;

          navigator.clipboard
            .writeText(this.agentCode[this.currentAgent.id])
            .then(() => {
              showToast("Code copied to clipboard!", "success");
            })
            .catch(() => {
              showToast("Failed to copy code", "error");
            });
        }

        downloadCurrentAgent() {
          if (!this.currentAgent || !this.agentCode[this.currentAgent.id])
            return;

          const blob = new Blob([this.agentCode[this.currentAgent.id]], {
            type: "text/plain",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = this.currentAgent.filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          showToast(`Downloaded ${this.currentAgent.filename}`, "success");
        }

        filterAgents(category) {
          this.currentFilter = category;

          document.querySelectorAll(".filter-btn").forEach((btn) => {
            btn.classList.remove("active");
            if (btn.dataset.category === category) {
              btn.classList.add("active");
            }
          });

          if (category === "all") {
            this.filteredAgents = [...this.agents];
          } else {
            this.filteredAgents = this.agents.filter(
              (agent) => agent.category === category
            );
          }

          this.updateStats();
          this.renderAgents();
        }

        searchAgents() {
          const searchTerm = document
            .getElementById("agentSearchInput")
            .value.toLowerCase();

          if (!searchTerm) {
            this.filterAgents(this.currentFilter);
            return;
          }

          this.filteredAgents = this.agents.filter(
            (agent) =>
              agent.name.toLowerCase().includes(searchTerm) ||
              agent.description.toLowerCase().includes(searchTerm) ||
              agent.filename.toLowerCase().includes(searchTerm) ||
              agent.features.some((f) => f.toLowerCase().includes(searchTerm))
          );

          if (this.currentFilter !== "all") {
            this.filteredAgents = this.filteredAgents.filter(
              (agent) => agent.category === this.currentFilter
            );
          }

          this.updateStats();
          this.renderAgents();
        }

        addToCart(agentId) {
          const agent = this.agents.find((a) => a.id === agentId);
          if (agent && !this.cart.find((item) => item.id === agentId)) {
            this.cart.push(agent);
            this.updateCartUI();
            this.renderAgents();
            templateManager.updateTemplateCartCount();
            templateManager.renderTemplates(templateManager.filteredTemplates);
            showToast(`Added ${agent.name} to your stack`, "success");
          }
        }

        removeFromCart(agentId) {
          const agent = this.cart.find((a) => a.id === agentId);
          this.cart = this.cart.filter((item) => item.id !== agentId);
          this.updateCartUI();
          this.renderAgents();
          templateManager.updateTemplateCartCount();
          templateManager.renderTemplates(templateManager.filteredTemplates);
          if (agent) {
            showToast(`Removed ${agent.name} from your stack`, "success");
          }
        }

        clearCart() {
          if (confirm("Clear all agents from your stack?")) {
            this.cart = [];
            this.updateCartUI();
            this.renderAgents();
            templateManager.updateTemplateCartCount();
            templateManager.renderTemplates(templateManager.filteredTemplates);
            showToast("Cart cleared", "success");
          }
        }

        updateCartUI() {
          const cartCount = document.getElementById("cartCount");
          const templateCartCount =
            document.getElementById("templateCartCount");
          const cartItems = document.getElementById("cartItems");
          const cartEmpty = document.getElementById("cartEmpty");
          const cartFooter = document.getElementById("cartFooter");
          const totalCartAgents = document.getElementById("totalCartAgents");
          const cartAgentsCount = document.getElementById("cartAgents");

          if (cartCount) cartCount.textContent = this.cart.length;
          if (templateCartCount)
            templateCartCount.textContent = this.cart.length;
          if (cartAgentsCount) cartAgentsCount.textContent = this.cart.length;

          if (this.cart.length === 0) {
            if (cartItems) cartItems.innerHTML = "";
            if (cartEmpty) cartEmpty.style.display = "block";
            if (cartFooter) cartFooter.style.display = "none";
          } else {
            if (cartEmpty) cartEmpty.style.display = "none";
            if (cartFooter) cartFooter.style.display = "block";

            if (cartItems) {
              cartItems.innerHTML = this.cart
                .map(
                  (agent) => `
                            <div class="cart-item">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">${agent.icon} ${agent.name}</div>
                                    <div style="color: #666; font-size: 0.85rem;">${agent.category} ‚Ä¢ ${agent.size}</div>
                                </div>
                                <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.85rem;"
                                        onclick="agentStore.removeFromCart('${agent.id.replace(/'/g, "\\'")}')">Remove</button>
                            </div>
                        `
                )
                .join("");
            }

            if (totalCartAgents) totalCartAgents.textContent = this.cart.length;
          }
        }

        updateStats() {
          const totalAgents = document.getElementById("totalAgents");
          const filteredAgents = document.getElementById("filteredAgents");

          if (totalAgents) totalAgents.textContent = this.agents.length;
          if (filteredAgents)
            filteredAgents.textContent = this.filteredAgents.length;
        }

        toggleCart() {
          const sidebar = document.getElementById("cartSidebar");
          if (sidebar) sidebar.classList.toggle("active");
        }

        async downloadAll() {
          if (this.cart.length === 0) {
            showToast("No agents in cart to download", "error");
            return;
          }

          // Check if we need to create a zip (multiple items or stacks with additional files)
          const hasMultipleItems = this.cart.length > 1;
          const hasStacksWithFiles = await this.checkForStackFiles();
          
          if (hasMultipleItems || hasStacksWithFiles) {
            await this.downloadAsZip();
          } else {
            // Single agent download
            await this.downloadSingleAgent();
          }
        }

        async checkForStackFiles() {
          // Check if any items in cart are part of stacks with additional files
          for (const agent of this.cart) {
            // Check if agent belongs to a stack
            const stack = await this.getStackForAgent(agent.id);
            if (stack && stack.hasAdditionalFiles) {
              return true;
            }
          }
          return false;
        }

        async getStackForAgent(agentId) {
          // Check if agent belongs to any stack
          for (const template of templateManager.agentTemplates) {
            if (template.agents && template.agents.includes(agentId)) {
              // Check for additional files
              const hasDemo = template.demo && template.demo.available;
              const hasFiles = template.files && template.files.length > 0;
              return {
                ...template,
                hasAdditionalFiles: hasDemo || hasFiles
              };
            }
          }
          return null;
        }

        async downloadSingleAgent() {
          const agent = this.cart[0];
          try {
            // Ensure we have the code
            if (!this.agentCode[agent.id]) {
              const response = await fetch(agent.url);
              if (response.ok) {
                this.agentCode[agent.id] = await response.text();
              }
            }

            if (this.agentCode[agent.id]) {
              // Download the file
              const blob = new Blob([this.agentCode[agent.id]], {
                type: "text/plain",
              });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = agent.filename;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
              showToast(`Downloaded ${agent.filename}`, "success");
            }
          } catch (error) {
            console.error(`Failed to download ${agent.filename}:`, error);
            showToast(`Failed to download ${agent.filename}`, "error");
          }
        }

        async downloadAsZip() {
          showToast("Creating package with all components...", "info");
          
          try {
            // Load JSZip library if not already loaded
            if (typeof JSZip === 'undefined') {
              await this.loadJSZip();
            }

            const zip = new JSZip();
            const processedStacks = new Set();
            
            // Group agents by stack
            const stackGroups = {};
            const standaloneAgents = [];
            
            for (const agent of this.cart) {
              const stack = await this.getStackForAgent(agent.id);
              if (stack && !processedStacks.has(stack.id)) {
                processedStacks.add(stack.id);
                if (!stackGroups[stack.id]) {
                  stackGroups[stack.id] = {
                    stack: stack,
                    agents: []
                  };
                }
                // Add all agents from this stack that are in cart
                for (const stackAgentId of stack.agents) {
                  const cartAgent = this.cart.find(a => a.id === stackAgentId);
                  if (cartAgent) {
                    stackGroups[stack.id].agents.push(cartAgent);
                  }
                }
              } else if (!stack) {
                standaloneAgents.push(agent);
              }
            }

            // Add stack components
            for (const stackId in stackGroups) {
              const { stack, agents } = stackGroups[stackId];
              const stackFolder = zip.folder(stack.name.replace(/[^a-z0-9]/gi, '_'));
              
              // Add agents
              const agentsFolder = stackFolder.folder('agents');
              for (const agent of agents) {
                if (!this.agentCode[agent.id]) {
                  const response = await fetch(agent.url);
                  if (response.ok) {
                    this.agentCode[agent.id] = await response.text();
                  }
                }
                if (this.agentCode[agent.id]) {
                  agentsFolder.file(agent.filename, this.agentCode[agent.id]);
                }
              }
              
              // Add demo files if available
              if (stack.demo && stack.demo.url) {
                const demoFolder = stackFolder.folder('demos');
                try {
                  const demoUrl = stack.demo.url;
                  const demoFilename = demoUrl.split('/').pop();
                  const demoResponse = await fetch(demoUrl);
                  if (demoResponse.ok) {
                    const demoContent = await demoResponse.text();
                    demoFolder.file(demoFilename, demoContent);
                  }
                } catch (err) {
                  console.error('Failed to fetch demo file:', err);
                }
              }
              
              // Add additional files from stack
              if (stack.files && stack.files.length > 0) {
                const filesFolder = stackFolder.folder('files');
                for (const file of stack.files) {
                  try {
                    // Construct file path
                    const filePath = `agent_stacks/${stack.id}/files/${file}`;
                    const fileResponse = await fetch(filePath);
                    if (fileResponse.ok) {
                      const fileBlob = await fileResponse.blob();
                      filesFolder.file(file, fileBlob);
                    }
                  } catch (err) {
                    console.error(`Failed to fetch file ${file}:`, err);
                  }
                }
              }
              
              // Add metadata
              stackFolder.file('metadata.json', JSON.stringify(stack, null, 2));
              
              // Add README with instructions
              const readme = this.generateStackReadme(stack, agents);
              stackFolder.file('README.md', readme);
            }
            
            // Add standalone agents
            if (standaloneAgents.length > 0) {
              const agentsFolder = zip.folder('individual_agents');
              for (const agent of standaloneAgents) {
                if (!this.agentCode[agent.id]) {
                  const response = await fetch(agent.url);
                  if (response.ok) {
                    this.agentCode[agent.id] = await response.text();
                  }
                }
                if (this.agentCode[agent.id]) {
                  agentsFolder.file(agent.filename, this.agentCode[agent.id]);
                }
              }
            }
            
            // Add main README
            const mainReadme = this.generateMainReadme(stackGroups, standaloneAgents);
            zip.file('README.md', mainReadme);
            
            // Generate and download zip
            const content = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AI_Agent_Package_${new Date().toISOString().split('T')[0]}.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Package downloaded successfully!', 'success');
          } catch (error) {
            console.error('Failed to create package:', error);
            showToast('Failed to create package. Downloading files individually...', 'error');
            // Fallback to individual downloads
            await this.downloadIndividually();
          }
        }

        async loadJSZip() {
          return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }

        generateStackReadme(stack, agents) {
          let readme = `# ${stack.name}\n\n`;
          readme += `${stack.description}\n\n`;
          readme += `## Stack Components\n\n`;
          
          for (const agent of agents) {
            readme += `- **${agent.name}** - ${agent.description || agent.category}\n`;
          }
          
          readme += `\n## Setup Instructions\n\n`;
          readme += `1. Deploy the base infrastructure from [Copilot-Agent-365](https://github.com/kody-w/Copilot-Agent-365)\n`;
          readme += `2. Copy the agent files from the \`agents/\` folder to your deployment\n`;
          
          if (stack.demo && stack.demo.available) {
            readme += `3. Test the stack using the demo in the \`demos/\` folder\n`;
          }
          
          if (stack.technicalRequirements && stack.technicalRequirements.apiKeys) {
            readme += `\n## Required API Keys\n\n`;
            for (const key of stack.technicalRequirements.apiKeys) {
              readme += `- \`${key}\`\n`;
            }
          }
          
          return readme;
        }

        generateMainReadme(stackGroups, standaloneAgents) {
          let readme = `# AI Agent Package\n\n`;
          readme += `Generated on ${new Date().toLocaleDateString()}\n\n`;
          
          if (Object.keys(stackGroups).length > 0) {
            readme += `## Agent Stacks\n\n`;
            for (const stackId in stackGroups) {
              const { stack, agents } = stackGroups[stackId];
              readme += `### ${stack.name}\n`;
              readme += `${stack.description}\n\n`;
              readme += `**Agents:** ${agents.length}\n`;
              readme += `**Complexity:** ${stack.complexity}\n\n`;
            }
          }
          
          if (standaloneAgents.length > 0) {
            readme += `## Individual Agents\n\n`;
            for (const agent of standaloneAgents) {
              readme += `- **${agent.name}** - ${agent.category}\n`;
            }
          }
          
          readme += `\n## Installation\n\n`;
          readme += `1. Deploy base infrastructure: https://github.com/kody-w/Copilot-Agent-365\n`;
          readme += `2. Copy agent files to your deployment\n`;
          readme += `3. Configure required API keys\n`;
          readme += `4. Test using provided demos\n`;
          
          return readme;
        }

        async downloadIndividually() {
          for (const agent of this.cart) {
            try {
              // Ensure we have the code
              if (!this.agentCode[agent.id]) {
                const response = await fetch(agent.url);
                if (response.ok) {
                  this.agentCode[agent.id] = await response.text();
                }
              }

              if (this.agentCode[agent.id]) {
                // Download the file
                const blob = new Blob([this.agentCode[agent.id]], {
                  type: "text/plain",
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = agent.filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Small delay between downloads
                await new Promise((resolve) => setTimeout(resolve, 200));
              }
            } catch (error) {
              console.error(`Failed to download ${agent.filename}:`, error);
            }
          }

          showToast(`Downloaded ${this.cart.length} agent(s)`, "success");
        }

        refreshAgents() {
          this.agents = [];
          this.filteredAgents = [];
          this.agentCode = {};
          this.loadAgents();
        }
      }

      // Show toast notification
      function showToast(message, type = "info") {
        const toast = document.getElementById("toast");
        if (toast) {
          toast.textContent = message;
          toast.className = `toast show ${type}`;

          setTimeout(() => {
            toast.classList.remove("show");
          }, 3000);
        }
      }

      // Initialize all modules - AgentStore MUST be created first
      const agentStore = new AgentStore();
      window.agentStore = agentStore;  // Make it globally accessible
      
      const templateManager = new TemplateManager();
      window.templateManager = templateManager;  // Make it globally accessible
      
      const discoveryTool = new DiscoveryTool();
      
      // Load the trading card generator script
      const tradingCardScript = document.createElement('script');
      tradingCardScript.src = 'generate_trading_card.js';
      document.head.appendChild(tradingCardScript);

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", () => {
        // Check if user has already deployed (e.g., coming from URL param or localStorage)
        const urlParams = new URLSearchParams(window.location.search);
        const hasDeployed = urlParams.get('deployed') === 'true' || localStorage.getItem('azureDeployed') === 'true';
        
        if (hasDeployed) {
          // User has deployed, go straight to templates
          localStorage.setItem('azureDeployed', 'true');
          switchApp('templates');
          // Update nav tabs
          document.querySelectorAll(".nav-tab").forEach((tab) => {
            tab.classList.remove("active");
            if (tab.textContent.includes('Template Library')) {
              tab.classList.add("active");
            }
          });
        }
        
        // Load templates on start (ensure agents load first)
        (async () => {
          await agentStore.loadAgents();
          await templateManager.loadTemplates();
        })();
        
        // Handle permalinks - check if there's a hash in the URL
        const checkHashAndOpenModal = async () => {
          const hash = window.location.hash;
          if (hash && hash.startsWith('#stack-')) {
            const stackId = hash.substring(7); // Remove '#stack-' prefix
            
            // Wait for templates to load if they haven't yet
            let attempts = 0;
            const waitForTemplates = async () => {
              if (templateManager.agentTemplates.length > 0) {
                // Templates are loaded, try to open the modal
                await templateManager.viewTemplateDetails(stackId, true);
              } else if (attempts < 20) {
                // Wait and try again (max 10 seconds)
                attempts++;
                setTimeout(waitForTemplates, 500);
              }
            };
            
            setTimeout(waitForTemplates, 1000); // Give initial load time
          }
        };
        
        // Check on initial load
        checkHashAndOpenModal();
        
        // Listen for hash changes (for navigation within the page)
        window.addEventListener('hashchange', checkHashAndOpenModal);

        // Pre-load agents in background
        setTimeout(() => {
          if (agentStore.agents.length === 0) {
            agentStore.loadAgents();
          }
        }, 1000);
      });

      // Close code viewer on escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          agentStore.closeCodeViewer();
          const sidebar = document.getElementById("cartSidebar");
          if (sidebar && sidebar.classList.contains("active")) {
            sidebar.classList.remove("active");
          }
        }
      });

      // Close modals when clicking outside
      document
        .getElementById("codeViewerModal")
        ?.addEventListener("click", (e) => {
          if (e.target === e.currentTarget) {
            agentStore.closeCodeViewer();
          }
        });
    </script>
    
    <!-- Load Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
      // Initialize Mermaid.js for architecture diagrams
      document.addEventListener('DOMContentLoaded', function() {
        if (typeof mermaid !== 'undefined') {
          mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
              primaryColor: '#0078d4',
              primaryTextColor: '#fff',
              primaryBorderColor: '#005a9e',
              lineColor: '#5e5e5e',
              secondaryColor: '#40e0d0',
              tertiaryColor: '#f9fafb',
              mainBkg: '#eff6ff',
              secondBkg: '#f3e8ff',
              tertiaryTextColor: '#333'
            },
            flowchart: {
              useMaxWidth: true,
              htmlLabels: true,
              curve: 'basis'
            }
          });
          // Force re-render for any diagrams that might be hidden
          setTimeout(() => {
            mermaid.init(undefined, document.querySelectorAll('.mermaid'));
          }, 500);
        }
      });
    </script>
  </body>
</html>
